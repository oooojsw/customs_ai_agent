<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·å…³æ™ºèƒ½æŠ¥å…³å†³ç­–ç³»ç»Ÿ v2.1</title>
    <!-- 1. æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 2. Markdown æ¸²æŸ“å¼•æ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒä¸»é¢˜ --- */
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- éœ“è™¹ç‰¹æ•ˆ --- */
        .neon-border { box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); transition: all 0.3s ease; border: 1px solid rgba(56, 189, 248, 0.2); }
        .neon-border:focus-within { box-shadow: 0 0 20px rgba(56, 189, 248, 0.6); border-color: #38bdf8; }

        /* --- å®¡å•æ¨¡å—ï¼šå‘¼å¸åŠ¨ç”» --- */
        @keyframes breathe {
            0% { opacity: 0.4; box-shadow: 0 0 5px #3b82f6; }
            50% { opacity: 1; box-shadow: 0 0 20px #3b82f6; border-color: #60a5fa; }
            100% { opacity: 0.4; box-shadow: 0 0 5px #3b82f6; }
        }
        .status-thinking { animation: breathe 1.5s infinite ease-in-out; border: 1px solid #3b82f6; background-color: rgba(59, 130, 246, 0.1); }

        /* --- å®¡å•æ¨¡å—ï¼šç»“æœå¡ç‰‡ --- */
        .step-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-left: 4px solid transparent; }
        .step-card.pending { border-left-color: #475569; opacity: 0.5; }
        .step-card.pass { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.1); opacity: 1; }
        .step-card.risk { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); opacity: 1; }

        /* --- æ»šåŠ¨æ¡ç¾åŒ– --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- ä¾§è¾¹æ äº¤äº’ --- */
        .nav-active { background-color: #1e293b; color: #38bdf8; border-left: 3px solid #38bdf8; }

        /* --- å¯¹è¯æ¨¡å—ï¼šèŠå¤©æ°”æ³¡ & æµå¼çŠ¶æ€ --- */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chat-thinking {
            padding: 8px 15px;
            color: #94a3b8;
            font-size: 0.9rem;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        .chat-ai { background-color: #334155; border-bottom-left-radius: 4px; }
        .chat-user { background-color: #0ea5e9; border-bottom-right-radius: 4px; }

        /* --- æŠ¥å‘Šæ¨¡å—ä¸“ç”¨æ ·å¼ --- */
        .report-container { display: flex; height: 100%; gap: 20px; padding: 20px; }
        .report-source-panel {
            flex: 1; display: flex; flex-direction: column;
            background: rgba(30, 41, 59, 0.5); border-radius: 12px; border: 1px solid #334155; padding: 15px;
        }
        .report-preview-panel {
            flex: 2; display: flex; flex-direction: column;
            background: #0f172a; border-radius: 12px; border: 1px solid #334155;
            position: relative; overflow: hidden;
        }
        .process-timeline {
            display: flex; padding: 15px; background: #1e293b; border-bottom: 1px solid #334155;
            overflow-x: auto; gap: 10px;
        }
        .timeline-step {
            flex: 0 0 auto; display: flex; align-items: center; gap: 8px;
            padding: 6px 12px; background: #334155; border-radius: 20px;
            font-size: 0.85rem; color: #94a3b8; transition: all 0.3s ease; opacity: 0.6;
        }
        .timeline-step.active {
            background: #0ea5e9; color: white; opacity: 1;
            box-shadow: 0 0 10px rgba(14, 165, 233, 0.4);
            animation: pulse-blue 1.5s infinite;
        }
        .timeline-step.done { background: #10b981; color: white; opacity: 1; }
        @keyframes pulse-blue {
            0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); }
            100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); }
        }
        
        /* Markdown æŠ¥å‘Šæ­£æ–‡æ ·å¼ */
        .markdown-body {
            flex: 1; overflow-y: auto; padding: 30px;
            font-family: 'Segoe UI', sans-serif; color: #e2e8f0; line-height: 1.8;
        }
        .markdown-body h1, .markdown-body h2, .markdown-body h3 {
            color: #38bdf8; margin-top: 1.5em; margin-bottom: 0.5em;
            border-bottom: 1px solid #334155; padding-bottom: 0.3em; font-weight: bold;
        }
        .markdown-body h2 { font-size: 1.5em; }
        .markdown-body h3 { font-size: 1.2em; }
        .markdown-body p { margin-bottom: 1em; }
        .markdown-body ul { list-style: disc; padding-left: 20px; margin-bottom: 1em; }
        .markdown-body ol { list-style: decimal; padding-left: 20px; margin-bottom: 1em; }
        .markdown-body blockquote {
            border-left: 4px solid #f59e0b; background: rgba(245, 158, 11, 0.1);
            padding: 10px; margin: 10px 0; border-radius: 4px; color: #fbbf24;
        }
        .markdown-body strong { color: #facc15; }
    </style>
</head>

<body class="h-screen flex overflow-hidden">

    <!-- ================= ä¾§è¾¹å¯¼èˆªæ  ================= -->
    <nav class="w-16 bg-slate-900 border-r border-slate-700 flex flex-col items-center py-4 z-20 gap-2 shrink-0">
        <div class="mb-4 text-cyan-400">
            <i class="fa-solid fa-shield-halved text-2xl"></i>
        </div>
        
        <button onclick="switchModule('audit')" id="nav-audit" class="nav-active w-full h-16 flex flex-col items-center justify-center text-slate-400 hover:text-cyan-400 transition-colors">
            <i class="fa-solid fa-file-contract text-xl mb-1"></i>
            <span class="text-[10px]">å®¡å•</span>
        </button>

        <button onclick="switchModule('chat')" id="nav-chat" class="w-full h-16 flex flex-col items-center justify-center text-slate-400 hover:text-cyan-400 transition-colors">
            <i class="fa-solid fa-comments text-xl mb-1"></i>
            <span class="text-[10px]">å’¨è¯¢</span>
        </button>

        <button onclick="switchModule('report')" id="nav-report" class="w-full h-16 flex flex-col items-center justify-center text-slate-400 hover:text-cyan-400 transition-colors">
            <i class="fa-solid fa-file-signature text-xl mb-1"></i>
            <span class="text-[10px]">åˆè§„å»ºè®®</span>
        </button>
    </nav>

    <!-- ================= ä¸»ä½“å†…å®¹åŒº ================= -->
    <div class="flex-1 flex flex-col min-w-0">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="h-16 bg-slate-900 border-b border-slate-700 flex items-center px-6 justify-between shadow-lg shrink-0">
            <div>
                <h1 class="text-xl font-bold tracking-wider text-white">æ™ºèƒ½æŠ¥å…³ç³»ç»Ÿ</h1>
                <p class="text-xs text-slate-400">æ™ºæ…§å£å²¸è‡ªåŠ¨åŒ–æŠ¥å…³è¾…åŠ©å†³ç­–ç³»ç»Ÿ v2.1 (LangChain Edition)</p>
            </div>
            <div class="flex gap-4 text-sm text-slate-300">
                <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500"></div> ç³»ç»Ÿåœ¨çº¿</span>
                <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> deepseek </span>
            </div>
        </header>

        <!-- ================= æ¨¡å— A: æ™ºèƒ½å®¡å• (Core Engine) ================= -->
        <div id="module-audit" class="flex-1 flex overflow-hidden module-content">
            <!-- å·¦æ  -->
            <div class="w-1/3 bg-slate-800/50 border-r border-slate-700 p-6 flex flex-col min-w-[300px]">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-cyan-400"><i class="fa-solid fa-file-import mr-2"></i>æŠ¥å…³å•æ®å½•å…¥</h2>
                    </div>
                    <!-- æ•°æ®æŸ¥è¯¢æ  -->
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-search text-slate-500"></i>
                            </div>
                            <input type="text" id="searchInput" 
                                class="w-full bg-slate-900 border border-slate-600 text-slate-300 text-sm rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 block pl-10 p-2 placeholder-slate-600" 
                                placeholder="è¾“å…¥å•å· (ä¾‹: 530120250001)"
                                onkeydown="if(event.keyCode==13) searchDeclaration()">
                        </div>
                        <button onclick="searchDeclaration()" id="searchBtn" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs border border-slate-600 transition">æŸ¥è¯¢</button>
                    </div>
                </div>

                <!-- å¿«æ·æ ·æœ¬æŒ‰é’® -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="loadSample('sample10')" class="text-xs py-2 bg-green-600/20 border border-green-600 hover:bg-green-600/40 text-green-300 rounded transition font-bold">âœ… 10.å®Œç¾æœºæ¢°</button>
                    <button onclick="loadSample('sample7')" class="text-xs py-2 bg-green-600/20 border border-green-600 hover:bg-green-600/40 text-green-300 rounded transition font-bold">âœ… 7.å…è´¹æ ·å“</button>
                    <button onclick="loadSample('sample1')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 1.å½’ç±»æ¬ºè¯ˆ</button>
                    <button onclick="loadSample('sample2')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 2.æ´‹åƒåœ¾</button>
                    <button onclick="loadSample('sample3')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 3.é‡é‡è¯¯å·®</button>
                    <button onclick="loadSample('sample4')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 4.è¦ç´ æ¨¡ç³Š</button>
                    <button onclick="loadSample('sample5')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 5.ä»·æ ¼æ´—é’±</button>
                    <button onclick="loadSample('sample6')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 6.æ¿’å±çº¢æœ¨</button>
                    <button onclick="loadSample('sample8')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 8.ä¸¤ç”¨ç‰©é¡¹</button>
                    <button onclick="loadSample('sample9')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 9.å¸åˆ¶é”™è¯¯</button>
                </div>

                <!-- å¤§æ–‡æœ¬æ¡† -->
                <div class="flex-1 relative neon-border rounded overflow-hidden bg-slate-900">
                    <textarea id="rawDataInput" class="w-full h-full bg-transparent text-slate-300 p-4 font-mono text-sm resize-none focus:outline-none" placeholder="åœ¨æ­¤ç²˜è´´ OCR è¯†åˆ«ç»“æœã€JSON æ•°æ®æˆ–æŠ¥å…³å•æ–‡æœ¬..."></textarea>
                </div>

                <button id="startBtn" onclick="startAnalysis()" class="mt-4 w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded shadow-lg transform transition hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-rocket"></i> å¼€å§‹æ™ºèƒ½ç ”åˆ¤
                </button>
            </div>

            <!-- å³æ ï¼šæ¨ç†æµ -->
            <div class="flex-1 bg-slate-900 p-6 overflow-y-auto relative">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-lg font-semibold text-cyan-400 mb-6 flex items-center">
                        <i class="fa-solid fa-microchip mr-2"></i>AI å†³ç­–æ¨ç†æµ
                        <span id="statusTag" class="ml-4 text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-400 hidden">åˆ†æä¸­...</span>
                    </h2>
                    
                    <!-- æ­¥éª¤å¡ç‰‡å®¹å™¨ -->
                    <div id="stepsContainer" class="space-y-4 min-h-[500px] flex flex-col justify-center items-center transition-all duration-500">
                        <!-- é»˜è®¤å¾…æœºçŠ¶æ€ (ç›¾ç‰ŒåŠ¨ç”») -->
                        <div class="text-center group cursor-default select-none">
                            <div class="relative inline-block">
                                <div class="absolute -inset-4 bg-cyan-500/20 rounded-full blur-xl group-hover:bg-cyan-500/30 transition-all duration-500"></div>
                                <i class="fa-solid fa-shield-halved text-8xl text-slate-700/50 relative z-10 group-hover:text-cyan-500/80 transition-all duration-500 animate-pulse"></i>
                                <i class="fa-solid fa-lock text-3xl text-slate-800 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20"></i>
                            </div>
                            <h3 class="mt-8 text-2xl font-bold text-slate-600 tracking-widest group-hover:text-cyan-400 transition-colors">SYSTEM READY</h3>
                            <p class="mt-2 text-sm text-slate-500 group-hover:text-slate-400 transition-colors">ç­‰å¾…æ•°æ®å½•å…¥ Â· å®‰å…¨å¼•æ“å¾…å‘½</p>
                        </div>
                    </div>

                    <!-- æœ€ç»ˆç»“æœ -->
                    <div id="finalResult" class="mt-8 hidden"></div>
                </div>
            </div>
        </div>

        <!-- ================= æ¨¡å— B: æ™ºèƒ½å’¨è¯¢ (LangChain Agent) ================= -->
        <div id="module-chat" class="flex-1 hidden flex flex-col h-full bg-slate-900 module-content overflow-hidden relative">
            
            <!-- èŠå¤©è®°å½•åŒºåŸŸ -->
            <div id="chatHistory" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 scroll-smooth pb-24">
                <!-- æ¬¢è¿è¯­ -->
                <div class="flex justify-start">
                    <div class="chat-bubble chat-ai shadow-lg">
                        <div class="flex items-center gap-2 mb-2 text-cyan-400 font-bold">
                            <i class="fa-solid fa-robot"></i> æ³•è§„å’¨è¯¢åŠ©æ‰‹
                        </div>
                        ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢å†…éƒ¨æ³•è§„æˆ–å›ç­”ä¸šåŠ¡é—®é¢˜ã€‚<br>
                        <span class="text-xs text-slate-400 mt-2 block">åŸºäº RAG çŸ¥è¯†åº“ + DeepSeek-V3</span>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ (å›ºå®šåœ¨åº•éƒ¨) -->
            <div class="absolute bottom-0 w-full bg-slate-800/90 backdrop-blur border-t border-slate-700 p-4 z-10">
                <div class="max-w-4xl mx-auto flex gap-3 items-end">
                    <div class="flex-1 bg-slate-900 border border-slate-600 rounded-xl p-2 focus-within:border-cyan-500 focus-within:ring-1 focus-within:ring-cyan-500 transition-all">
                        <textarea id="chatInput" rows="1"
                            class="w-full bg-transparent text-slate-300 px-2 py-1 text-sm focus:outline-none resize-none max-h-32"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜... (Shift+Enter æ¢è¡Œ)"
                            onkeydown="if(event.keyCode==13 && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                    </div>
                    
                    <button onclick="sendMessage()" id="sendBtn" class="w-10 h-10 bg-cyan-600 hover:bg-cyan-500 text-white rounded-full flex items-center justify-center transition shadow-lg shrink-0 mb-1">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= æ¨¡å— C: æ™ºèƒ½å»ºè®®ä¹¦ (Reporter) - æ–°ç‰ˆ ================= -->
        <div id="module-report" class="flex-1 hidden flex flex-col h-full bg-slate-900 module-content">
            
            <!-- é¡¶éƒ¨æ“ä½œæ  -->
            <div class="h-14 bg-slate-800 border-b border-slate-700 flex items-center px-6 justify-between shrink-0">
                <h2 class="text-green-400 font-bold flex items-center gap-2">
                    <i class="fa-solid fa-file-contract"></i> æ™ºèƒ½åˆè§„å®¡è®¡
                </h2>
                <div class="flex gap-3">
                    <button onclick="importFromAudit()" class="text-xs px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-cyan-400 border border-slate-600 transition">
                        <i class="fa-solid fa-clone"></i> å¼•ç”¨â€œå®¡å•â€æ•°æ®
                    </button>
                    <button onclick="startReportGeneration()" id="btn-gen-report" class="text-xs px-4 py-1.5 bg-green-600 hover:bg-green-500 rounded text-white font-bold shadow-lg transition flex items-center gap-2">
                        <i class="fa-solid fa-play"></i> ç”ŸæˆæŠ¥å‘Š
                    </button>
                </div>
            </div>

            <!-- ä¸»ä½“å†…å®¹ï¼šå·¦å³åˆ†æ  -->
            <div class="report-container flex-1 overflow-hidden">
                
                <!-- å·¦ä¾§ï¼šæ•°æ®æº (Source) -->
                <div class="report-source-panel flex flex-col w-1/3 min-w-[300px]">
                    <div class="text-xs text-slate-400 mb-2 flex justify-between">
                        <span>åŸå§‹æŠ¥å…³æ•°æ® / ä¸Šä¸‹æ–‡</span>
                        <span id="source-status">ç­‰å¾…è¾“å…¥...</span>
                    </div>
                    <textarea id="reportContextInput" 
                        class="w-full h-full bg-slate-900/50 border border-slate-600 rounded p-3 text-sm text-slate-300 font-mono resize-none focus:outline-none focus:border-green-500 transition"
                        placeholder="åœ¨æ­¤ç²˜è´´æŠ¥å…³å•æ•°æ®ã€å‘ç¥¨ä¿¡æ¯æˆ–é£é™©å¤‡æ³¨..."></textarea>
                </div>

                <!-- å³ä¾§ï¼šç”Ÿæˆé¢„è§ˆ (Preview) -->
                <div class="report-preview-panel flex-1 flex flex-col relative">
                    
                    <!-- é¡¶éƒ¨æµç¨‹æ¡ -->
                    <div id="reportTimeline" class="process-timeline h-14 shrink-0">
                        <div class="text-slate-500 text-sm flex items-center italic">
                            <i class="fa-solid fa-arrow-left mr-2"></i> è¯·å…ˆå½•å…¥æ•°æ®å¹¶ç‚¹å‡»ç”Ÿæˆ
                        </div>
                    </div>

                    <!-- æŠ¥å‘Šæ­£æ–‡ -->
                    <div id="reportContent" class="markdown-body flex-1 relative"> <!-- æ³¨æ„åŠ  relative -->
                        <!-- AI ç”Ÿæˆçš„å†…å®¹ä¼šæµå¼è¿½åŠ åˆ°è¿™é‡Œ -->
                    </div>

                    <!-- ã€æ–°å¢ã€‘å›åˆ°åº•éƒ¨æŒ‰é’® (é»˜è®¤éšè—) -->
                    <button id="scroll-to-bottom-btn" onclick="scrollToBottom()" 
                        class="absolute bottom-6 right-6 w-10 h-10 bg-slate-700/80 hover:bg-cyan-600 text-white rounded-full shadow-lg flex items-center justify-center transition-all opacity-0 pointer-events-none z-20">
                        <i class="fa-solid fa-arrow-down"></i>
                    </button>

                    <!-- é®ç½©å±‚ (åˆå§‹çŠ¶æ€) -->
                    <div id="report-placeholder" class="absolute inset-0 flex flex-col items-center justify-center bg-slate-900/80 z-10">
                        <i class="fa-solid fa-wand-magic-sparkles text-6xl text-slate-700 mb-4"></i>
                        <p class="text-slate-500">AI å®¡è®¡å¼•æ“å°±ç»ª</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ================= æ ¸å¿ƒè„šæœ¬é€»è¾‘ ================= -->
    <script>
        // API é…ç½®
        const API_URL = 'http://localhost:8000/api/v1/analyze';
        const QUERY_URL = 'http://localhost:8000/api/v1/query/declaration/'; 
        const CHAT_URL = 'http://localhost:8000/api/v1/chat';
        // ã€æ–°å¢ã€‘æŠ¥å‘Šç”Ÿæˆæ¥å£
        const REPORT_API_URL = 'http://localhost:8000/api/v1/generate_report';

        // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ ID ä½œä¸ºä¼šè¯ Session ID (ç”¨äº Agent è®°å¿†)
        const SESSION_ID = 'session-' + Date.now();
        
        // --- æ¨¡å—åˆ‡æ¢é€»è¾‘ ---
        function switchModule(moduleName) {
            document.querySelectorAll('.module-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`module-${moduleName}`).classList.remove('hidden');
            
            // ä¾§è¾¹æ é«˜äº®
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('nav-active'));
            document.getElementById(`nav-${moduleName}`).classList.add('nav-active');
            
            // ç¡®ä¿èŠå¤©è®°å½•åŒºåœ¨åˆ‡æ¢å›æ¥æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
            if (moduleName === 'chat') {
                const historyEl = document.getElementById('chatHistory');
                historyEl.scrollTop = historyEl.scrollHeight;
            }
        }

        // --- [æ¨¡å—A] æ ¸å¿ƒå®¡å•é€»è¾‘ (ä¿æŒä¸å˜) ---
        const SAMPLES = {
            normal: `æŠ¥å…³å•å·ï¼š530120250001\nå¢ƒå†…æ”¶è´§äººï¼šæ·±åœ³æ·±å—ç”µå­ç§‘æŠ€æœ‰é™å…¬å¸\nè´§ç‰©åç§°ï¼š32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨(IC)\nHSç¼–ç ï¼š85423100\næ•°é‡ï¼š5000ä¸ª\nå•ä»·ï¼š15.00 USD\næ€»ä»·ï¼š75000.00 USD\nå¸åˆ¶ï¼šç¾å…ƒ\næ¯›é‡ï¼š55.0 KG\nå‡€é‡ï¼š50.0 KG\nåŸäº§å›½ï¼šé©¬æ¥è¥¿äºš\nå“ç‰Œï¼šTI (å¾·å·ä»ªå™¨)\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼š32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼›\n  2.å“ç‰Œï¼šTIï¼›\n  3.å‹å·ï¼šTMS320F28335PGFAï¼›\n  4.åŠŸèƒ½ï¼šç”¨äºå·¥ä¸šç”µæœºæ§åˆ¶ï¼›\n  5.å°è£…å½¢å¼ï¼šLQFPã€‚\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\n1. å•†ä¸šå‘ç¥¨(Invoice No. INV-2025001)ï¼š\n   - é‡‘é¢åˆè®¡ï¼š75000.00 USD\n   - è´¸æ˜“æ¡æ¬¾ï¼šCIF Shenzhen\n2. è£…ç®±å•(Packing List)ï¼š\n   - è´§ç‰©æ•°é‡ï¼š5000 PCS\n   - æ¯›é‡ï¼š55.0 KG\n   - å‡€é‡ï¼š50.0 KG`,
            risk: `æŠ¥å…³å•å·ï¼š530120250099\nå¢ƒå†…æ”¶è´§äººï¼šXXå•†è´¸è¡Œ\nè´§ç‰©åç§°ï¼šæ—§ç¬”è®°æœ¬ç”µè„‘ï¼ˆæ‹†è§£ç”¨ï¼‰\nHSç¼–ç ï¼š84713010\næ•°é‡ï¼š200å°\nå•ä»·ï¼š5.00 USD\næ€»ä»·ï¼š1000.00 USD\nåŸäº§å›½ï¼šæœªçŸ¥\nå¤‡æ³¨ï¼šå±å¹•ç ´æŸï¼Œé”®ç›˜ç¼ºå¤±\néšé™„å•è¯ï¼šå‘ç¥¨é‡‘é¢ 1000 USD`,
            sample10: `æŠ¥å…³å•å·ï¼šTEST-010\nè´§ç‰©åç§°ï¼šå…¨è‡ªåŠ¨è´´ç‰‡æœº\nHSç¼–ç ï¼š84798962\næ•°é‡ï¼š1 å°\nå•ä»·ï¼š150,000.00 USD\næ€»ä»·ï¼š150,000.00 USD\næ¯›é‡ï¼š1200.0 KG\nå‡€é‡ï¼š1150.0 KG\nå“ç‰Œï¼šPanasonic\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šå…¨è‡ªåŠ¨è´´ç‰‡æœºï¼›\n  2.å“ç‰Œï¼šPanasonicï¼›\n  3.å‹å·ï¼šNPM-D3Aï¼›\n  4.åŠŸèƒ½ï¼šç”¨äºPCBç”µè·¯æ¿å…ƒä»¶è´´è£…ï¼›\n  5.åŸç†ï¼šé€šè¿‡å¸å˜´å¸å–å…ƒä»¶æ”¾ç½®äºPCBæ¿ã€‚\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\nå‘ç¥¨ INV-998877:\n   - é‡‘é¢ï¼š150,000.00 USD\nè£…ç®±å• PL-998877:\n   - æ¯›é‡ï¼š1200.0 KG\n   - å‡€é‡ï¼š1150.0 KG`,
            sample1: `æŠ¥å…³å•å·ï¼šTEST-001\nè´§ç‰©åç§°ï¼šDJI Mavic 3 Pro èˆªæ‹é£è¡Œå™¨\nHSç¼–ç ï¼š95030039 (å…¶ä»–ç¼©å¾®æ¨¡å‹/ç©å…·)\næ•°é‡ï¼š100å°\nå•ä»·ï¼š1800.00 USD\næ€»ä»·ï¼š180000.00 USD\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šèˆªæ‹é£è¡Œå™¨ï¼›2.æè´¨ï¼šå¡‘æ–™ï¼›3.å“ç‰Œï¼šDJIï¼›4.å‹å·ï¼šMavic 3 Proã€‚\nã€éšé™„å•è¯ã€‘\nå‘ç¥¨æ€»é¢ï¼š180,000 USD`,
            sample2: `æŠ¥å…³å•å·ï¼šTEST-002\nè´§ç‰©åç§°ï¼šæ··åˆåºŸå¡‘æ–™ï¼ˆæœªåˆ†æ‹£ï¼‰\nå¤‡æ³¨ï¼šSecondary Raw Material (å†ç”ŸåŸæ–™)ï¼Œå·¥å‚åº“å­˜æ¸…ç†ï¼Œå«å°‘é‡æ±¡æ¸ã€‚\nHSç¼–ç ï¼š39159090\næ•°é‡ï¼š20 å¨\nå•ä»·ï¼š50.00 USD/å¨\næ€»ä»·ï¼š1000.00 USD\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šå†ç”Ÿå¡‘æ–™é¢—ç²’ï¼›2.æ¥æºï¼šå·¥ä¸šå›æ”¶ã€‚\nã€éšé™„å•è¯ã€‘\nå‘ç¥¨æ˜¾ç¤ºï¼šUnsorted Plastic Scraps`,
            sample3: `æŠ¥å…³å•å·ï¼šTEST-003\nè´§ç‰©åç§°ï¼šæ£‰ç»‡ç‰©\nHSç¼–ç ï¼š52081100\næ•°é‡ï¼š1000 ç±³\næ¯›é‡ï¼š500.0 KG\nå‡€é‡ï¼š480.0 KG\næ€»ä»·ï¼š2000.00 USD\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\n1. è£…ç®±å•ï¼š\n   - æ¯›é‡ï¼š510.0 KG\n   - å‡€é‡ï¼š490.0 KG\n   - æ•°é‡ï¼š1000 Meters`,
            sample4: `æŠ¥å…³å•å·ï¼šTEST-004\nè´§ç‰©åç§°ï¼šæ±½è½¦é¿éœ‡å™¨\nHSç¼–ç ï¼š87088090\næ•°é‡ï¼š200 ä¸ª\nå•ä»·ï¼š30.00 USD\nå“ç‰Œï¼šOEM\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šæ±½è½¦é¿éœ‡å™¨ï¼›\n  2.å“ç‰Œï¼šOEMï¼›\n  3.å‹å·ï¼šé€šç”¨å‹ï¼›\n  4.é€‚ç”¨è½¦å‹ï¼šå¤šæ¬¾è½¦å‹ã€‚\nã€éšé™„å•è¯ã€‘\nå‘ç¥¨é‡‘é¢ä¸€è‡´ã€‚`,
            sample5: `æŠ¥å…³å•å·ï¼šTEST-005\nè´§ç‰©åç§°ï¼šå¡‘æ–™åœ†ç ç¬”\nHSç¼–ç ï¼š96081000\næ•°é‡ï¼š5000 æ”¯\nå•ä»·ï¼š100.00 USD\næ€»ä»·ï¼š500,000.00 USD\nåŸäº§å›½ï¼šè¶Šå—\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šåœ†ç ç¬”ï¼›2.å“ç‰Œï¼šæ— åï¼›3.æè´¨ï¼šå¡‘æ–™ã€‚`,
            sample6: `æŠ¥å…³å•å·ï¼šTEST-006\nè´§ç‰©åç§°ï¼šå®æœ¨å‰ä»–\nHSç¼–ç ï¼š92029000\næ•°é‡ï¼š10 æŠŠ\nå•ä»·ï¼š3000.00 USD\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šå‰ä»–ï¼›\n  2.é¢æ¿æè´¨ï¼šäº‘æ‰ï¼›\n  3.èƒŒä¾§æ¿æè´¨ï¼šå·´è¥¿ç«ç‘°æœ¨ (Dalbergia nigra)ã€‚\nã€éšé™„å•è¯ã€‘\næœªæä¾›CITESè¯æ˜æ–‡ä»¶ã€‚`,
            sample7: `æŠ¥å…³å•å·ï¼šTEST-007\nè´§ç‰©åç§°ï¼šç”·å¼çš®é‹ï¼ˆå±•ä¼šæ ·å“ï¼‰\nHSç¼–ç ï¼š64039900\næ•°é‡ï¼š2 åŒ\nå•ä»·ï¼š0.00 USD (Free Sample)\næ€»ä»·ï¼š0.00 USD\nè´¸æ˜“æ–¹å¼ï¼šè´§æ ·å¹¿å‘Šå“\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šçš®é‹ï¼›2.å“ç‰Œï¼šNIKEï¼›3.æè´¨ï¼šç‰›çš®ã€‚\nå¤‡æ³¨ï¼šä»…ä¾›è¿›åšä¼šå±•ç¤ºï¼Œéé”€å”®ï¼Œå±•ç¤ºåå¤è¿å‡ºå¢ƒã€‚`,
            sample8: `æŠ¥å…³å•å·ï¼šTEST-008\nè´§ç‰©åç§°ï¼šT800çº§ç¢³çº¤ç»´é¢„æµ¸æ–™\nHSç¼–ç ï¼š68151000\næ•°é‡ï¼š500 KG\nå•ä»·ï¼š200.00 USD\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šç¢³çº¤ç»´ï¼›\n  2.æ‹‰ä¼¸å¼ºåº¦ï¼š5.8 GPaï¼›\n  3.ç”¨é€”ï¼šèˆªç©ºèˆªå¤©éƒ¨ä»¶ã€‚\nã€éšé™„å•è¯ã€‘\næœªæåŠä¸¤ç”¨ç‰©é¡¹è®¸å¯è¯ã€‚`,
            sample9: `æŠ¥å…³å•å·ï¼šTEST-009\nè´§ç‰©åç§°ï¼šLEDæ˜¾ç¤ºå±\næ€»ä»·ï¼š10,000.00 USD\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\nå•†ä¸šå‘ç¥¨ï¼š\n   - æ€»é‡‘é¢ï¼š10,000.00 EUR\n   - è´¸æ˜“æ¡æ¬¾ï¼šFOB`
        };

        function loadSample(type) {
            const data = SAMPLES[type] || SAMPLES['normal']; 
            document.getElementById('rawDataInput').value = data;
        }

        async function searchDeclaration() {
            const input = document.getElementById('searchInput');
            const btn = document.getElementById('searchBtn');
            const entryId = input.value.trim();
            if (!entryId) { alert("è¯·è¾“å…¥å•å·ï¼"); return; }
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;
            input.disabled = true;
            try {
                const response = await fetch(QUERY_URL + entryId);
                if (response.status === 404) { alert("æœªæ‰¾åˆ°è¯¥æŠ¥å…³å•æ•°æ®ï¼Œè¯·æ£€æŸ¥å•å·ã€‚"); }
                else if (response.ok) {
                    const resJson = await response.json();
                    const textarea = document.getElementById('rawDataInput');
                    textarea.value = resJson.text;
                    textarea.parentElement.classList.add('neon-border');
                    setTimeout(() => textarea.parentElement.classList.remove('neon-border'), 1000);
                } else { alert("æŸ¥è¯¢æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            } catch (e) { console.error(e); alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼è¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨ã€‚"); }
            finally { btn.innerHTML = 'æŸ¥è¯¢'; btn.disabled = false; input.disabled = false; input.focus(); }
        }

        async function startAnalysis() {
            const rawData = document.getElementById('rawDataInput').value;
            if (!rawData.trim()) { alert("è¯·è¾“å…¥æŠ¥å…³æ•°æ®ï¼"); return; }
            const container = document.getElementById('stepsContainer');
            const finalDiv = document.getElementById('finalResult');
            const btn = document.getElementById('startBtn');
            const statusTag = document.getElementById('statusTag');
            
            // æ¸…é™¤å¾…æœºåŠ¨ç”»ï¼Œæ¢å¤åˆ—è¡¨å¸ƒå±€
            container.innerHTML = ''; 
            container.classList.remove('justify-center', 'items-center', 'min-h-[500px]');
            
            finalDiv.innerHTML = '';
            finalDiv.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç ”åˆ¤è¿›è¡Œä¸­...';
            statusTag.classList.remove('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ raw_data: rawData })
                });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); 
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try { const data = JSON.parse(line.substring(6)); handleEvent(data); }
                            catch (e) { console.error("JSON Parse Error", e); }
                        }
                    }
                }
            } catch (e) { console.error(e); alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åå°å·²å¯åŠ¨ï¼"); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-rocket"></i> å¼€å§‹æ™ºèƒ½ç ”åˆ¤'; statusTag.classList.add('hidden'); }
        }

        function handleEvent(data) {
            const container = document.getElementById('stepsContainer');
            switch (data.type) {
                case 'init':
                    container.innerHTML = data.steps_info.map(step => `
                        <div id="step-${step.id}" class="step-card pending bg-slate-800 rounded p-4 flex items-start gap-4 border border-slate-700">
                            <div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center text-slate-400 icon-box"><i class="fa-solid fa-${step.icon}"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-sm">${step.title}</h3><p class="text-xs text-slate-500 mt-1 msg-box">ç­‰å¾…æ£€æŸ¥...</p></div>
                            <div class="status-icon text-slate-600"><i class="fa-regular fa-circle"></i></div>
                        </div>`).join('');
                    break;
                case 'step_start':
                    const stepEl = document.getElementById(`step-${data.rule_id}`);
                    if (stepEl) {
                        stepEl.classList.remove('pending'); stepEl.classList.add('status-thinking');
                        stepEl.querySelector('.msg-box').innerText = data.loading_text; stepEl.querySelector('.msg-box').classList.add('text-blue-400');
                        stepEl.querySelector('.icon-box').classList.add('bg-blue-900', 'text-blue-300'); stepEl.querySelector('.status-icon').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-blue-500"></i>';
                    } break;
                case 'step_result':
                    const resEl = document.getElementById(`step-${data.rule_id}`);
                    if (resEl) {
                        resEl.classList.remove('status-thinking'); resEl.querySelector('.msg-box').classList.remove('text-blue-400');
                        const isPass = data.status === 'pass'; resEl.classList.add(isPass ? 'pass' : 'risk');
                        resEl.querySelector('.msg-box').innerText = data.message;
                        resEl.querySelector('.status-icon').innerHTML = isPass ? '<i class="fa-solid fa-circle-check text-green-500 text-lg"></i>' : '<i class="fa-solid fa-triangle-exclamation text-red-500 text-lg"></i>';
                        if (!isPass) resEl.querySelector('.msg-box').classList.add('text-red-300');
                    } break;
                case 'complete':
                    const finalDiv = document.getElementById('finalResult'); finalDiv.classList.remove('hidden');
                    const isSafe = data.final_status === 'pass';
                    finalDiv.innerHTML = `<div class="p-6 rounded-lg border ${isSafe ? 'border-green-500/50 bg-green-500/10' : 'border-red-500/50 bg-red-500/10'} text-center shadow-lg"><i class="fa-solid ${isSafe ? 'fa-shield-check text-green-500' : 'fa-triangle-exclamation text-red-500'} text-5xl mb-4"></i><h3 class="text-2xl font-bold ${isSafe ? 'text-green-400' : 'text-red-400'}">${isSafe ? 'ç ”åˆ¤é€šè¿‡' : 'å‘ç°é£é™©'}</h3><p class="mt-2 text-slate-300 whitespace-pre-line text-left bg-slate-900/50 p-4 rounded">${data.summary}</p></div>`;
                    document.querySelector('#module-audit .overflow-y-auto').scrollTop = 9999; break;
            }
        }

        // --- [æ¨¡å—B] å’¨è¯¢é€»è¾‘ (å·²ä¿®å¤æ»šåŠ¨é—®é¢˜) ---
        async function sendMessage() {
            const inputEl = document.getElementById('chatInput');
            const historyEl = document.getElementById('chatHistory');
            const sendBtn = document.getElementById('sendBtn');
            const msg = inputEl.value.trim();
            
            if (!msg) return;

            // 1. åˆ›å»ºç”¨æˆ·æ¶ˆæ¯
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble chat-user'; 
            userBubble.innerText = msg;
            
            const userContainer = document.createElement('div');
            userContainer.className = 'flex justify-end'; 
            userContainer.appendChild(userBubble);
            historyEl.appendChild(userContainer);

            // æ¸…ç©ºè¾“å…¥æ¡†
            inputEl.value = '';
            
            // ã€å¼ºåˆ¶æ»šåŠ¨ã€‘ç”¨æˆ·åˆšå‘æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»æ»šåˆ°åº•éƒ¨
            historyEl.scrollTop = historyEl.scrollHeight;

            // 2. åˆ›å»ºæ€è€ƒå ä½ç¬¦
            const thinkingEl = document.createElement('div');
            thinkingEl.className = 'chat-thinking';
            thinkingEl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ™ºèƒ½ä½“æ­£åœ¨åˆ†æé—®é¢˜...';
            historyEl.appendChild(thinkingEl);
            
            // 3. åˆ›å»º AI å›å¤æ°”æ³¡ (åˆå§‹éšè—)
            const aiContainer = document.createElement('div');
            aiContainer.className = 'flex justify-start'; 
            
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble chat-ai hidden'; 
            
            aiContainer.appendChild(aiBubble);
            historyEl.appendChild(aiContainer);

            // ã€å¼ºåˆ¶æ»šåŠ¨ã€‘æ˜¾ç¤ºæ€è€ƒæ—¶ï¼Œä¹Ÿæ»šåˆ°åº•éƒ¨
            historyEl.scrollTop = historyEl.scrollHeight;

            // å˜é‡å‡†å¤‡
            let fullResponseText = ""; 
            sendBtn.disabled = true; 

            try {
                const response = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, session_id: SESSION_ID }) 
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.substring(6).trim();
                                if (!jsonStr) continue;
                                const data = JSON.parse(jsonStr);

                                // ============================================================
                                // ğŸ”¥ æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½æ»šåŠ¨é€»è¾‘ ğŸ”¥
                                // åˆ¤æ–­ç”¨æˆ·å½“å‰æ˜¯å¦åœ¨åº•éƒ¨ (å…è®¸ 100px çš„è¯¯å·®)
                                // ============================================================
                                const isUserAtBottom = (historyEl.scrollHeight - historyEl.scrollTop - historyEl.clientHeight) < 100;

                                if (data.type === 'thinking') {
                                    thinkingEl.innerHTML = `<i class="fa-solid fa-microchip text-cyan-500 mr-2"></i> ${data.content}`;
                                    // åªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶ï¼Œæ‰è‡ªåŠ¨æ»š
                                    if (isUserAtBottom) historyEl.scrollTop = historyEl.scrollHeight;

                                } else if (data.type === 'answer') {
                                    thinkingEl.style.display = 'none';
                                    aiBubble.classList.remove('hidden');
                                    
                                    fullResponseText += data.content; 
                                    aiBubble.innerHTML = marked.parse(fullResponseText);
                                    
                                    // åªæœ‰ç”¨æˆ·åœ¨åº•éƒ¨æ—¶ï¼Œæ‰è‡ªåŠ¨æ»š
                                    if (isUserAtBottom) historyEl.scrollTop = historyEl.scrollHeight;

                                } else if (data.type === 'error') {
                                    thinkingEl.style.display = 'none';
                                    aiBubble.classList.remove('hidden');
                                    aiBubble.classList.add('text-red-400', 'bg-red-900/20', 'border-red-500/50');
                                    aiBubble.innerHTML = `**[ç³»ç»Ÿé”™è¯¯]** ${data.content}`;
                                    historyEl.scrollTop = historyEl.scrollHeight; // æŠ¥é”™æ—¶å¼ºåˆ¶æ»šä¸€ä¸‹æç¤ºç”¨æˆ·
                                }

                            } catch (e) { 
                                console.error("JSON Parse Error", e);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error(e);
                thinkingEl.innerHTML = `<span class="text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> è¿æ¥è¶…æ—¶æˆ–æœåŠ¡å¼‚å¸¸</span>`;
            } finally {
                sendBtn.disabled = false; 
            }
        }

        // --- [æ¨¡å—C] æŠ¥å‘Šé€»è¾‘ (æ ¸å¿ƒæ›´æ–°) ---
        
        // å¼•ç”¨å®¡å•æ•°æ®
        function importFromAudit() {
            const rawData = document.getElementById('rawDataInput').value;
            const resultDiv = document.getElementById('finalResult');
            let riskContext = "";
            if (!resultDiv.classList.contains('hidden')) { riskContext = "\n\nã€é£é™©ç ”åˆ¤ç³»ç»Ÿç»“è®ºã€‘\n" + resultDiv.innerText; }
            if (!rawData && !riskContext) { alert("å®¡å•æ¨¡å—æš‚æ— æ•°æ®å¯å¼•ç”¨ï¼"); return; }
            document.getElementById('reportContextInput').value = "ã€åŸå§‹æŠ¥å…³æ•°æ®ã€‘\n" + rawData + riskContext;
            document.getElementById('source-status').innerText = "å·²å¯¼å…¥å®¡å•æ•°æ®";
            // è‡ªåŠ¨åˆ‡æ¢å¹¶é«˜äº®è¾“å…¥æ¡†
            const textarea = document.getElementById('reportContextInput');
            textarea.classList.add('neon-border');
            setTimeout(() => textarea.classList.remove('neon-border'), 1000);
        }

        // å¯åŠ¨ç”Ÿæˆ
        async function startReportGeneration() {
            const rawData = document.getElementById('reportContextInput').value.trim();
            if (!rawData) { alert("è¯·å…ˆè¾“å…¥éœ€è¦åˆ†æçš„æ•°æ®ï¼"); return; }

            const btn = document.getElementById('btn-gen-report');
            const timeline = document.getElementById('reportTimeline');
            const contentDiv = document.getElementById('reportContent');
            const placeholder = document.getElementById('report-placeholder');

            // 1. é‡ç½® UI çŠ¶æ€
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç”Ÿæˆä¸­...';
            placeholder.classList.add('hidden'); // éšè—é®ç½©
            contentDiv.innerHTML = ''; // æ¸…ç©ºæ—§æŠ¥å‘Š
            timeline.innerHTML = '<div class="timeline-step active"><i class="fa-solid fa-brain"></i> <span>è§„åˆ’ä¸­...</span></div>';
            
            try {
                const response = await fetch(REPORT_API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ raw_data: rawData })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const event = JSON.parse(line.substring(6));
                                handleReportEvent(event, timeline, contentDiv);
                            } catch (e) {
                                console.error("SSE Parse Error:", e);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error(e);
                contentDiv.innerHTML = `<div class="p-4 text-red-400 border border-red-800 rounded bg-red-900/20">âŒ ç”Ÿæˆå¤±è´¥: ${e.message}</div>`;
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fa-solid fa-play"></i> ç”ŸæˆæŠ¥å‘Š';
            }
        }

        // å¤„ç† SSE äº‹ä»¶ (æ ¸å¿ƒåŠ¨ç”»é€»è¾‘)
        function handleReportEvent(event, timelineEl, contentEl) {
            const { type, payload } = event;

            switch (type) {
                case 'planning':
                    // åˆå§‹è§„åˆ’çŠ¶æ€å·²åœ¨ startReportGeneration ä¸­è®¾ç½®ï¼Œè¿™é‡Œå¯æ›´æ–°æç¤ºæ–‡å­—
                    break;
                    
                case 'toc_generated':
                    // æ”¶åˆ°ç›®å½•ï¼Œæ¸²æŸ“é¡¶éƒ¨æµç¨‹æ¡
                    // payload.steps = ["1. xxx", "2. xxx"]
                    timelineEl.innerHTML = payload.steps.map((step, idx) => `
                        <div id="toc-step-${idx}" class="timeline-step">
                            <i class="fa-regular fa-circle"></i>
                            <span>${step.split(' ')[1] || step}</span> <!-- å–ç¼–å·åçš„æ–‡å­— -->
                        </div>
                    `).join('');
                    break;

                case 'step_start':
                    // æŸä¸€ç« å¼€å§‹ç”Ÿæˆï¼šç‚¹äº®å¯¹åº”çš„æ­¥éª¤æ¡ï¼Œå¹¶åˆ›å»ºè¯¥ç« çš„å®¹å™¨
                    const stepEl = document.getElementById(`toc-step-${payload.index}`);
                    if (stepEl) {
                        stepEl.classList.add('active');
                        stepEl.querySelector('i').className = 'fa-solid fa-circle-notch fa-spin'; // è½¬åœˆ
                    }
                    // åœ¨æ­£æ–‡ä¸­æ·»åŠ æ ‡é¢˜å ä½
                    contentEl.innerHTML += `<h2 id="section-${payload.index}" class="text-cyan-400 mt-6 mb-2 border-b border-slate-700 pb-2">${payload.title}</h2><div id="content-${payload.index}" class="mb-4"></div>`;
                    // è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨
                    contentEl.scrollTop = contentEl.scrollHeight;
                    break;

                case 'step_stream':
                    // æ”¶åˆ°æ–‡å­—ç‰‡æ®µï¼Œè¿½åŠ åˆ°å½“å‰ç« èŠ‚å®¹å™¨ä¸­
                    const lastContentDiv = contentEl.lastElementChild;
                    if (lastContentDiv) {
                        const currentText = lastContentDiv.getAttribute('data-raw') || "";
                        const newText = currentText + payload.chunk;
                        lastContentDiv.setAttribute('data-raw', newText);
                        lastContentDiv.innerHTML = marked.parse(newText);
                        
                        // ã€æ ¸å¿ƒä¿®å¤ï¼šæ™ºèƒ½æ»šåŠ¨é€»è¾‘ã€‘
                        // 1. è®¡ç®—ç”¨æˆ·å½“å‰æ˜¯å¦å¤„äºâ€œåº•éƒ¨é™„è¿‘â€ï¼ˆå…è®¸ 50px çš„è¯¯å·®ï¼‰
                        const isUserAtBottom = (contentEl.scrollHeight - contentEl.scrollTop - contentEl.clientHeight) < 50;

                        // 2. åªæœ‰å½“ç”¨æˆ·åŸæœ¬å°±åœ¨åº•éƒ¨æ—¶ï¼Œæ‰è‡ªåŠ¨æ»šåŠ¨
                        if (isUserAtBottom) {
                            contentEl.scrollTop = contentEl.scrollHeight;
                        }
                        // å¦åˆ™ï¼ˆç”¨æˆ·å‘ä¸Šç¿»çœ‹äº†ï¼‰ï¼Œä»€ä¹ˆéƒ½ä¸åšï¼Œä¿æŒåœ¨ç”¨æˆ·å½“å‰çœ‹çš„ä½ç½®
                    }
                    break;

                case 'step_done':
                    // æŸä¸€ç« å®Œæˆï¼šå˜ç»¿ï¼Œæ‰“å‹¾
                    const doneStepEl = document.getElementById(`toc-step-${payload.index}`);
                    if (doneStepEl) {
                        doneStepEl.classList.remove('active');
                        doneStepEl.classList.add('done');
                        doneStepEl.querySelector('i').className = 'fa-solid fa-check';
                    }
                    break;

                case 'done':
                    // å…¨éƒ¨å®Œæˆ
                    contentEl.innerHTML += `<div class="mt-8 p-4 bg-green-900/20 border border-green-700 rounded text-center text-green-400 font-bold"><i class="fa-solid fa-check-double"></i> æŠ¥å‘Šç”Ÿæˆå®Œæ¯•</div>`;
                    break;
            }
        }

        // ã€æ–°å¢ã€‘ç›‘å¬æ»šåŠ¨äº‹ä»¶ï¼Œæ§åˆ¶æŒ‰é’®æ˜¾ç¤º
        const reportContentEl = document.getElementById('reportContent');
        const scrollBtn = document.getElementById('scroll-to-bottom-btn');

        reportContentEl.addEventListener('scroll', () => {
            // å¦‚æœè·ç¦»åº•éƒ¨è¶…è¿‡ 100pxï¼Œæ˜¾ç¤ºæŒ‰é’®
            const distanceToBottom = reportContentEl.scrollHeight - reportContentEl.scrollTop - reportContentEl.clientHeight;
            if (distanceToBottom > 100) {
                scrollBtn.classList.remove('opacity-0', 'pointer-events-none');
            } else {
                scrollBtn.classList.add('opacity-0', 'pointer-events-none');
            }
        });

        // ã€æ–°å¢ã€‘ç‚¹å‡»æŒ‰é’®å›åˆ°åº•éƒ¨
        function scrollToBottom() {
            const contentEl = document.getElementById('reportContent');
            contentEl.scrollTo({ top: contentEl.scrollHeight, behavior: 'smooth' });
        }
    </script>
</body>
</html>