================================================================================
é¡¹ç›®æ‰€æœ‰ä»£ç æ–‡ä»¶å†…å®¹æ±‡æ€»
ç”Ÿæˆæ—¶é—´: 3.13.2 (tags/v3.13.2:4f8bb39, Feb  4 2025, 15:23:48) [MSC v.1942 64 bit (AMD64)]
æ–‡ä»¶æ€»æ•°: 23
================================================================================


============================================================
æ–‡ä»¶ 1/23: collect_code_to_txt.py
============================================================

#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
æ”¶é›†é¡¹ç›®æ‰€æœ‰ä»£ç æ–‡ä»¶å†…å®¹åˆ°ä¸€ä¸ªtxtæ–‡ä»¶ä¸­
æ’é™¤çŸ¥è¯†åº“æ–‡ä»¶ï¼ˆconfig/ç›®å½•ä¸‹çš„txtæ–‡ä»¶ï¼‰
"""

import os
import sys
from pathlib import Path

def is_code_file(file_path):
    """åˆ¤æ–­æ˜¯å¦ä¸ºä»£ç æ–‡ä»¶"""
    # æ’é™¤çŸ¥è¯†åº“æ–‡ä»¶ï¼šconfig/ç›®å½•ä¸‹çš„txtæ–‡ä»¶
    if "config" in str(file_path) and file_path.suffix == ".txt":
        return False
    
    # æ’é™¤å…¶ä»–éä»£ç æ–‡ä»¶
    if file_path.name in [".env", ".gitignore", "README.md", "requirements.txt"]:
        return False
    
    # æ’é™¤ç¼“å­˜ç›®å½•
    if "UsersZhuanZnpm-cache" in str(file_path) or ".cursor" in str(file_path) or ".roo" in str(file_path):
        return False
    
    # æ’é™¤æ—¥å¿—æ–‡ä»¶
    if file_path.suffix == ".log":
        return False
    
    # åªåŒ…å«ç‰¹å®šæ‰©å±•åçš„æ–‡ä»¶
    code_extensions = {'.py', '.json', '.js', '.ts', '.html', '.css', '.java', '.cpp', '.c', '.go', '.rs', '.rb', '.php'}
    return file_path.suffix in code_extensions

def collect_code_files(root_dir):
    """æ”¶é›†æ‰€æœ‰ä»£ç æ–‡ä»¶"""
    code_files = []
    root_path = Path(root_dir)
    
    for file_path in root_path.rglob("*"):
        if file_path.is_file() and is_code_file(file_path):
            # è®¡ç®—ç›¸å¯¹è·¯å¾„
            rel_path = file_path.relative_to(root_path)
            code_files.append((rel_path, file_path))
    
    # æŒ‰è·¯å¾„æ’åº
    code_files.sort(key=lambda x: str(x[0]))
    return code_files

def read_file_content(file_path):
    """è¯»å–æ–‡ä»¶å†…å®¹"""
    try:
        with open(file_path, 'r', encoding='utf-8') as f:
            return f.read()
    except UnicodeDecodeError:
        try:
            with open(file_path, 'r', encoding='gbk') as f:
                return f.read()
        except:
            return f"æ— æ³•è¯»å–æ–‡ä»¶: {file_path} (ç¼–ç é—®é¢˜)"
    except Exception as e:
        return f"è¯»å–æ–‡ä»¶å¤±è´¥: {file_path} - {str(e)}"

def main():
    # è·å–å½“å‰ç›®å½•
    current_dir = os.getcwd()
    print(f"å½“å‰ç›®å½•: {current_dir}")
    
    # æ”¶é›†ä»£ç æ–‡ä»¶
    print("æ­£åœ¨æ”¶é›†ä»£ç æ–‡ä»¶...")
    code_files = collect_code_files(current_dir)
    
    if not code_files:
        print("æœªæ‰¾åˆ°ä»£ç æ–‡ä»¶ï¼")
        return
    
    print(f"æ‰¾åˆ° {len(code_files)} ä¸ªä»£ç æ–‡ä»¶:")
    for rel_path, _ in code_files:
        print(f"  - {rel_path}")
    
    # è¾“å‡ºæ–‡ä»¶
    output_file = "all_code_content.txt"
    print(f"\næ­£åœ¨å†™å…¥åˆ°: {output_file}")
    
    with open(output_file, 'w', encoding='utf-8') as out_f:
        # å†™å…¥æ–‡ä»¶å¤´
        out_f.write("=" * 80 + "\n")
        out_f.write("é¡¹ç›®æ‰€æœ‰ä»£ç æ–‡ä»¶å†…å®¹æ±‡æ€»\n")
        out_f.write(f"ç”Ÿæˆæ—¶é—´: {sys.version}\n")
        out_f.write(f"æ–‡ä»¶æ€»æ•°: {len(code_files)}\n")
        out_f.write("=" * 80 + "\n\n")
        
        # å†™å…¥æ¯ä¸ªæ–‡ä»¶çš„å†…å®¹
        for i, (rel_path, file_path) in enumerate(code_files, 1):
            out_f.write(f"\n{'=' * 60}\n")
            out_f.write(f"æ–‡ä»¶ {i}/{len(code_files)}: {rel_path}\n")
            out_f.write(f"{'=' * 60}\n\n")
            
            content = read_file_content(file_path)
            out_f.write(content)
            
            # å¦‚æœä¸æ˜¯æœ€åä¸€ä¸ªæ–‡ä»¶ï¼Œæ·»åŠ ä¸€äº›ç©ºè¡Œ
            if i < len(code_files):
                out_f.write("\n\n")
    
    print(f"\nå®Œæˆï¼æ‰€æœ‰ä»£ç å†…å®¹å·²ä¿å­˜åˆ°: {output_file}")
    print(f"æ€»æ–‡ä»¶æ•°: {len(code_files)}")
    
    # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
    output_size = os.path.getsize(output_file)
    print(f"è¾“å‡ºæ–‡ä»¶å¤§å°: {output_size:,} å­—èŠ‚ ({output_size/1024:.2f} KB)")

if __name__ == "__main__":
    main()


============================================================
æ–‡ä»¶ 2/23: config\risk_rules.json
============================================================

{
  "meta": {
    "version": "2.0-RAG",
    "updated_at": "2025-11-17",
    "system_role_definition": "ä½ æ˜¯ä¸€åæ‹¥æœ‰20å¹´ç»éªŒçš„æµ·å…³é«˜çº§æŸ¥éªŒä¸“å®¶ã€‚ä½ çš„ä»»åŠ¡æ˜¯é˜…è¯»æŠ¥å…³æ¡ˆå·æ•°æ®ï¼Œå¹¶ä¸¥æ ¼ä¾æ®æä¾›çš„ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ã€‘ï¼ˆRAG CONTEXTï¼‰è¿›è¡Œé£é™©ç ”åˆ¤ã€‚è¯·å¿½ç•¥æ•°æ®æ ¼å¼çš„æ··ä¹±ï¼Œä¸“æ³¨äºè¯­ä¹‰åˆ†æã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œæˆ‘ä¼šå¤šæ¬¡è®©ä½ å®¡æŸ¥ä¸åŒçš„å…³æ³¨ç‚¹ï¼Œä¾‹å¦‚åŸºç¡€è¦ç´ å®Œæ•´æ€§æ ¡éªŒã€ç¦é™ä¸æ•æ„Ÿè´§ç‰©ç­›æŸ¥ã€ä»·æ ¼çœŸå®æ€§é€»è¾‘ç ”åˆ¤ã€å½’ç±»ä¸€è‡´æ€§åˆ†æç­‰ã€‚æ¯æ¬¡å®¡æŸ¥æ—¶ï¼Œè¯·ä»…ä»…ä¾æ®å½“å‰å…³æ³¨ç‚¹çš„æŒ‡å¯¼æ–‡ä»¶å†…å®¹è¿›è¡Œåˆ¤æ–­ï¼Œé¿å…å¼•å…¥å…¶ä»–æ¨¡å—çš„å…³æ³¨ç‚¹ï¼Œå¯¼è‡´å¤šæ¬¡å®¡æŸ¥è¾“å‡ºçš„ä¿¡æ¯é‡å¤ã€‚"
  },
  "global_output_requirement": "è¯·ä¸¥æ ¼è¿”å›ä¸€ä¸ªJSONäºŒå…ƒæ•°ç»„ï¼š[\"ç¬¦å·\", \"ç®€çŸ­ç»“è®º\"]ã€‚\n- å¦‚æœé£é™©ä½/é€šè¿‡ï¼Œç¬¦å·ä¸º \"âˆš\"ã€‚\n- å¦‚æœé£é™©é«˜/å­˜ç–‘ï¼Œç¬¦å·ä¸º \"x\"ã€‚\nç¤ºä¾‹ï¼š[\"âˆš\", \"ç”³æŠ¥è¦ç´ å®Œæ•´\"] æˆ– [\"x\", \"ä»·æ ¼é€»è¾‘å¼‚å¸¸ï¼Œç–‘ä¼¼ä½æŠ¥\"]",
  "rules": [
    {
      "id": "R01_BASIC_INFO",
      "enabled": true,
      "display": {
        "title": "åŸºç¡€è¦ç´ å®Œæ•´æ€§æ ¡éªŒ",
        "loading_text": "æ­£åœ¨åŠ è½½ã€ŠåŸºç¡€è¦ç´ è§„èŒƒæŒ‡å—ã€‹ï¼Œæ£€æŸ¥ç”³æŠ¥å®Œæ•´æ€§...",
        "icon": "file-text",
        "color": "blue"
      },
      "rag_file": "rag_r01_basic_info.txt",
      "instruction": "è¯·ç»“åˆæä¾›çš„ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ã€‘ï¼Œé‡ç‚¹æ£€æŸ¥æŠ¥å…³æ•°æ®ä¸­çš„é«˜ç§‘æŠ€å•†å“ï¼ˆå¦‚ICã€æœºæ¢°ï¼‰æ˜¯å¦æä¾›äº†å…·ä½“çš„å‹å·ã€é›¶ä»¶ç¼–å·ã€åŠŸèƒ½è¯´æ˜ç­‰å…³é”®è¦ç´ ã€‚å¦‚æœä»…æœ‰æ¨¡ç³Šæè¿°ï¼ˆå¦‚'é…ä»¶'ã€'æ— å‹å·'ï¼‰ï¼Œè¯·åˆ¤å®šä¸ºé£é™©ã€‚"
    },
    {
      "id": "R02_SENSITIVE_GOODS",
      "enabled": true,
      "display": {
        "title": "ç¦é™ä¸æ•æ„Ÿè´§ç‰©ç­›æŸ¥",
        "loading_text": "æ­£åœ¨åŠ è½½ã€Šç¦é™ç®¡åˆ¶ç›®å½•ã€‹ï¼Œç­›æŸ¥æ•æ„Ÿé£é™©...",
        "icon": "shield-alert",
        "color": "red"
      },
      "rag_file": "rag_r02_sensitive_goods.txt",
      "instruction": "è¯·ç»“åˆæä¾›çš„ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ã€‘ï¼Œåˆ†æè´§ç‰©åç§°ã€æˆåˆ†å’Œå¤‡æ³¨ã€‚ä¸¥æ ¼ç­›æŸ¥æ˜¯å¦æ¶‰åŠ'å›ºä½“åºŸç‰©'ï¼ˆæ´‹åƒåœ¾ï¼‰ã€'æ¿’å±ç‰©ç§'æˆ–'ä¸¤ç”¨ç‰©é¡¹'ã€‚å¦‚æœè´§ç‰©ç‰¹å¾å‘½ä¸­äº†æŒ‡å¯¼æ–‡ä»¶ä¸­çš„é£é™©å…³é”®è¯ï¼Œè¯·åˆ¤å®šä¸ºé£é™©ã€‚"
    },
    {
      "id": "R03_PRICE_LOGIC",
      "enabled": true,
      "display": {
        "title": "ä»·æ ¼çœŸå®æ€§é€»è¾‘ç ”åˆ¤",
        "loading_text": "æ­£åœ¨åŠ è½½ã€Šä»·æ ¼é£é™©è¯„ä¼°æŒ‡å—ã€‹ï¼Œåˆ†æå•†ä¸šé€»è¾‘...",
        "icon": "currency-yen",
        "color": "gold"
      },
      "rag_file": "rag_r03_price_logic.txt",
      "instruction": "è¯·ç»“åˆæä¾›çš„ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ã€‘ï¼Œè¿ç”¨ä½ çš„å•†ä¸šå¸¸è¯†åˆ†æ'å•ä»·'å’Œ'æ€»ä»·'ã€‚åˆ¤æ–­æ˜¯å¦å­˜åœ¨æ˜æ˜¾çš„ä½æŠ¥ä»·æ ¼ï¼ˆä½äºå¸‚åœºå‡ä»·30%ï¼‰æˆ–é«˜æŠ¥ä»·æ ¼é£é™©ã€‚æ³¨æ„ï¼šå¦‚æœæ˜¯æ—§è´§æˆ–æ®‹æ¬¡å“ï¼Œéœ€æ£€æŸ¥å¤‡æ³¨è¯´æ˜æ˜¯å¦åˆç†ã€‚"
    },
    {
      "id": "R04_HS_CLASSIFICATION",
      "enabled": true,
      "display": {
        "title": "å½’ç±»ä¸€è‡´æ€§åˆ†æ",
        "loading_text": "æ­£åœ¨åŠ è½½ã€ŠHSç¼–ç å½’ç±»æ€»è§„åˆ™ã€‹ï¼Œæ ¡éªŒå½’ç±»é€»è¾‘...",
        "icon": "barcode",
        "color": "purple"
      },
      "rag_file": "rag_r04_hs_classification.txt",
      "instruction": "è¯·ç»“åˆæä¾›çš„ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ã€‘ï¼Œåˆ†æ'è´§ç‰©åç§°'ã€'å®é™…ç”¨é€”'ä¸ç”³æŠ¥çš„'HSç¼–ç 'æ˜¯å¦é€»è¾‘ä¸€è‡´ã€‚é‡ç‚¹è¯†åˆ«æ˜¯å¦å­˜åœ¨å°†æˆå“ï¼ˆé«˜ç¨ç‡ï¼‰ä¼ªæŠ¥ä¸ºé›¶ä»¶ï¼ˆä½ç¨ç‡ï¼‰çš„'ä½å½’é«˜èµ°'é£é™©ã€‚"
    },
    {
      "id": "R05_DOC_MATCH",
      "enabled": true,
      "display": {
        "title": "å•è¯ä¸€è‡´æ€§äº¤å‰æ¯”å¯¹",
        "loading_text": "æ­£åœ¨åŠ è½½ã€Šå•è¯å®¡æ ¸è§„èŒƒã€‹ï¼Œè¿›è¡Œäº¤å‰æ¯”å¯¹...",
        "icon": "clipboard-check",
        "color": "green"
      },
      "rag_file": "rag_r05_doc_match.txt",
      "instruction": "è¯·ç»“åˆæä¾›çš„ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ã€‘ï¼Œåœ¨æ•°æ®ä¸­æŸ¥æ‰¾å‘ç¥¨ã€è£…ç®±å•ç­‰éšé™„ä¿¡æ¯ã€‚æ¯”å¯¹'é‡é‡'ã€'é‡‘é¢'ã€'å¸åˆ¶'æ˜¯å¦ä¸æŠ¥å…³å•ç”³æŠ¥å®Œå…¨ä¸€è‡´ã€‚å¦‚æœæ•°æ®ç¼ºå¤±å¯¼è‡´æ— æ³•æ¯”å¯¹ï¼Œä¹Ÿåº”è§†ä¸ºé£é™©ã€‚"
    }
  ]
}


============================================================
æ–‡ä»¶ 3/23: src\__init__.py
============================================================




============================================================
æ–‡ä»¶ 4/23: src\api\__init__.py
============================================================




============================================================
æ–‡ä»¶ 5/23: src\api\routes.py
============================================================

from fastapi import APIRouter, HTTPException, Request
from fastapi.responses import StreamingResponse
from pydantic import BaseModel

from src.services.data_client import DataClient
from src.core.orchestrator import RiskAnalysisOrchestrator

# æ³¨æ„ï¼šè¿™é‡Œä¸å†å¯¼å…¥ CustomsChatAgent ç±»ï¼Œå› ä¸ºæˆ‘ä»¬ä¸éœ€è¦å®ä¾‹åŒ–å®ƒäº†

router = APIRouter()

# å®šä¹‰è¯·æ±‚ä½“çš„æ•°æ®ç»“æ„
class AnalysisRequest(BaseModel):
    raw_data: str

class ChatRequest(BaseModel):
    message: str
    session_id: str = "default_session"

@router.post("/analyze")
async def analyze_customs_declaration(request: AnalysisRequest):
    """
    æ ¸å¿ƒåˆ†ææ¥å£ (SSE æµå¼è¾“å‡º)
    """
    if not request.raw_data or len(request.raw_data.strip()) < 5:
        raise HTTPException(status_code=400, detail="è¯·è¾“å…¥æœ‰æ•ˆçš„æŠ¥å…³æ•°æ®")

    orchestrator = RiskAnalysisOrchestrator()

    return StreamingResponse(
        orchestrator.analyze_stream(request.raw_data),
        media_type="text/event-stream"
    )

@router.post("/chat")
async def chat_with_agent(body: ChatRequest, request: Request):
    """
    LangChain å¯¹è¯æ¥å£ (SSE æµ) - ä½¿ç”¨å…¨å±€å•ä¾‹æ¨¡å¼
    """
    # 1. ä» app.state ä¸­è·å–é¢„åŠ è½½å¥½çš„ Agent
    agent = getattr(request.app.state, "agent", None)
    
    if not agent:
        raise HTTPException(status_code=503, detail="AI æœåŠ¡åˆå§‹åŒ–å¤±è´¥æˆ–æ­£åœ¨å¯åŠ¨ä¸­ï¼Œè¯·ç¨åé‡è¯•")

    # 2. å¤ç”¨åŒä¸€ä¸ª Agent å®ä¾‹è¿›è¡Œå¯¹è¯
    return StreamingResponse(
        agent.chat_stream(body.message, body.session_id),
        media_type="text/event-stream"
    )

@router.get("/health")
def health_check():
    return {"status": "ok", "service": "Customs AI Agent"}

@router.get("/query/declaration/{entry_id}")
async def query_declaration_data(entry_id: str):
    client = DataClient()
    text_data = client.fetch_declaration_text(entry_id)
    
    if not text_data:
        raise HTTPException(status_code=404, detail="æœªæ‰¾åˆ°è¯¥æŠ¥å…³å•æ•°æ®")
        
    return {"status": "success", "text": text_data}


============================================================
æ–‡ä»¶ 6/23: src\config\__init__.py
============================================================




============================================================
æ–‡ä»¶ 7/23: src\config\loader.py
============================================================

import os
from pathlib import Path
from dotenv import load_dotenv

# 1. è‡ªåŠ¨å¯»æ‰¾å¹¶åŠ è½½é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„ .env æ–‡ä»¶
# è·å–å½“å‰æ–‡ä»¶ (loader.py) çš„ä¸Šçº§ç›®å½•çš„ä¸Šçº§ç›®å½•ï¼Œå³é¡¹ç›®æ ¹ç›®å½•
BASE_DIR = Path(__file__).resolve().parent.parent.parent
ENV_PATH = BASE_DIR / ".env"

if ENV_PATH.exists():
    load_dotenv(dotenv_path=ENV_PATH)
else:
    print(f"âš ï¸ è­¦å‘Š: æœªæ‰¾åˆ°é…ç½®æ–‡ä»¶ {ENV_PATH}ï¼Œå°†å°è¯•è¯»å–ç³»ç»Ÿç¯å¢ƒå˜é‡ã€‚")

class ConfigLoader:
    """
    é…ç½®åŠ è½½å™¨ï¼šå•ä¾‹æ¨¡å¼ï¼Œè´Ÿè´£å°†ç¯å¢ƒå˜é‡æ˜ å°„ä¸º Python å±æ€§
    """
    
    # --- API Key é…ç½® ---
    GOOGLE_API_KEY = os.getenv("GOOGLE_API_KEY", "")
        # æ–°å¢ DeepSeek é…ç½®
    DEEPSEEK_API_KEY = os.getenv("DEEPSEEK_API_KEY")
    DEEPSEEK_BASE_URL = os.getenv("DEEPSEEK_BASE_URL", "https://api.deepseek.com")
    DEEPSEEK_MODEL = os.getenv("DEEPSEEK_MODEL", "deepseek-chat")
    
    # --- æ¨¡å‹é…ç½® ---
    # å¼ºåˆ¶é»˜è®¤ç­–ç•¥ï¼šå¦‚æœæ²¡å¡«ï¼Œé»˜è®¤ä¹Ÿæ˜¯ 2.5-flashï¼Œç¦æ­¢å›é€€åˆ° 1.5
    MODEL_NAME = os.getenv("GEMINI_MODEL_NAME", "gemini-2.0-flash")
    
    # --- ç½‘ç»œ/ä»£ç†é…ç½® ---
    HTTP_PROXY = os.getenv("HTTP_PROXY")
    HTTPS_PROXY = os.getenv("HTTPS_PROXY")

    # --- å¤–éƒ¨æœåŠ¡é…ç½® ---
    DATA_PLATFORM_URL = os.getenv("DATA_PLATFORM_URL", "http://127.0.0.1:8088")
    
    # --- æœåŠ¡åŸºç¡€é…ç½® ---
    HOST = os.getenv("API_HOST", "0.0.0.0")
    PORT = int(os.getenv("API_PORT", "8000"))

    @classmethod
    def validate(cls):
        """å¯åŠ¨å‰è‡ªæ£€ï¼Œç¡®ä¿å…³é”®é…ç½®å­˜åœ¨"""
        if not cls.GOOGLE_API_KEY:
            raise ValueError("âŒ ä¸¥é‡é”™è¯¯: æœªæ£€æµ‹åˆ° GOOGLE_API_KEYï¼è¯·æ£€æŸ¥ .env æ–‡ä»¶ã€‚")

# å®ä¾‹åŒ–ä¸€ä¸ªå¯¹è±¡ä¾›å¤–éƒ¨ç›´æ¥å¯¼å…¥ä½¿ç”¨
settings = ConfigLoader()

# æ¨¡å—åŠ è½½æ—¶è‡ªåŠ¨æ‰§è¡Œæ£€æŸ¥ï¼Œæœ‰é—®é¢˜ç›´æ¥æŠ¥é”™ï¼Œé˜²æ­¢ç³»ç»Ÿå¸¦ç—…è¿è¡Œ
settings.validate()



============================================================
æ–‡ä»¶ 8/23: src\core\__init__.py
============================================================




============================================================
æ–‡ä»¶ 9/23: src\core\orchestrator.py
============================================================

import time
import json
import asyncio
from datetime import datetime
from typing import AsyncGenerator

# å¯¼å…¥æˆ‘ä»¬ä¹‹å‰å†™å¥½çš„æ¨¡å—
from src.core.prompt_builder import PromptBuilder
from src.services.llm_service import LLMService

class RiskAnalysisOrchestrator:
    def __init__(self):
        # åˆå§‹åŒ–å„ä¸ªç»„ä»¶
        self.prompt_builder = PromptBuilder()
        self.llm_service = LLMService()
        
        # è·å–æ‰€æœ‰å·²å¯ç”¨çš„è§„åˆ™
        # è¿‡æ»¤æ‰ enabled: false çš„è§„åˆ™
        self.active_rules = [r for r in self.prompt_builder.config['rules'] if r.get('enabled', True)]

    async def analyze_stream(self, raw_data_context: str) -> AsyncGenerator[str, None]:
        """
        æ ¸å¿ƒæµå¼åˆ†æå‡½æ•°ã€‚
        è¿™æ˜¯ä¸€ä¸ªå¼‚æ­¥ç”Ÿæˆå™¨ (Async Generator)ï¼Œä¸“é—¨é…åˆ FastAPI çš„ StreamingResponse ä½¿ç”¨ã€‚
        
        Yields:
            str: ç¬¦åˆ SSE (Server-Sent Events) æ ¼å¼çš„å­—ç¬¦ä¸²
            æ ¼å¼ç¤ºä¾‹: "data: {...json...}\n\n"
        """
        
        # --- é˜¶æ®µ 1: åˆå§‹åŒ–æ¡æ‰‹ ---
        # å‘Šè¯‰å‰ç«¯ï¼šæˆ‘ä»¬è¦å¼€å§‹å¹²æ´»äº†ï¼Œä¸€å…±æœ‰å¤šå°‘æ­¥ã€‚
        # å‰ç«¯æ”¶åˆ°è¿™ä¸ªåï¼Œå¯ä»¥å…ˆç”»å‡º 5 ä¸ªç°è‰²çš„æ­¥éª¤æ¡ã€‚
        init_payload = {
            "type": "init",
            "timestamp": datetime.now().isoformat(),
            "total_steps": len(self.active_rules),
            "steps_info": [
                {
                    "id": rule['id'],
                    "title": rule['display']['title'],
                    "icon": rule['display']['icon']
                } for rule in self.active_rules
            ]
        }
        yield self._format_sse(init_payload)
        
        # ç¨å¾®åœé¡¿ä¸€ä¸‹ï¼Œç»™å‰ç«¯æ¸²æŸ“åˆå§‹ç•Œé¢çš„æ—¶é—´
        await asyncio.sleep(0.5)

        # æ”¶é›†æœ€ç»ˆçš„é£é™©è®¡æ•°ï¼Œç”¨äºæœ€åç”Ÿæˆæ€»ç»“æŠ¥å‘Š
        risk_count = 0
        risk_details = []

        # --- é˜¶æ®µ 2: é€æ¡è§„åˆ™æ‰§è¡Œå¾ªç¯ ---
        for index, rule in enumerate(self.active_rules):
            rule_id = rule['id']
            rule_name = rule['display']['title']
            
            # 2.1 [çŠ¶æ€æ¨é€] å¼€å§‹å¤„ç†å½“å‰æ­¥éª¤
            # å‰ç«¯æ”¶åˆ°è¿™ä¸ªï¼Œå¯¹åº”çš„æ­¥éª¤æ¡å¼€å§‹è½¬åœˆåœˆ (Loading)
            yield self._format_sse({
                "type": "step_start",
                "rule_id": rule_id,
                "loading_text": rule['display']['loading_text']
            })
            
            # --- æ¨¡æ‹Ÿ AI æ€è€ƒçš„â€œå‘¼å¸æ„Ÿâ€ ---
            # çœŸå®è¯·æ±‚å¯èƒ½å¾ˆå¿«ï¼Œä½†ä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬å¼ºåˆ¶è®©å®ƒè‡³å°‘â€œæ€è€ƒâ€1ç§’
            # è¿™æ ·é¢†å¯¼èƒ½çœ‹æ¸…â€œæ­£åœ¨æ¯”å¯¹å›½å®¶ç¦æ­¢ç›®å½•...â€è¿™å‡ ä¸ªå­—
            start_time = time.time()
            
            # 2.2 [æ ¸å¿ƒé€»è¾‘] æ„å»º Prompt + è°ƒç”¨ LLM
            # è¿™é‡Œæœ€å¥½ç”¨ await å¼‚æ­¥è°ƒç”¨ï¼Œé˜²æ­¢é˜»å¡ä¸»çº¿ç¨‹
            # (æ³¨ï¼šrequests æ˜¯åŒæ­¥çš„ï¼Œå¦‚æœå¹¶å‘é«˜éœ€æ¢ httpxï¼Œä½†æ¼”ç¤ºå¤Ÿç”¨äº†ï¼Œè¿™é‡Œç”¨ asyncio.to_thread åŒ…è£…ä¸€ä¸‹)
            system_prompt = self.prompt_builder.build_system_prompt()
            user_prompt = self.prompt_builder.build_user_prompt(raw_data_context, rule)
            
            # åœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡ŒåŒæ­¥çš„ LLM è°ƒç”¨ï¼Œä¸é˜»å¡ Event Loop
            llm_result = await asyncio.to_thread(
                self.llm_service.call_llm, system_prompt, user_prompt
            )
            
            # è§£æ„ç»“æœï¼š["ç¬¦å·", "ç†ç”±"]
            status_symbol, message = llm_result[0], llm_result[1]
            
            # åˆ¤æ–­æ˜¯å¦é£é™©ï¼ˆx ä¸ºé£é™©ï¼‰
            is_risk = "x" in status_symbol.lower() or "fail" in status_symbol.lower()
            if is_risk:
                risk_count += 1
                risk_details.append(f"{rule_name}: {message}")

            # --- èŠ‚å¥æ§åˆ¶ ---
            # å¦‚æœ LLM å“åº”å¤ªå¿«(<1.5s)ï¼Œå¼ºè¡Œè¡¥è¶³å‰©ä½™æ—¶é—´
            elapsed = time.time() - start_time
            if elapsed < 1.5:
                await asyncio.sleep(1.5 - elapsed)
            
            # 2.3 [çŠ¶æ€æ¨é€] æ¨é€å½“å‰æ­¥éª¤ç»“æœ
            # å‰ç«¯æ”¶åˆ°è¿™ä¸ªï¼Œæ­¥éª¤æ¡åœæ­¢è½¬åœˆï¼Œå˜ç»¿(âˆš)æˆ–å˜çº¢(x)ï¼Œå¹¶å±•å¼€æ–‡å­—
            yield self._format_sse({
                "type": "step_result",
                "rule_id": rule_id,
                "status": "risk" if is_risk else "pass",
                "icon": status_symbol,  # âˆš æˆ– x
                "message": message,
                "color": "red" if is_risk else "green" # è¦†ç›–é»˜è®¤é¢œè‰²
            })
            
            # æ­¥éª¤ä¹‹é—´ç¨å¾®å–˜å£æ°”
            await asyncio.sleep(1)

        # --- é˜¶æ®µ 3: æœ€ç»ˆæ€»ç»“ ---
        # æ‰€æœ‰æ­¥éª¤è·‘å®Œï¼Œç»™å‡ºä¸€ä¸ªæ€»ç»“è®º
        final_conclusion = "âœ… å»ºè®®æ”¾è¡Œï¼šæœªå‘ç°æ˜æ˜¾é£é™©ç‚¹ã€‚"
        final_status = "pass"
        
        if risk_count > 0:
            final_conclusion = f"âš ï¸ å»ºè®®è½¬äººå·¥æŸ¥éªŒï¼šå…±å‘ç° {risk_count} é¡¹é£é™©æŒ‡æ ‡ã€‚\n" + "\n".join(risk_details)
            final_status = "risk"

        yield self._format_sse({
            "type": "complete",
            "final_status": final_status,
            "summary": final_conclusion
        })

    def _format_sse(self, data: dict) -> str:
        """
        æ ¼å¼åŒ–ä¸º Server-Sent Events æ ‡å‡†åè®®å­—ç¬¦ä¸²ã€‚
        æ ¼å¼ï¼šdata: <json_string>\n\n
        """
        return f"data: {json.dumps(data, ensure_ascii=False)}\n\n"

# --- å•å…ƒæµ‹è¯• (Async è¿è¡Œ) ---
if __name__ == "__main__":
    async def test_run():
        orchestrator = RiskAnalysisOrchestrator()
        print("å¼€å§‹æ¨¡æ‹Ÿæµå¼è¾“å‡º...")
        
        # æ¨¡æ‹Ÿä¸€æ®µæ•°æ®
        mock_data = "è´§ç‰©ï¼šåºŸæ—§ç”µæ± ï¼Œå•ä»·ï¼š0.1ç¾å…ƒ"
        
        async for event in orchestrator.analyze_stream(mock_data):
            print(event.strip()) # æ‰“å°å‡ºæ¥çœ‹çœ‹æ ¼å¼å¯¹ä¸å¯¹

    asyncio.run(test_run())


============================================================
æ–‡ä»¶ 10/23: src\core\prompt_builder.py
============================================================

import json
import os
from pathlib import Path

class PromptBuilder:
    def __init__(self, rule_config_path=None):
        """
        åˆå§‹åŒ–ï¼šè®¡ç®—ç»å¯¹è·¯å¾„ï¼Œé¢„å¤‡åŠ è½½è§„åˆ™ã€‚
        """
        # 1. è®¡ç®—é¡¹ç›®æ ¹ç›®å½• (customs_ai_agent)
        # å½“å‰æ–‡ä»¶åœ¨ src/core/prompt_builder.py
        current_dir = Path(__file__).resolve().parent
        self.project_root = current_dir.parent.parent
        
        # 2. è®¾å®š config ç›®å½•è·¯å¾„ (ç”¨äºåç»­åŠ è½½ RAG txt)
        self.config_dir = self.project_root / "config"
        
        # 3. è®¾å®šè§„åˆ™ json è·¯å¾„
        if rule_config_path:
            self.rule_path = Path(rule_config_path)
        else:
            self.rule_path = self.config_dir / "risk_rules.json"

        # åˆå§‹åŒ–é»˜è®¤é…ç½®
        self.config = {"rules": []}
        self.system_role = "ä½ æ˜¯æµ·å…³æŸ¥éªŒåŠ©æ‰‹"
        self.output_requirement = "è¯·è¿”å›JSONæ ¼å¼ç»“æœã€‚"

        # 4. åŠ è½½ä¸»è§„åˆ™æ–‡ä»¶
        self._load_rule_config()

    def _load_rule_config(self):
        """åŠ è½½ JSON é…ç½®æ–‡ä»¶ï¼Œå¸¦å®¹é”™"""
        try:
            print(f"ğŸ“‚ [PromptBuilder] åŠ è½½è§„åˆ™é…ç½®: {self.rule_path}")
            with open(self.rule_path, 'r', encoding='utf-8') as f:
                #åŠ è½½æ–‡ä»¶è§„åˆ™æ–‡ä»¶å†…å®¹ï¼Œå¹¶èµ‹å€¼ç»™å®ä¾‹å˜é‡config
                self.config = json.load(f)
                self.system_role = self.config.get('meta', {}).get('system_role_definition', self.system_role)
                self.output_requirement = self.config.get('global_output_requirement', self.output_requirement)
        except Exception as e:
            print(f"âŒ [PromptBuilder] è§„åˆ™åŠ è½½å¤±è´¥: {e}")
            # ä¿æŒé»˜è®¤ç©ºé…ç½®ï¼Œé˜²æ­¢å´©æºƒ

    def _load_specific_rag_context(self, filename: str) -> str:
        """
        åŠ¨æ€åŠ è½½æŒ‡å®šçš„ RAG .txt æ–‡ä»¶
        """
        if not filename:
            return "æ— "
            
        file_path = self.config_dir / filename
        try:
            # æ¯æ¬¡è¯»å–éƒ½é‡æ–°æ‰“å¼€ï¼Œæ–¹ä¾¿ä½ åœ¨ä¸é‡å¯æœåŠ¡çš„æƒ…å†µä¸‹çƒ­ä¿®æ”¹txtå†…å®¹
            with open(file_path, 'r', encoding='utf-8') as f:
                return f.read()
        except FileNotFoundError:
            print(f"âš ï¸ [PromptBuilder] è­¦å‘Š: æ‰¾ä¸åˆ° RAG æ–‡ä»¶ -> {filename}")
            return "æ— ï¼ˆæœªæ‰¾åˆ°å¯¹åº”çš„å‚è€ƒæŒ‡å¯¼æ–‡ä»¶ï¼‰"
        except Exception as e:
            print(f"âŒ [PromptBuilder] è¯»å– RAG æ–‡ä»¶å‡ºé”™: {e}")
            return "æ— ï¼ˆè¯»å–æ–‡ä»¶å‡ºé”™ï¼‰"

    def build_system_prompt(self):
        return self.system_role

    def build_user_prompt(self, raw_data_context, rule_item):
        """
        ç»„è£…æœ€ç»ˆçš„ Promptï¼šæŒ‡ä»¤ + RAGæ–‡ä»¶å†…å®¹ + æ•°æ®
        """
        instruction = rule_item.get('instruction', '')
        rag_filename = rule_item.get('rag_file')
        
        # åŠ¨æ€åŠ è½½å¯¹åº”çš„ txt å†…å®¹
        rag_content = self._load_specific_rag_context(rag_filename)
        
        prompt = f"""
ã€å®¡æ ¸æŒ‡ä»¤ã€‘
{instruction}

ã€æµ·å…³é«˜çº§å®¡æŸ¥æŒ‡å¯¼æ–‡ä»¶ (å‚è€ƒä¾æ®)ã€‘
è¯·ä¸¥æ ¼ä¾æ®ä»¥ä¸‹æ–‡ä»¶å†…å®¹è¿›è¡Œåˆ¤æ–­ï¼š
================ BEGIN REFERENCE GUIDANCE ================
{rag_content}
================ END REFERENCE GUIDANCE ================

ã€å¾…å®¡æ ¸æŠ¥å…³æ¡ˆå·ã€‘
================ BEGIN DATA ================
{raw_data_context}
================ END DATA ================

ã€è¾“å‡ºè¦æ±‚ã€‘
{self.output_requirement}
"""
        return prompt.strip()

# --- è‡ªæµ‹ä»£ç  ---
if __name__ == "__main__":
    builder = PromptBuilder()
    # æ¨¡æ‹Ÿæµ‹è¯•ä¸€æ¡è§„åˆ™
    mock_rule = {
        "instruction": "æµ‹è¯•æŒ‡ä»¤",
        "rag_file": "rag_r01_basic_info.txt" # ç¡®ä¿ä½ çœŸçš„åˆ›å»ºäº†è¿™ä¸ªæ–‡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥è­¦å‘Š
    }
    print(builder.build_user_prompt("æµ‹è¯•æ•°æ®...", mock_rule))


============================================================
æ–‡ä»¶ 11/23: src\database\connection.py
============================================================

from sqlalchemy.ext.asyncio import create_async_engine, async_sessionmaker
from src.database.models import Base
import os

# 1. è®¾ç½®æ•°æ®åº“æ–‡ä»¶çš„ä½ç½®
# æˆ‘ä»¬æŠŠå®ƒæ”¾åœ¨é¡¹ç›®æ ¹ç›®å½•ä¸‹ï¼Œå« customs_audit.db
# sqlite+aiosqlite:// è¡¨ç¤ºæˆ‘ä»¬è¦ç”¨å¼‚æ­¥çš„æ–¹å¼è¿æ¥ SQLite
DATABASE_URL = "sqlite+aiosqlite:///./customs_audit.db"

# 2. åˆ›å»ºå¼‚æ­¥å¼•æ“ (Engine)
# echo=True è¡¨ç¤ºä¼šåœ¨æ§åˆ¶å°æ‰“å°å‡ºå®ƒæ‰§è¡Œçš„ SQL è¯­å¥ï¼Œæ–¹ä¾¿ä½ è°ƒè¯•å­¦ä¹ 
engine = create_async_engine(DATABASE_URL, echo=False)

# 3. åˆ›å»ºä¼šè¯å·¥å‚ (SessionLocal)
# ä»¥åæ¯æ¬¡è¦æ“ä½œæ•°æ®åº“ï¼Œéƒ½æ‰¾å®ƒè¦ä¸€ä¸ª "session" (ä¼šè¯)
AsyncSessionLocal = async_sessionmaker(bind=engine, expire_on_commit=False)

# 4. åˆå§‹åŒ–æ•°æ®åº“å‡½æ•°
async def init_db():
    """
    ç¨‹åºå¯åŠ¨æ—¶è¿è¡Œä¸€æ¬¡ï¼Œå¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œå°±è‡ªåŠ¨åˆ›å»ºè¡¨
    """
    async with engine.begin() as conn:
        # æŒ‰ç…§ models.py é‡Œçš„å®šä¹‰ï¼Œåˆ›å»ºæ‰€æœ‰è¡¨
        await conn.run_sync(Base.metadata.create_all)
    print("âœ… æ•°æ®åº“è¡¨ç»“æ„åˆå§‹åŒ–å®Œæˆ")


============================================================
æ–‡ä»¶ 12/23: src\database\crud.py
============================================================

from sqlalchemy.ext.asyncio import AsyncSession
from src.database.models import AuditTask, AuditDetail
from datetime import datetime

class AuditRepository:
    """
    ä»“åº“ç±»ï¼šä¸“é—¨è´Ÿè´£æ¬è¿æ•°æ®è¿›å‡ºæ•°æ®åº“
    """
    def __init__(self, db: AsyncSession):
        self.db = db

    async def create_new_task(self, raw_data: str) -> int:
        """
        ç¬¬ä¸€æ­¥ï¼šåœ¨åˆ†æå¼€å§‹å‰ï¼Œå…ˆåˆ›å»ºä¸€ä¸ªä»»åŠ¡è®°å½•
        è¿”å›ï¼šæ–°ä»»åŠ¡çš„ ID
        """
        new_task = AuditTask(
            raw_data=raw_data,
            final_status="PROCESSING", # çŠ¶æ€æ ‡è®°ä¸ºè¿›è¡Œä¸­
            summary="æ­£åœ¨åˆ†æä¸­..."
        )
        self.db.add(new_task)
        await self.db.commit() # æäº¤ä¿å­˜
        await self.db.refresh(new_task) # åˆ·æ–°ï¼Œä¸ºäº†æ‹¿åˆ°è‡ªåŠ¨ç”Ÿæˆçš„ ID
        return new_task.id

    async def save_task_results(self, task_id: int, final_status: str, summary: str, details: list):
        """
        æœ€åä¸€æ­¥ï¼šåˆ†æç»“æŸåï¼Œæ‰¹é‡ä¿å­˜æ‰€æœ‰æ˜ç»†ï¼Œå¹¶æ›´æ–°ä¸»ä»»åŠ¡çŠ¶æ€
        """
        # 1. æ‰¾åˆ°ä¹‹å‰åˆ›å»ºçš„é‚£ä¸ªä»»åŠ¡
        task = await self.db.get(AuditTask, task_id)
        if task:
            # 2. æ›´æ–°ä¸»ä»»åŠ¡çš„ç»“è®º
            task.final_status = final_status
            task.summary = summary
            task.finished_at = datetime.now()

            # 3. æ‰¹é‡æ·»åŠ æ˜ç»† (æŠŠå†…å­˜é‡Œçš„å­—å…¸è½¬æˆæ•°æ®åº“å¯¹è±¡)
            for item in details:
                detail_record = AuditDetail(
                    task_id=task_id,
                    rule_id=item['rule_id'],
                    rule_name=item['rule_name'],
                    is_risk=item['is_risk'],
                    llm_reason=item['reason']
                )
                self.db.add(detail_record)

            # 4. ä¸€æ¬¡æ€§æäº¤æ‰€æœ‰æ›´æ”¹
            await self.db.commit()


============================================================
æ–‡ä»¶ 13/23: src\database\models.py
============================================================

from datetime import datetime
from sqlalchemy import Column, Integer, String, Text, DateTime, Boolean, ForeignKey
from sqlalchemy.orm import DeclarativeBase, relationship

# 1. å®šä¹‰åŸºç±»ï¼Œæ‰€æœ‰æ¨¡å‹éƒ½è¦ç»§æ‰¿å®ƒ
class Base(DeclarativeBase):
    pass

# 2. å®šä¹‰ã€å®¡è®¡ä»»åŠ¡ä¸»è¡¨ã€‘
# è®°å½•ä¸€æ¬¡è¯·æ±‚çš„æ€»ä½“æƒ…å†µï¼šè°æŸ¥çš„ï¼ŸæŸ¥çš„å•¥ï¼Ÿæœ€åç»“æœæ˜¯å•¥ï¼Ÿ
class AuditTask(Base):
    __tablename__ = "audit_tasks"

    id = Column(Integer, primary_key=True, index=True)  # ä»»åŠ¡IDï¼Œè‡ªåŠ¨ç”Ÿæˆ 1, 2, 3...
    raw_data = Column(Text, nullable=False)             # åŸå§‹æŠ¥å…³å•æ–‡æœ¬
    created_at = Column(DateTime, default=datetime.now) # åˆ›å»ºæ—¶é—´
    
    # æœ€ç»ˆç»“è®º (pass/risk)
    final_status = Column(String(50), nullable=True)    
    # æ€»ç»“æ‘˜è¦ (ä¾‹å¦‚: "å»ºè®®è½¬äººå·¥...")
    summary = Column(Text, nullable=True)               

    # å»ºç«‹ä¸å­è¡¨çš„å…³ç³» (æ–¹ä¾¿åç»­æŸ¥è¯¢ï¼Œä»»åŠ¡.details å°±èƒ½æ‹¿åˆ°æ‰€æœ‰æ˜ç»†)
    details = relationship("AuditDetail", back_populates="task")

# 3. å®šä¹‰ã€å®¡è®¡æ˜ç»†è¡¨ã€‘
# è®°å½•è¯¥ä»»åŠ¡ä¸‹ï¼Œæ¯ä¸€æ¡è§„åˆ™å…·ä½“çš„è¿è¡Œç»“æœ
class AuditDetail(Base):
    __tablename__ = "audit_details"

    id = Column(Integer, primary_key=True, index=True)
    
    # å¤–é”®ï¼šå…³è”åˆ°ä¸»è¡¨çš„ id
    task_id = Column(Integer, ForeignKey("audit_tasks.id"))
    
    rule_id = Column(String(50))     # è§„åˆ™ID (å¦‚ R01)
    rule_name = Column(String(100))  # è§„åˆ™åç§° (å¦‚ è¿ç¦å“æ’æŸ¥)
    is_risk = Column(Boolean)        # æ˜¯å¦æœ‰é£é™© (True/False)
    llm_reason = Column(Text)        # AI ç»™å‡ºçš„ç†ç”±
    
    # åå‘å…³è”
    task = relationship("AuditTask", back_populates="details")


============================================================
æ–‡ä»¶ 14/23: src\main.py
============================================================

import sys
import os
from contextlib import asynccontextmanager

# ============================================================
# â¬‡ï¸â¬‡ï¸â¬‡ï¸ ã€æ ¸å¿ƒä¿®å¤ï¼šæ¢å¤è¿™è¡Œä»£ç ï¼ã€‘ â¬‡ï¸â¬‡ï¸â¬‡ï¸
# è¿™è¡Œä»£ç å¿…é¡»åœ¨æ‰€æœ‰ 'from src...' ä¹‹å‰
# ============================================================
sys.path.append(os.path.dirname(os.path.dirname(os.path.abspath(__file__))))

import uvicorn
from fastapi import FastAPI
from fastapi.middleware.cors import CORSMiddleware

# ç°åœ¨ Python èƒ½æ‰¾åˆ°å®ƒä»¬äº†
from src.api.routes import router as api_router
from src.services.chat_agent import CustomsChatAgent
from src.config.loader import settings # ç¡®ä¿è¿™ä¸€è¡Œä¹Ÿèƒ½è¢«æ‰¾åˆ°

# ==========================================
# ğŸš€ ç”Ÿå‘½å‘¨æœŸç®¡ç† (å•ä¾‹æ¨¡å¼çš„æ ¸å¿ƒ)
# ==========================================
@asynccontextmanager
async def lifespan(app: FastAPI):
    print("\nğŸš€ [System] æœåŠ¡æ­£åœ¨å¯åŠ¨ï¼Œåˆå§‹åŒ–å…¨å±€ AI å¼•æ“ (åªè¿è¡Œä¸€æ¬¡)...")
    try:
        # å®ä¾‹åŒ– Agent å¹¶æŒ‚è½½åˆ° app.state ä¸Š
        app.state.agent = CustomsChatAgent()
        print("âœ… [System] å…¨å±€ Agent æŒ‚è½½æˆåŠŸï¼")
    except Exception as e:
        print(f"âŒ [System] Agent åˆå§‹åŒ–å¤±è´¥: {e}")
        app.state.agent = None
    
    yield  # æœåŠ¡è¿è¡Œä¸­...
    
    print("ğŸ›‘ [System] æœåŠ¡æ­£åœ¨å…³é—­...")

# åˆå§‹åŒ– FastAPI åº”ç”¨
app = FastAPI(
    title="Customs AI Risk Agent",
    description="åŸºäºå¤§æ¨¡å‹çš„æµ·å…³æ™ºèƒ½å®¡å•ä¸é£é™©å†³ç­–ç³»ç»Ÿ",
    version="2.1",
    lifespan=lifespan # ç»‘å®šç”Ÿå‘½å‘¨æœŸ
)

# --- è·¨åŸŸé…ç½® (CORS) ---
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_credentials=True,
    allow_methods=["*"],
    allow_headers=["*"],
)

# --- æŒ‚è½½è·¯ç”± ---
app.include_router(api_router, prefix="/api/v1")

if __name__ == "__main__":
    print("ğŸš€ æµ·å…³AIå†³ç­–ç³»ç»Ÿæ­£åœ¨å¯åŠ¨...")
    print("ğŸ“„ API æ–‡æ¡£åœ°å€: http://localhost:8000/docs")
    # æ³¨æ„ï¼šuvicorn.run çš„ç¬¬ä¸€ä¸ªå‚æ•°æ˜¯å­—ç¬¦ä¸² "src.main:app"ï¼Œå®ƒä¼šè‡ªå·±å¤„ç†è·¯å¾„
    uvicorn.run("src.main:app", host="0.0.0.0", port=8000, reload=True)


============================================================
æ–‡ä»¶ 15/23: src\services\__init__.py
============================================================




============================================================
æ–‡ä»¶ 16/23: src\services\chat_agent.py
============================================================

import os
import httpx
import asyncio # å¼•å…¥ asyncio ç”¨äºç»†å¾®æ§åˆ¶
from langchain.agents import create_agent
from langchain_openai import ChatOpenAI
from langchain_core.tools import Tool
from langgraph.checkpoint.memory import InMemorySaver
from langchain_core.messages import HumanMessage, AIMessage, ToolMessage, AIMessageChunk

from src.config.loader import settings

# --- ç¯å¢ƒé…ç½® ---
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
os.environ['HF_HUB_DISABLE_SSL_VERIFY'] = '1'
os.environ['CURL_CA_BUNDLE'] = ''

# çŸ¥è¯†åº“å®¹é”™
try:
    from src.services.knowledge_base import KnowledgeBase
except ImportError:
    KnowledgeBase = None

MEMORY = InMemorySaver()

class CustomsChatAgent:
    def __init__(self):
        print("ğŸ”— [System] åˆå§‹åŒ– Agent...")
        
        # 1. ç½‘ç»œé…ç½®
        proxy_url = settings.HTTP_PROXY if hasattr(settings, 'HTTP_PROXY') and settings.HTTP_PROXY else None
        
        sync_client = httpx.Client(proxy=proxy_url, verify=False, timeout=60.0)
        async_client = httpx.AsyncClient(proxy=proxy_url, verify=False, timeout=60.0)

        # 2. LLM (å¼€å¯æµå¼)
        self.llm = ChatOpenAI(
            model=settings.DEEPSEEK_MODEL,
            api_key=settings.DEEPSEEK_API_KEY,
            base_url=settings.DEEPSEEK_BASE_URL,
            temperature=0.3,
            http_client=sync_client,
            http_async_client=async_client,
            streaming=True
        )

        # 3. å·¥å…·
        tools = []
        self.retriever = None
        if KnowledgeBase:
            try:
                self.kb = KnowledgeBase()
                self.retriever = self.kb.get_retriever()
                
                def retrieve_docs(query: str) -> str:
                    if not self.retriever: return "çŸ¥è¯†åº“ä¸å¯ç”¨ã€‚"
                    try:
                        docs = self.retriever.invoke(query)
                        return "\n\n".join([doc.page_content for doc in docs]) if docs else "æœªæ‰¾åˆ°ã€‚"
                    except Exception as e:
                        return f"æ£€ç´¢é”™: {e}"

                tools.append(Tool(
                    name="search_customs_regulations",
                    func=retrieve_docs,
                    description="æŸ¥è¯¢æµ·å…³æ³•è§„ã€æ”¿ç­–ã€HSç¼–ç æˆ–æŠ¥å…³æµç¨‹ã€‚"
                ))
                print("âœ… çŸ¥è¯†åº“åŠ è½½æˆåŠŸ")
            except: pass
        
        # 4. Agent
        system_prompt = "ä½ æ˜¯ä¸€åæµ·å…³ä¸“å®¶ã€‚é‡åˆ°ä¸šåŠ¡é—®é¢˜å¿…é¡»æŸ¥åº“ã€‚é—²èŠç›´æ¥å›ã€‚"
        self.agent = create_agent(
            model=self.llm,
            tools=tools,
            system_prompt=system_prompt,
            checkpointer=MEMORY,
        )

        if self.retriever:
            try: self.retriever.invoke("warm-up") 
            except: pass

    async def chat_stream(self, user_input: str, session_id: str = "default_session"):
        """
        æœ€ç»ˆæµå¼é€»è¾‘ï¼šå…¼å®¹ DeepSeek æ€è€ƒè¿‡ç¨‹
        """
        try:
            print(f"\nğŸ‘‰ [Request] {user_input}")
            yield f"data: {{\"type\": \"thinking\", \"content\": \"è¿æ¥å»ºç«‹ï¼Œå‡†å¤‡ç”Ÿæˆ...\"}}\n\n"
            
            config = {"configurable": {"thread_id": session_id}}
            has_sent_content = False

            # ä½¿ç”¨ stream_mode="messages"
            async for msg, metadata in self.agent.astream(
                {"messages": [HumanMessage(content=user_input)]},
                config=config,
                stream_mode="messages"
            ):
                # -------------------------------------------------
                # 1. æ•æ‰ AI æ¶ˆæ¯ (åŒ…æ‹¬æ€è€ƒè¿‡ç¨‹ + æ­£æ–‡)
                # -------------------------------------------------
                if isinstance(msg, AIMessageChunk):
                    # --- A. å°è¯•è·å– DeepSeek çš„æ€è€ƒå†…å®¹ (Reasoning) ---
                    # DeepSeek çš„æ€è€ƒå†…å®¹é€šå¸¸åœ¨ additional_kwargs ä¸­
                    reasoning = msg.additional_kwargs.get('reasoning_content', '')
                    if reasoning:
                        # è¿™æ˜¯ä¸€ä¸ªæ€è€ƒç‰‡æ®µ
                        safe_reason = reasoning.replace("\n", "\\n").replace('"', '\\"')
                        # æ¨é€ç»™å‰ç«¯ï¼Œç±»å‹ä¸º 'thinking'
                        # æ³¨æ„ï¼šä¸ºäº†æ‰“å­—æœºæ•ˆæœï¼Œå‰ç«¯ thinking é€»è¾‘éœ€è¦æ”¯æŒè¿½åŠ ï¼Œæˆ–è€…è¿™é‡ŒåªåšçŠ¶æ€æç¤º
                        # è¿™é‡Œæˆ‘ä»¬ç®€åŒ–ï¼Œç›´æ¥æŠŠæ€è€ƒè¿‡ç¨‹ä½œä¸º thinking å‘é€ï¼Œå‰ç«¯ä¼šé—ªçƒæ›´æ–°ï¼Œä½†è¿™è¯æ˜æµå¼é€šäº†
                        yield f"data: {{\"type\": \"thinking\", \"content\": \"{safe_reason}\"}}\n\n"
                    
                    # --- B. å°è¯•è·å–å·¥å…·è°ƒç”¨ (Tool Calls) ---
                    if msg.tool_call_chunks:
                        # åªè¦æœ‰å·¥å…·è°ƒç”¨çš„æ„å›¾ï¼Œå°±å‘ä¸€ä¸ªä¿¡å·ä¿æŒè¿æ¥æ´»è·ƒ
                        yield f"data: {{\"type\": \"thinking\", \"content\": \"æ­£åœ¨è§„åˆ’å·¥å…·è°ƒç”¨...\"}}\n\n"

                    # --- C. æ•æ‰æ­£æ–‡å†…å®¹ (Content) ---
                    if msg.content:
                        has_sent_content = True
                        safe_content = msg.content.replace("\n", "\\n").replace('"', '\\"')
                        yield f"data: {{\"type\": \"answer\", \"content\": \"{safe_content}\"}}\n\n"
                    
                    # å…³é”®ï¼šæ‰‹åŠ¨è®©å‡ºæ§åˆ¶æƒï¼Œé˜²æ­¢ asyncio å¾ªç¯è¿‡ç´§å¯¼è‡´ buffer
                    await asyncio.sleep(0)

                # -------------------------------------------------
                # 2. æ•æ‰å·¥å…·æ‰§è¡Œç»“æœ
                # -------------------------------------------------
                elif isinstance(msg, ToolMessage):
                    print(f"âœ… å·¥å…· {msg.name} è¿”å›")
                    yield f"data: {{\"type\": \"thinking\", \"content\": \"æŸ¥è¯¢å®Œæ¯•ï¼Œæ­£åœ¨æ•´ç†...\"}}\n\n"

            # -------------------------------------------------
            # 3. ä¿åº•
            # -------------------------------------------------
            if not has_sent_content:
                print("âš ï¸ å¯ç”¨ä¿åº•...")
                state = await self.agent.aget_state(config)
                if state.values.get("messages"):
                    last = state.values["messages"][-1]
                    if isinstance(last, AIMessage) and last.content:
                        safe = last.content.replace("\n", "\\n").replace('"', '\\"')
                        yield f"data: {{\"type\": \"answer\", \"content\": \"{safe}\"}}\n\n"

        except Exception as e:
            print(f"âŒ Error: {e}")
            yield f"data: {{\"type\": \"error\", \"content\": \"{str(e)}\"}}\n\n"




============================================================
æ–‡ä»¶ 17/23: src\services\data_client.py
============================================================

import requests
import urllib.parse
from src.config.loader import settings

class DataClient:
    def __init__(self):
        self.base_url = settings.DATA_PLATFORM_URL
        # æ–¹è´µçŸ³æä¾›çš„ API è·¯å¾„æ˜ å°„
        self.endpoints = {
            "get_declaration": "/api/custom/get_declaration_detail/" 
        }

    def fetch_declaration_text(self, entry_id: str) -> str:
        """
        å¯¹å¤–æš´éœ²çš„ä¸»æ–¹æ³•ï¼šæ ¹æ®å•å·è·å–æ•°æ®ï¼Œå¹¶è¿”å›æ ¼å¼åŒ–åçš„æ–‡æœ¬ã€‚
        """
        # 1. å°è¯•ä»çœŸå®æ¥å£è·å– JSON
        data = self._fetch_from_api(entry_id)
        
        # 2. å¦‚æœæ¥å£æŒ‚äº†æˆ–è€…æ²¡æ•°æ®ï¼Œä¸ºäº†æ¼”ç¤ºæ•ˆæœï¼Œæˆ‘ä»¬ä½¿ç”¨ Mock æ•°æ®å…œåº•
        # (åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒå¯ä»¥å»æ‰è¿™ä¸ª Mock)
        if not data:
            print(f"âš ï¸ [DataClient] æœªèƒ½ä»å¹³å°è·å–æ•°æ®ï¼Œå¯ç”¨ Mock æ¨¡å¼æ¼”ç¤º: {entry_id}")
            data = self._get_mock_data(entry_id)
            if not data:
                return None # çœŸçš„æ²¡æ•‘äº†

        # 3. å°† JSON è½¬æ¢ä¸º AI æ˜“è¯»çš„æ–‡æœ¬æ ¼å¼
        return self._format_as_text(data)

    def _fetch_from_api(self, entry_id: str):
        """å†…éƒ¨æ–¹æ³•ï¼šæ‰§è¡Œ HTTP è¯·æ±‚"""
        try:
            # æ‹¼æ¥ URL
            url = f"{self.base_url.rstrip('/')}{self.endpoints['get_declaration']}"
            # å‘èµ·è¯·æ±‚ (è®¾ç½® 2 ç§’è¶…æ—¶ï¼Œé˜²æ­¢å¡æ­»)
            response = requests.get(url, params={"entry_id": entry_id}, timeout=2)
            
            if response.status_code == 200:
                result = response.json()
                # å‡è®¾æ–¹è´µçŸ³è¿”å›çš„æ˜¯ { "code": 200, "data": {...} }
                # è¿™é‡Œæ ¹æ®å®é™…æƒ…å†µè°ƒæ•´
                return result if isinstance(result, dict) else None
            return None
        except Exception as e:
            print(f"âŒ [DataClient] è¿æ¥æ•°æ®å¹³å°å¤±è´¥: {e}")
            return None

    def _format_as_text(self, data: dict) -> str:
        """
        ã€æ ¸å¿ƒé€»è¾‘ã€‘æ¨¡æ¿å¼•æ“ï¼šå°†ç»“æ„åŒ–æ•°æ®è½¬ä¸ºè‡ªç„¶è¯­è¨€æ–‡æœ¬
        """
        # é˜²æ­¢å­—æ®µç¼ºå¤±æŠ¥é”™ï¼Œä½¿ç”¨ .get()
        text = f"""æŠ¥å…³å•å·ï¼š{data.get('entry_id', 'æœªçŸ¥')}
å¢ƒå†…æ”¶è´§äººï¼š{data.get('consignee_cname', 'æœªçŸ¥å•ä½')}
è´§ç‰©åç§°ï¼š{data.get('goods_name', 'æœªçŸ¥è´§ç‰©')}
HSç¼–ç ï¼š{data.get('hs_code', 'æœªçŸ¥')}
æ•°é‡ï¼š{data.get('qty', 0)} {data.get('qty_unit', 'ä¸ª')}
å•ä»·ï¼š{data.get('unit_price', 0)} {data.get('currency', 'USD')}
æ€»ä»·ï¼š{data.get('total_price', 0)} {data.get('currency', 'USD')}
åŸäº§å›½ï¼š{data.get('origin_country', 'æœªçŸ¥')}
å“ç‰Œï¼š{data.get('brand', 'æ— ')}
ç”³æŠ¥è¦ç´ ï¼š
{data.get('elements', 'æ— ç”³æŠ¥è¦ç´ ä¿¡æ¯')}

ã€éšé™„å•è¯ä¿¡æ¯ã€‘
ï¼ˆç³»ç»Ÿè‡ªåŠ¨æ£€ç´¢ï¼šå·²å…³è”å‘ç¥¨ä¸è£…ç®±å•ï¼‰
1. å•†ä¸šå‘ç¥¨ï¼šé‡‘é¢ {data.get('total_price', 0)} {data.get('currency', 'USD')}
2. è£…ç®±å•ï¼šæ¯›é‡ {data.get('gross_weight', 0)} KG / å‡€é‡ {data.get('net_weight', 0)} KG
"""
        return text

    def _get_mock_data(self, entry_id: str):
        """æœ¬åœ°æ¨¡æ‹Ÿæ•°æ®ï¼Œç¡®ä¿æ¼”ç¤ºæ—¶æœ‰ä¸œè¥¿å¯æŸ¥"""
        if entry_id == "530120250001":
            return {
                "entry_id": "530120250001",
                "consignee_cname": "æ·±åœ³æ·±å—ç”µå­ç§‘æŠ€æœ‰é™å…¬å¸",
                "goods_name": "32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨(IC)",
                "hs_code": "85423100",
                "qty": "5000",
                "qty_unit": "ä¸ª",
                "unit_price": "15.00",
                "total_price": "75000.00",
                "currency": "USD",
                "origin_country": "é©¬æ¥è¥¿äºš",
                "brand": "TI",
                "gross_weight": "55.0",
                "net_weight": "50.0",
                "elements": "1.å“åï¼š32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼›2.å“ç‰Œï¼šTIï¼›3.å‹å·ï¼šTMS320F28335PGFAï¼›4.åŠŸèƒ½ï¼šç”¨äºå·¥ä¸šç”µæœºæ§åˆ¶ï¼›5.å°è£…å½¢å¼ï¼šLQFPã€‚"
            }
        return None


============================================================
æ–‡ä»¶ 18/23: src\services\knowledge_base.py
============================================================

import os
import shutil
from pathlib import Path
from langchain_community.document_loaders import TextLoader, DirectoryLoader
from langchain_text_splitters import RecursiveCharacterTextSplitter
from langchain_huggingface import HuggingFaceEmbeddings
from langchain_community.vectorstores import FAISS

class KnowledgeBase:
    def __init__(self):
        # 1. å®šä¹‰ç»å¯¹è·¯å¾„
        # __file__ æ˜¯å½“å‰è„šæœ¬æ–‡ä»¶çš„è·¯å¾„
        # .parent.parent.parent å›é€€ä¸‰å±‚æ‰¾åˆ°é¡¹ç›®æ ¹ç›®å½•
        self.base_dir = Path(__file__).resolve().parent.parent.parent
        self.data_path = self.base_dir / "data" / "knowledge"
        
        # å‘é‡æ•°æ®åº“æœ€ç»ˆä¿å­˜ç›®å½•
        self.vector_db_path = self.base_dir / "config" / "faiss_index_local"
        
        # ç¡®ä¿ç›®å½•å­˜åœ¨
        self.vector_db_path.mkdir(parents=True, exist_ok=True)

        print(f"âš™ï¸ [KnowledgeBase] åˆå§‹åŒ–æœ¬åœ° Embedding æ¨¡å‹ (all-MiniLM-L6-v2)...")
        self.embeddings = HuggingFaceEmbeddings(
            model_name="all-MiniLM-L6-v2",
            model_kwargs={'device': 'cpu'},
            encode_kwargs={'normalize_embeddings': True}
        )

        # åŠ è½½æˆ–é‡å»ºç´¢å¼•
        self.vector_store = self._load_or_create_index()

    def _load_or_create_index(self):
        # æ£€æŸ¥ç´¢å¼•æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        index_file = self.vector_db_path / "index.faiss"
        
        if index_file.exists():
            print("ğŸ“‚ [KnowledgeBase] åŠ è½½æœ¬åœ°å‘é‡ç´¢å¼• (Hit Cache)...")
            try:
                return FAISS.load_local(
                    str(self.vector_db_path), 
                    self.embeddings,
                    allow_dangerous_deserialization=True 
                )
            except Exception as e:
                print(f"âš ï¸ ç´¢å¼•æ–‡ä»¶æŸåï¼Œæ­£åœ¨é‡å»º: {e}")
                return self._create_index()
        else:
            print("âš™ï¸ [KnowledgeBase] æœ¬åœ°æ— ç´¢å¼•ï¼Œæ­£åœ¨é‡å»ºå‘é‡æ•°æ®åº“...")
            return self._create_index()

    def _create_index(self):
        if not self.data_path.exists():
            print(f"âš ï¸ æ•°æ®ç›®å½•ä¸å­˜åœ¨: {self.data_path}ï¼Œå°†åˆ›å»ºç©ºç´¢å¼•ã€‚")
            return FAISS.from_texts(["åˆå§‹åŒ–ç©ºç™½æ–‡æ¡£"], self.embeddings)

        # 1. åŠ è½½æ–‡æ¡£
        loaders = [
            DirectoryLoader(str(self.data_path), glob="**/*.txt", loader_cls=TextLoader, loader_kwargs={"encoding": "utf-8"}),
            DirectoryLoader(str(self.data_path), glob="**/*.md", loader_cls=TextLoader, loader_kwargs={"encoding": "utf-8"}),
        ]
        
        documents = []
        for loader in loaders:
            try:
                documents.extend(loader.load())
            except Exception as e:
                print(f"âš ï¸ åŠ è½½æ–‡ä»¶å‡ºé”™: {e}")

        if not documents:
            print("âš ï¸ æœªæ‰¾åˆ°æ–‡æ¡£ï¼Œåˆ›å»ºç©ºç´¢å¼•ã€‚")
            return FAISS.from_texts(["æ— æ•°æ®"], self.embeddings)

        # 2. åˆ‡åˆ†æ–‡æ¡£
        text_splitter = RecursiveCharacterTextSplitter(chunk_size=500, chunk_overlap=50)
        chunks = text_splitter.split_documents(documents)
        print(f"ğŸ“„ æ­£åœ¨å‘é‡åŒ– {len(chunks)} ä¸ªæ–‡æœ¬ç‰‡æ®µ...")

        # 3. åˆ›å»ºå‘é‡åº“ (å†…å­˜ä¸­)
        vector_store = FAISS.from_documents(chunks, self.embeddings)

        # 4. ä¿å­˜åˆ°æœ¬åœ° (ã€â­ æ ¸å¿ƒä¿®å¤ï¼šå…ˆå­˜ä¸´æ—¶ç›®å½•ï¼Œå†æ¬è¿ã€‘)
        try:
            # å®šä¹‰ä¸€ä¸ªçº¯è‹±æ–‡ã€æ— ç©ºæ ¼çš„ä¸´æ—¶ç›®å½•å
            temp_dir_name = "temp_faiss_build"
            temp_path = self.base_dir / temp_dir_name
            
            # å¦‚æœä¸Šæ¬¡å¼‚å¸¸é€€å‡ºæ®‹ç•™äº†ä¸´æ—¶ç›®å½•ï¼Œå…ˆåˆ æ‰
            if temp_path.exists():
                shutil.rmtree(temp_path)

            # A. ä¿å­˜åˆ°ä¸´æ—¶ç›®å½• (FAISS å¯¹è¿™é‡Œçš„è·¯å¾„å¾ˆæ»¡æ„)
            # æ³¨æ„ï¼šsave_local æ¥å—çš„æ˜¯æ–‡ä»¶å¤¹è·¯å¾„å­—ç¬¦ä¸²
            vector_store.save_local(temp_dir_name)

            # B. æ¬è¿æ–‡ä»¶åˆ°ç›®æ ‡ç›®å½• (Python å¤„ç†ä¸­æ–‡è·¯å¾„å¾ˆå¼º)
            # å…ˆæ¸…ç©ºç›®æ ‡ç›®å½•
            if self.vector_db_path.exists():
                shutil.rmtree(self.vector_db_path)
            self.vector_db_path.mkdir(parents=True, exist_ok=True)

            # ç§»åŠ¨æ–‡ä»¶ (index.faiss å’Œ index.pkl)
            for file_name in os.listdir(temp_dir_name):
                src_file = temp_path / file_name
                dst_file = self.vector_db_path / file_name
                shutil.move(str(src_file), str(dst_file))

            # C. åˆ é™¤ä¸´æ—¶ç›®å½•
            shutil.rmtree(temp_path)

            print(f"ğŸ’¾ ç´¢å¼•å·²æˆåŠŸæ„å»ºå¹¶ä¿å­˜è‡³: {self.vector_db_path}")
        except Exception as e:
            print(f"âŒ ä¿å­˜ç´¢å¼•å¤±è´¥ (ä¸å½±å“æœ¬æ¬¡è¿è¡Œï¼Œä½†ä¸‹æ¬¡éœ€é‡å»º): {e}")
        
        return vector_store

    def get_retriever(self):
        return self.vector_store.as_retriever(search_kwargs={"k": 3})


============================================================
æ–‡ä»¶ 19/23: src\services\llm_service.py
============================================================

import json
import re
import requests
import urllib3
import time
from requests.adapters import HTTPAdapter
from urllib3.util.retry import Retry
from typing import List
from src.config.loader import settings 

# ç¦ç”¨ SSL è­¦å‘Š
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

class LLMService:
    def __init__(self):
        self.session = requests.Session()
        
        # 1. åº•å±‚è¿æ¥é‡è¯• (é’ˆå¯¹ Connection Reset / æ–­ç½‘)
        retry_strategy = Retry(
            total=3,
            backoff_factor=1, # å¢åŠ é—´éš”
            status_forcelist=[500, 502, 504], # æ³¨æ„ï¼š503 æˆ‘ä»¬æ‰‹åŠ¨å¤„ç†ï¼Œä¸åœ¨è¿™é‡Œå¤„ç†
            allowed_methods=["POST"],
            raise_on_status=False
        )
        adapter = HTTPAdapter(max_retries=retry_strategy)
        self.session.mount("https://", adapter)
        self.session.mount("http://", adapter)

        if settings.HTTP_PROXY or settings.HTTPS_PROXY:
            self.session.proxies = {
                "http": settings.HTTP_PROXY,
                "https": settings.HTTPS_PROXY
            }

    def call_llm(self, system_prompt: str, user_prompt: str) -> List[str]:
        api_url = (
            f"https://generativelanguage.googleapis.com/v1beta/models/"
            f"{settings.MODEL_NAME}:generateContent?key={settings.GOOGLE_API_KEY}"
        )

        payload = {
            "contents": [{
                "parts": [{"text": f"{system_prompt}\n\n{user_prompt}"}]
            }],
            "safetySettings": [
                {"category": "HARM_CATEGORY_HARASSMENT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_HATE_SPEECH", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_SEXUALLY_EXPLICIT", "threshold": "BLOCK_NONE"},
                {"category": "HARM_CATEGORY_DANGEROUS_CONTENT", "threshold": "BLOCK_NONE"}
            ],
            "generationConfig": {
                "temperature": 0.1,
                "maxOutputTokens": 8192 
            }
        }

        # 2. é€»è¾‘å±‚é‡è¯• (ä¸“é—¨é’ˆå¯¹ 503 Overloaded)
        max_retries = 3
        
        for attempt in range(max_retries + 1):
            try:
                # å‘é€è¯·æ±‚
                response = self.session.post(api_url, json=payload, timeout=60, verify=False)
                
                # å¦‚æœæ˜¯ 503 (Overloaded)ï¼Œæˆ‘ä»¬éœ€è¦ä¼‘æ¯ä¸€ä¸‹å†è¯•
                if response.status_code == 503:
                    if attempt < max_retries:
                        sleep_time = (attempt + 1) * 2  # ç­‰å¾… 2s, 4s, 6s...
                        print(f"âš ï¸ GoogleæœåŠ¡å™¨å¿™ (503)ï¼Œæ­£åœ¨è¿›è¡Œç¬¬ {attempt+1} æ¬¡é‡è¯• (ç­‰å¾… {sleep_time}s)...")
                        time.sleep(sleep_time)
                        continue # è·³è¿‡å½“å‰å¾ªç¯ï¼Œé‡è¯•
                    else:
                        return ["x", "GoogleæœåŠ¡å™¨è¿‡è½½ (Overloaded)ï¼Œå·²é‡è¯•å¤šæ¬¡å¤±è´¥ã€‚"]

                # å¦‚æœæ˜¯å…¶ä»–é”™è¯¯ç  (400, 403 ç­‰)ï¼Œç›´æ¥æŠ¥é”™ä¸é‡è¯•
                if response.status_code != 200:
                    return ["x", f"HTTPé”™è¯¯ {response.status_code}: {response.text}"]

                result_json = response.json()

                # æ£€æŸ¥æ•°æ®æœ‰æ•ˆæ€§
                if 'candidates' not in result_json:
                    return ["x", f"Googleè¿”å›å¼‚å¸¸: {json.dumps(result_json)}"]
                
                # é’ˆå¯¹ Preview æ¨¡å‹ "åªæ€è€ƒä¸è¯´è¯" çš„ Bug é˜²å¾¡
                try:
                    raw_text = result_json['candidates'][0]['content']['parts'][0]['text']
                except KeyError:
                     finish_reason = result_json['candidates'][0].get('finishReason', 'UNKNOWN')
                     if finish_reason == "STOP":
                         # å¦‚æœä¹Ÿæ˜¯è¿™ç§æƒ…å†µï¼Œä¹Ÿå¯ä»¥é‡è¯•
                         if attempt < max_retries:
                             print(f"âš ï¸ æ¨¡å‹æœªè¾“å‡ºå†…å®¹ (Bug)ï¼Œé‡è¯•ä¸­...")
                             time.sleep(1)
                             continue
                         return ["x", "æ¨¡å‹æ€è€ƒåæœªè¾“å‡ºå†…å®¹"]
                     return ["x", f"è§£æå¤±è´¥: {json.dumps(result_json)}"]

                # æˆåŠŸæ‹¿åˆ°æ–‡æœ¬ï¼Œé€€å‡ºå¾ªç¯å¹¶è§£æ
                return self._parse_json_response(raw_text)

            except Exception as e:
                # å¦‚æœæ˜¯æ–­ç½‘ç­‰åº•å±‚é”™è¯¯ï¼Œåº•å±‚ Adapter å·²ç»é‡è¯•è¿‡äº†ï¼Œè¿™é‡Œç›´æ¥æŠ¥é”™
                return ["x", f"è¿æ¥ä¸­æ–­: {str(e)}"]

        return ["x", "æœªçŸ¥é”™è¯¯"]

    def _parse_json_response(self, raw_text: str) -> List[str]:
        # ... (ä¿æŒä¸å˜) ...
        clean_text = raw_text.strip()
        match = re.search(r'\[.*?\]', clean_text, re.DOTALL)
        if match:
            clean_text = match.group(0)
        
        try:
            parsed = json.loads(clean_text)
            if isinstance(parsed, list) and len(parsed) >= 2:
                return [str(parsed[0]), str(parsed[1])]
            return ["x", f"AIæ ¼å¼é”™è¯¯: {clean_text}"]
        except:
            if "âˆš" in clean_text or "pass" in clean_text.lower():
                return ["âˆš", clean_text.replace('"', '').replace('[', '').replace(']', '')]
            return ["x", f"æ— æ³•è§£æJSON: {clean_text}"]


============================================================
æ–‡ä»¶ 20/23: test_stream.py
============================================================

import os
from openai import OpenAI

# 1. é…ç½®ï¼ˆå’Œä½ çš„ .env ä¿æŒä¸€è‡´ï¼‰
os.environ['https_proxy'] = 'http://127.0.0.1:7890' # ä½ çš„ä»£ç†ç«¯å£
api_key = "sk-714a19818dac43f89b638e8f8422da0e"
base_url = "https://api.deepseek.com"

print("ğŸš€ å¼€å§‹æµ‹è¯•åŸç”Ÿ OpenAI æµå¼è¿æ¥...")

client = OpenAI(api_key=api_key, base_url=base_url)

try:
    response = client.chat.completions.create(
        model="deepseek-chat",
        messages=[
            {"role": "system", "content": "You are a helpful assistant"},
            {"role": "user", "content": "ä½ å¥½ï¼Œè¯·å¸®æˆ‘å†™ä¸€æ®µ300å­—çš„ç§‘å¹»å°è¯´å¼€å¤´ã€‚"},
        ],
        stream=True # å¼€å¯æµå¼
    )

    print("âœ… è¿æ¥æˆåŠŸï¼Œå‡†å¤‡æ¥æ”¶æ•°æ®...\n")
    print("-" * 20)
    
    for chunk in response:
        # DeepSeek çš„æ€è€ƒå†…å®¹é€šå¸¸åœ¨è¿™é‡Œ
        if hasattr(chunk.choices[0].delta, 'reasoning_content'):
            r_content = chunk.choices[0].delta.reasoning_content
            if r_content:
                print(f"[æ€è€ƒ] {r_content}", end="", flush=True)
        
        # æ­£å¼å†…å®¹åœ¨è¿™é‡Œ
        content = chunk.choices[0].delta.content
        if content:
            print(content, end="", flush=True)
            
    print("\n" + "-" * 20)
    print("\nâœ… æµ‹è¯•ç»“æŸ")

except Exception as e:
    print(f"\nâŒ æµ‹è¯•å¤±è´¥: {e}")


============================================================
æ–‡ä»¶ 21/23: web\app.js
============================================================




============================================================
æ–‡ä»¶ 22/23: web\index.html
============================================================

<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æµ·å…³æ™ºèƒ½æŠ¥å…³å†³ç­–ç³»ç»Ÿ v2.1</title>
    <!-- 1. æ ·å¼åº“ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- 2. Markdown æ¸²æŸ“å¼•æ“ -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* --- æ ¸å¿ƒä¸»é¢˜ --- */
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        
        /* --- éœ“è™¹ç‰¹æ•ˆ --- */
        .neon-border { box-shadow: 0 0 10px rgba(56, 189, 248, 0.3); transition: all 0.3s ease; border: 1px solid rgba(56, 189, 248, 0.2); }
        .neon-border:focus-within { box-shadow: 0 0 20px rgba(56, 189, 248, 0.6); border-color: #38bdf8; }

        /* --- å®¡å•æ¨¡å—ï¼šå‘¼å¸åŠ¨ç”» --- */
        @keyframes breathe {
            0% { opacity: 0.4; box-shadow: 0 0 5px #3b82f6; }
            50% { opacity: 1; box-shadow: 0 0 20px #3b82f6; border-color: #60a5fa; }
            100% { opacity: 0.4; box-shadow: 0 0 5px #3b82f6; }
        }
        .status-thinking { animation: breathe 1.5s infinite ease-in-out; border: 1px solid #3b82f6; background-color: rgba(59, 130, 246, 0.1); }

        /* --- å®¡å•æ¨¡å—ï¼šç»“æœå¡ç‰‡ --- */
        .step-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); border-left: 4px solid transparent; }
        .step-card.pending { border-left-color: #475569; opacity: 0.5; }
        .step-card.pass { border-left-color: #22c55e; background: rgba(34, 197, 94, 0.1); opacity: 1; }
        .step-card.risk { border-left-color: #ef4444; background: rgba(239, 68, 68, 0.1); opacity: 1; }

        /* --- æ»šåŠ¨æ¡ç¾åŒ– --- */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }

        /* --- ä¾§è¾¹æ äº¤äº’ --- */
        .nav-active { background-color: #1e293b; color: #38bdf8; border-left: 3px solid #38bdf8; }

        /* --- æŠ¥å‘Šæ¨¡å—ï¼šæ–‡æ¡£æ ·å¼ --- */
        .report-content h1 { font-size: 1.5rem; font-weight: bold; color: #38bdf8; margin-bottom: 1rem; border-bottom: 1px solid #334155; padding-bottom: 0.5rem; }
        .report-content h2 { font-size: 1.1rem; font-weight: bold; color: #e2e8f0; margin-top: 1.5rem; margin-bottom: 0.5rem; }
        .report-content p { margin-bottom: 0.8rem; line-height: 1.6; color: #94a3b8; }
        .report-content ul { list-style-type: disc; padding-left: 1.5rem; margin-bottom: 1rem; color: #cbd5e1; }
        .report-content strong { color: #f59e0b; }
        .report-content blockquote { border-left: 4px solid #3b82f6; padding-left: 1rem; color: #64748b; font-style: italic; background: rgba(59, 130, 246, 0.05); padding: 10px; margin: 10px 0; border-radius: 4px; }

        /* --- å¯¹è¯æ¨¡å—ï¼šèŠå¤©æ°”æ³¡ & æµå¼çŠ¶æ€ --- */
        .chat-bubble {
            max-width: 85%;
            padding: 12px 16px;
            border-radius: 16px;
            font-size: 0.95rem;
            position: relative;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .chat-thinking {
            padding: 8px 15px;
            color: #94a3b8;
            font-size: 0.9rem;
            font-style: italic;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* AI æ°”æ³¡å¸¦ä¸€ä¸ªå°å°¾å·´ */
        .chat-ai {
            background-color: #334155;
            border-bottom-left-radius: 4px;
        }
        /* ç”¨æˆ·æ°”æ³¡å¸¦ä¸€ä¸ªå°å°¾å·´ */
        .chat-user {
            background-color: #0ea5e9;
            border-bottom-right-radius: 4px;
        }
    </style>
</head>

<body class="h-screen flex overflow-hidden">

    <!-- ================= ä¾§è¾¹å¯¼èˆªæ  ================= -->
    <nav class="w-16 bg-slate-900 border-r border-slate-700 flex flex-col items-center py-4 z-20 gap-2 shrink-0">
        <div class="mb-4 text-cyan-400">
            <i class="fa-solid fa-shield-halved text-2xl"></i>
        </div>
        
        <button onclick="switchModule('audit')" id="nav-audit" class="nav-active w-full h-16 flex flex-col items-center justify-center text-slate-400 hover:text-cyan-400 transition-colors">
            <i class="fa-solid fa-file-contract text-xl mb-1"></i>
            <span class="text-[10px]">å®¡å•</span>
        </button>

        <button onclick="switchModule('chat')" id="nav-chat" class="w-full h-16 flex flex-col items-center justify-center text-slate-400 hover:text-cyan-400 transition-colors">
            <i class="fa-solid fa-comments text-xl mb-1"></i>
            <span class="text-[10px]">å’¨è¯¢</span>
        </button>

        <button onclick="switchModule('report')" id="nav-report" class="w-full h-16 flex flex-col items-center justify-center text-slate-400 hover:text-cyan-400 transition-colors">
            <i class="fa-solid fa-file-signature text-xl mb-1"></i>
            <span class="text-[10px]">å»ºè®®</span>
        </button>
    </nav>

    <!-- ================= ä¸»ä½“å†…å®¹åŒº ================= -->
    <div class="flex-1 flex flex-col min-w-0">
        
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <header class="h-16 bg-slate-900 border-b border-slate-700 flex items-center px-6 justify-between shadow-lg shrink-0">
            <div>
                <h1 class="text-xl font-bold tracking-wider text-white">SMART CUSTOMS AGENT</h1>
                <p class="text-xs text-slate-400">æ™ºæ…§å£å²¸è‡ªåŠ¨åŒ–æŠ¥å…³è¾…åŠ©å†³ç­–ç³»ç»Ÿ v2.1 (LangChain Edition)</p>
            </div>
            <div class="flex gap-4 text-sm text-slate-300">
                <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-green-500"></div> ç³»ç»Ÿåœ¨çº¿</span>
                <span class="flex items-center gap-2"><div class="w-2 h-2 rounded-full bg-blue-500"></div> deepseek </span>
            </div>
        </header>

        <!-- ================= æ¨¡å— A: æ™ºèƒ½å®¡å• (Core Engine) ================= -->
        <div id="module-audit" class="flex-1 flex overflow-hidden module-content">
            <!-- å·¦æ  -->
            <div class="w-1/3 bg-slate-800/50 border-r border-slate-700 p-6 flex flex-col min-w-[300px]">
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-lg font-semibold text-cyan-400"><i class="fa-solid fa-file-import mr-2"></i>æŠ¥å…³å•æ®å½•å…¥</h2>
                    </div>
                    <!-- æ•°æ®æŸ¥è¯¢æ  -->
                    <div class="flex gap-2">
                        <div class="relative flex-1">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <i class="fa-solid fa-search text-slate-500"></i>
                            </div>
                            <input type="text" id="searchInput" 
                                class="w-full bg-slate-900 border border-slate-600 text-slate-300 text-sm rounded focus:ring-1 focus:ring-blue-500 focus:border-blue-500 block pl-10 p-2 placeholder-slate-600" 
                                placeholder="è¾“å…¥å•å· (ä¾‹: 530120250001)"
                                onkeydown="if(event.keyCode==13) searchDeclaration()">
                        </div>
                        <button onclick="searchDeclaration()" id="searchBtn" class="px-3 py-2 bg-slate-700 hover:bg-slate-600 text-white rounded text-xs border border-slate-600 transition">æŸ¥è¯¢</button>
                    </div>
                </div>

                <!-- å¿«æ·æ ·æœ¬æŒ‰é’® -->
                <div class="grid grid-cols-2 gap-2 mb-4">
                    <button onclick="loadSample('sample10')" class="text-xs py-2 bg-green-600/20 border border-green-600 hover:bg-green-600/40 text-green-300 rounded transition font-bold">âœ… 10.å®Œç¾æœºæ¢°</button>
                    <button onclick="loadSample('sample7')" class="text-xs py-2 bg-green-600/20 border border-green-600 hover:bg-green-600/40 text-green-300 rounded transition font-bold">âœ… 7.å…è´¹æ ·å“</button>
                    <button onclick="loadSample('sample1')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 1.å½’ç±»æ¬ºè¯ˆ</button>
                    <button onclick="loadSample('sample2')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 2.æ´‹åƒåœ¾</button>
                    <button onclick="loadSample('sample3')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 3.é‡é‡è¯¯å·®</button>
                    <button onclick="loadSample('sample4')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 4.è¦ç´ æ¨¡ç³Š</button>
                    <button onclick="loadSample('sample5')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 5.ä»·æ ¼æ´—é’±</button>
                    <button onclick="loadSample('sample6')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 6.æ¿’å±çº¢æœ¨</button>
                    <button onclick="loadSample('sample8')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 8.ä¸¤ç”¨ç‰©é¡¹</button>
                    <button onclick="loadSample('sample9')" class="text-xs py-1 bg-red-900/30 border border-red-800 hover:bg-red-900/50 text-red-300 rounded transition">âŒ 9.å¸åˆ¶é”™è¯¯</button>
                </div>

                <!-- å¤§æ–‡æœ¬æ¡† -->
                <div class="flex-1 relative neon-border rounded overflow-hidden bg-slate-900">
                    <textarea id="rawDataInput" class="w-full h-full bg-transparent text-slate-300 p-4 font-mono text-sm resize-none focus:outline-none" placeholder="åœ¨æ­¤ç²˜è´´ OCR è¯†åˆ«ç»“æœã€JSON æ•°æ®æˆ–æŠ¥å…³å•æ–‡æœ¬..."></textarea>
                </div>

                <button id="startBtn" onclick="startAnalysis()" class="mt-4 w-full py-3 bg-gradient-to-r from-cyan-600 to-blue-600 hover:from-cyan-500 hover:to-blue-500 text-white font-bold rounded shadow-lg transform transition hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-rocket"></i> å¼€å§‹æ™ºèƒ½ç ”åˆ¤
                </button>
            </div>

            <!-- å³æ ï¼šæ¨ç†æµ -->
            <div class="flex-1 bg-slate-900 p-6 overflow-y-auto relative">
                <div class="max-w-4xl mx-auto">
                    <h2 class="text-lg font-semibold text-cyan-400 mb-6 flex items-center">
                        <i class="fa-solid fa-microchip mr-2"></i>AI å†³ç­–æ¨ç†æµ
                        <span id="statusTag" class="ml-4 text-xs px-2 py-0.5 rounded bg-slate-700 text-slate-400 hidden">åˆ†æä¸­...</span>
                    </h2>
                    
                    <!-- æ­¥éª¤å¡ç‰‡å®¹å™¨ -->
                    <div id="stepsContainer" class="space-y-4 min-h-[500px] flex flex-col justify-center items-center transition-all duration-500">
                        <!-- é»˜è®¤å¾…æœºçŠ¶æ€ (ç›¾ç‰ŒåŠ¨ç”») -->
                        <div class="text-center group cursor-default select-none">
                            <div class="relative inline-block">
                                <div class="absolute -inset-4 bg-cyan-500/20 rounded-full blur-xl group-hover:bg-cyan-500/30 transition-all duration-500"></div>
                                <i class="fa-solid fa-shield-halved text-8xl text-slate-700/50 relative z-10 group-hover:text-cyan-500/80 transition-all duration-500 animate-pulse"></i>
                                <i class="fa-solid fa-lock text-3xl text-slate-800 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20"></i>
                            </div>
                            <h3 class="mt-8 text-2xl font-bold text-slate-600 tracking-widest group-hover:text-cyan-400 transition-colors">SYSTEM READY</h3>
                            <p class="mt-2 text-sm text-slate-500 group-hover:text-slate-400 transition-colors">ç­‰å¾…æ•°æ®å½•å…¥ Â· å®‰å…¨å¼•æ“å¾…å‘½</p>
                        </div>
                    </div>

                    <!-- æœ€ç»ˆç»“æœ -->
                    <div id="finalResult" class="mt-8 hidden"></div>
                </div>
            </div>
        </div>

        <!-- ================= æ¨¡å— B: æ™ºèƒ½å’¨è¯¢ (LangChain Agent) ================= -->
        <div id="module-chat" class="flex-1 hidden flex flex-col h-full bg-slate-900 module-content overflow-hidden relative">
            
            <!-- èŠå¤©è®°å½•åŒºåŸŸ -->
            <div id="chatHistory" class="flex-1 overflow-y-auto p-6 flex flex-col gap-4 scroll-smooth pb-24">
                <!-- æ¬¢è¿è¯­ -->
                <div class="flex justify-start">
                    <div class="chat-bubble chat-ai shadow-lg">
                        <div class="flex items-center gap-2 mb-2 text-cyan-400 font-bold">
                            <i class="fa-solid fa-robot"></i> æ³•è§„å’¨è¯¢åŠ©æ‰‹
                        </div>
                        ğŸ‘‹ æ‚¨å¥½ï¼æˆ‘å¯ä»¥å¸®æ‚¨æŸ¥è¯¢å†…éƒ¨æ³•è§„æˆ–å›ç­”ä¸šåŠ¡é—®é¢˜ã€‚<br>
                        <span class="text-xs text-slate-400 mt-2 block">åŸºäº RAG çŸ¥è¯†åº“ + DeepSeek-V3</span>
                    </div>
                </div>
            </div>

            <!-- è¾“å…¥åŒºåŸŸ (å›ºå®šåœ¨åº•éƒ¨) -->
            <div class="absolute bottom-0 w-full bg-slate-800/90 backdrop-blur border-t border-slate-700 p-4 z-10">
                <div class="max-w-4xl mx-auto flex gap-3 items-end">
                    <div class="flex-1 bg-slate-900 border border-slate-600 rounded-xl p-2 focus-within:border-cyan-500 focus-within:ring-1 focus-within:ring-cyan-500 transition-all">
                        <textarea id="chatInput" rows="1"
                            class="w-full bg-transparent text-slate-300 px-2 py-1 text-sm focus:outline-none resize-none max-h-32"
                            placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜... (Shift+Enter æ¢è¡Œ)"
                            onkeydown="if(event.keyCode==13 && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                    </div>
                    
                    <button onclick="sendMessage()" id="sendBtn" class="w-10 h-10 bg-cyan-600 hover:bg-cyan-500 text-white rounded-full flex items-center justify-center transition shadow-lg shrink-0 mb-1">
                        <i class="fa-solid fa-paper-plane text-sm"></i>
                    </button>
                </div>
            </div>
        </div>

        <!-- ================= æ¨¡å— C: æ™ºèƒ½å»ºè®®ä¹¦ (Reporter) ================= -->
        <div id="module-report" class="flex-1 hidden flex overflow-hidden module-content">
            <!-- å·¦ä¾§ï¼šä¸Šä¸‹æ–‡å½•å…¥ -->
            <div class="w-1/3 bg-slate-800/50 border-r border-slate-700 p-6 flex flex-col min-w-[300px]">
                <h2 class="text-lg font-semibold text-green-400 mb-4">
                    <i class="fa-solid fa-wand-magic-sparkles mr-2"></i>ç”Ÿæˆä¼˜åŒ–å»ºè®®
                </h2>
                
                <div class="mb-4 text-xs text-slate-400 flex justify-between items-center">
                    <p>è¯·è¾“å…¥æŠ¥å…³ä¸Šä¸‹æ–‡</p>
                    <button onclick="importFromAudit()" class="px-3 py-1 bg-slate-700 hover:bg-slate-600 text-cyan-400 rounded border border-slate-600 transition flex items-center gap-1 cursor-pointer">
                        <i class="fa-solid fa-clone"></i> å¼•ç”¨â€œå®¡å•â€æ•°æ®
                    </button>
                </div>

                <div class="flex-1 relative neon-border rounded overflow-hidden bg-slate-900">
                    <textarea id="reportContextInput" class="w-full h-full bg-transparent text-slate-300 p-4 font-mono text-sm resize-none focus:outline-none" placeholder="æ­¤å¤„è¾“å…¥å¾…åˆ†æçš„æ•°æ®æˆ–é£é™©ç‚¹..."></textarea>
                </div>

                <button onclick="generateReport()" id="genReportBtn" class="mt-4 w-full py-3 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-500 hover:to-emerald-500 text-white font-bold rounded shadow-lg transform transition hover:scale-[1.02] active:scale-95 flex justify-center items-center gap-2">
                    <i class="fa-solid fa-file-pen"></i> ç”ŸæˆæŠ¥å…³å»ºè®®ä¹¦
                </button>
            </div>

            <!-- å³ä¾§ï¼šæŠ¥å‘Šé¢„è§ˆ -->
            <div class="flex-1 bg-slate-900 p-8 overflow-y-auto">
                <div class="max-w-4xl mx-auto bg-slate-800/30 p-10 rounded-lg border border-slate-700 min-h-full shadow-2xl">
                    <!-- å ä½ç¬¦ -->
                    <div id="reportPlaceholder" class="h-full flex flex-col items-center justify-center text-slate-600 opacity-50 py-20">
                        <i class="fa-solid fa-file-lines text-6xl mb-4"></i>
                        <p>ç­‰å¾…ç”ŸæˆæŠ¥å‘Š...</p>
                    </div>
                    
                    <!-- æŠ¥å‘Šå†…å®¹ (Markdown æ¸²æŸ“åŒº) -->
                    <div id="reportContent" class="report-content hidden"></div>
                </div>
            </div>
        </div>

    </div>

    <!-- ================= æ ¸å¿ƒè„šæœ¬é€»è¾‘ ================= -->
    <script>
        // API é…ç½®
        const API_URL = 'http://localhost:8000/api/v1/analyze';
        const QUERY_URL = 'http://localhost:8000/api/v1/query/declaration/'; 
        const CHAT_URL = 'http://localhost:8000/api/v1/chat';

        // ç”Ÿæˆä¸€ä¸ªå”¯ä¸€ ID ä½œä¸ºä¼šè¯ Session ID (ç”¨äº Agent è®°å¿†)
        const SESSION_ID = 'session-' + Date.now();
        
        // --- æ¨¡å—åˆ‡æ¢é€»è¾‘ ---
        function switchModule(moduleName) {
            document.querySelectorAll('.module-content').forEach(el => el.classList.add('hidden'));
            document.getElementById(`module-${moduleName}`).classList.remove('hidden');
            
            // ä¾§è¾¹æ é«˜äº®
            document.querySelectorAll('nav button').forEach(btn => btn.classList.remove('nav-active'));
            document.getElementById(`nav-${moduleName}`).classList.add('nav-active');
            
            // ç¡®ä¿èŠå¤©è®°å½•åŒºåœ¨åˆ‡æ¢å›æ¥æ—¶æ»šåŠ¨åˆ°åº•éƒ¨
            if (moduleName === 'chat') {
                const historyEl = document.getElementById('chatHistory');
                historyEl.scrollTop = historyEl.scrollHeight;
            }
        }

        // --- [æ¨¡å—A] æ ¸å¿ƒå®¡å•é€»è¾‘ (ä¿æŒä¸å˜) ---
        const SAMPLES = {
            normal: `æŠ¥å…³å•å·ï¼š530120250001\nå¢ƒå†…æ”¶è´§äººï¼šæ·±åœ³æ·±å—ç”µå­ç§‘æŠ€æœ‰é™å…¬å¸\nè´§ç‰©åç§°ï¼š32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨(IC)\nHSç¼–ç ï¼š85423100\næ•°é‡ï¼š5000ä¸ª\nå•ä»·ï¼š15.00 USD\næ€»ä»·ï¼š75000.00 USD\nå¸åˆ¶ï¼šç¾å…ƒ\næ¯›é‡ï¼š55.0 KG\nå‡€é‡ï¼š50.0 KG\nåŸäº§å›½ï¼šé©¬æ¥è¥¿äºš\nå“ç‰Œï¼šTI (å¾·å·ä»ªå™¨)\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼š32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼›\n  2.å“ç‰Œï¼šTIï¼›\n  3.å‹å·ï¼šTMS320F28335PGFAï¼›\n  4.åŠŸèƒ½ï¼šç”¨äºå·¥ä¸šç”µæœºæ§åˆ¶ï¼›\n  5.å°è£…å½¢å¼ï¼šLQFPã€‚\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\n1. å•†ä¸šå‘ç¥¨(Invoice No. INV-2025001)ï¼š\n   - é‡‘é¢åˆè®¡ï¼š75000.00 USD\n   - è´¸æ˜“æ¡æ¬¾ï¼šCIF Shenzhen\n2. è£…ç®±å•(Packing List)ï¼š\n   - è´§ç‰©æ•°é‡ï¼š5000 PCS\n   - æ¯›é‡ï¼š55.0 KG\n   - å‡€é‡ï¼š50.0 KG`,
            risk: `æŠ¥å…³å•å·ï¼š530120250099\nå¢ƒå†…æ”¶è´§äººï¼šXXå•†è´¸è¡Œ\nè´§ç‰©åç§°ï¼šæ—§ç¬”è®°æœ¬ç”µè„‘ï¼ˆæ‹†è§£ç”¨ï¼‰\nHSç¼–ç ï¼š84713010\næ•°é‡ï¼š200å°\nå•ä»·ï¼š5.00 USD\næ€»ä»·ï¼š1000.00 USD\nåŸäº§å›½ï¼šæœªçŸ¥\nå¤‡æ³¨ï¼šå±å¹•ç ´æŸï¼Œé”®ç›˜ç¼ºå¤±\néšé™„å•è¯ï¼šå‘ç¥¨é‡‘é¢ 1000 USD`,
            sample10: `æŠ¥å…³å•å·ï¼šTEST-010\nè´§ç‰©åç§°ï¼šå…¨è‡ªåŠ¨è´´ç‰‡æœº\nHSç¼–ç ï¼š84798962\næ•°é‡ï¼š1 å°\nå•ä»·ï¼š150,000.00 USD\næ€»ä»·ï¼š150,000.00 USD\næ¯›é‡ï¼š1200.0 KG\nå‡€é‡ï¼š1150.0 KG\nå“ç‰Œï¼šPanasonic\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šå…¨è‡ªåŠ¨è´´ç‰‡æœºï¼›\n  2.å“ç‰Œï¼šPanasonicï¼›\n  3.å‹å·ï¼šNPM-D3Aï¼›\n  4.åŠŸèƒ½ï¼šç”¨äºPCBç”µè·¯æ¿å…ƒä»¶è´´è£…ï¼›\n  5.åŸç†ï¼šé€šè¿‡å¸å˜´å¸å–å…ƒä»¶æ”¾ç½®äºPCBæ¿ã€‚\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\nå‘ç¥¨ INV-998877:\n   - é‡‘é¢ï¼š150,000.00 USD\nè£…ç®±å• PL-998877:\n   - æ¯›é‡ï¼š1200.0 KG\n   - å‡€é‡ï¼š1150.0 KG`,
            sample1: `æŠ¥å…³å•å·ï¼šTEST-001\nè´§ç‰©åç§°ï¼šDJI Mavic 3 Pro èˆªæ‹é£è¡Œå™¨\nHSç¼–ç ï¼š95030039 (å…¶ä»–ç¼©å¾®æ¨¡å‹/ç©å…·)\næ•°é‡ï¼š100å°\nå•ä»·ï¼š1800.00 USD\næ€»ä»·ï¼š180000.00 USD\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šèˆªæ‹é£è¡Œå™¨ï¼›2.æè´¨ï¼šå¡‘æ–™ï¼›3.å“ç‰Œï¼šDJIï¼›4.å‹å·ï¼šMavic 3 Proã€‚\nã€éšé™„å•è¯ã€‘\nå‘ç¥¨æ€»é¢ï¼š180,000 USD`,
            sample2: `æŠ¥å…³å•å·ï¼šTEST-002\nè´§ç‰©åç§°ï¼šæ··åˆåºŸå¡‘æ–™ï¼ˆæœªåˆ†æ‹£ï¼‰\nå¤‡æ³¨ï¼šSecondary Raw Material (å†ç”ŸåŸæ–™)ï¼Œå·¥å‚åº“å­˜æ¸…ç†ï¼Œå«å°‘é‡æ±¡æ¸ã€‚\nHSç¼–ç ï¼š39159090\næ•°é‡ï¼š20 å¨\nå•ä»·ï¼š50.00 USD/å¨\næ€»ä»·ï¼š1000.00 USD\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šå†ç”Ÿå¡‘æ–™é¢—ç²’ï¼›2.æ¥æºï¼šå·¥ä¸šå›æ”¶ã€‚\nã€éšé™„å•è¯ã€‘\nå‘ç¥¨æ˜¾ç¤ºï¼šUnsorted Plastic Scraps`,
            sample3: `æŠ¥å…³å•å·ï¼šTEST-003\nè´§ç‰©åç§°ï¼šæ£‰ç»‡ç‰©\nHSç¼–ç ï¼š52081100\næ•°é‡ï¼š1000 ç±³\næ¯›é‡ï¼š500.0 KG\nå‡€é‡ï¼š480.0 KG\næ€»ä»·ï¼š2000.00 USD\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\n1. è£…ç®±å•ï¼š\n   - æ¯›é‡ï¼š510.0 KG\n   - å‡€é‡ï¼š490.0 KG\n   - æ•°é‡ï¼š1000 Meters`,
            sample4: `æŠ¥å…³å•å·ï¼šTEST-004\nè´§ç‰©åç§°ï¼šæ±½è½¦é¿éœ‡å™¨\nHSç¼–ç ï¼š87088090\næ•°é‡ï¼š200 ä¸ª\nå•ä»·ï¼š30.00 USD\nå“ç‰Œï¼šOEM\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šæ±½è½¦é¿éœ‡å™¨ï¼›\n  2.å“ç‰Œï¼šOEMï¼›\n  3.å‹å·ï¼šé€šç”¨å‹ï¼›\n  4.é€‚ç”¨è½¦å‹ï¼šå¤šæ¬¾è½¦å‹ã€‚\nã€éšé™„å•è¯ã€‘\nå‘ç¥¨é‡‘é¢ä¸€è‡´ã€‚`,
            sample5: `æŠ¥å…³å•å·ï¼šTEST-005\nè´§ç‰©åç§°ï¼šå¡‘æ–™åœ†ç ç¬”\nHSç¼–ç ï¼š96081000\næ•°é‡ï¼š5000 æ”¯\nå•ä»·ï¼š100.00 USD\næ€»ä»·ï¼š500,000.00 USD\nåŸäº§å›½ï¼šè¶Šå—\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šåœ†ç ç¬”ï¼›2.å“ç‰Œï¼šæ— åï¼›3.æè´¨ï¼šå¡‘æ–™ã€‚`,
            sample6: `æŠ¥å…³å•å·ï¼šTEST-006\nè´§ç‰©åç§°ï¼šå®æœ¨å‰ä»–\nHSç¼–ç ï¼š92029000\næ•°é‡ï¼š10 æŠŠ\nå•ä»·ï¼š3000.00 USD\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šå‰ä»–ï¼›\n  2.é¢æ¿æè´¨ï¼šäº‘æ‰ï¼›\n  3.èƒŒä¾§æ¿æè´¨ï¼šå·´è¥¿ç«ç‘°æœ¨ (Dalbergia nigra)ã€‚\nã€éšé™„å•è¯ã€‘\næœªæä¾›CITESè¯æ˜æ–‡ä»¶ã€‚`,
            sample7: `æŠ¥å…³å•å·ï¼šTEST-007\nè´§ç‰©åç§°ï¼šç”·å¼çš®é‹ï¼ˆå±•ä¼šæ ·å“ï¼‰\nHSç¼–ç ï¼š64039900\næ•°é‡ï¼š2 åŒ\nå•ä»·ï¼š0.00 USD (Free Sample)\næ€»ä»·ï¼š0.00 USD\nè´¸æ˜“æ–¹å¼ï¼šè´§æ ·å¹¿å‘Šå“\nç”³æŠ¥è¦ç´ ï¼š1.å“åï¼šçš®é‹ï¼›2.å“ç‰Œï¼šNIKEï¼›3.æè´¨ï¼šç‰›çš®ã€‚\nå¤‡æ³¨ï¼šä»…ä¾›è¿›åšä¼šå±•ç¤ºï¼Œéé”€å”®ï¼Œå±•ç¤ºåå¤è¿å‡ºå¢ƒã€‚`,
            sample8: `æŠ¥å…³å•å·ï¼šTEST-008\nè´§ç‰©åç§°ï¼šT800çº§ç¢³çº¤ç»´é¢„æµ¸æ–™\nHSç¼–ç ï¼š68151000\næ•°é‡ï¼š500 KG\nå•ä»·ï¼š200.00 USD\nç”³æŠ¥è¦ç´ ï¼š\n  1.å“åï¼šç¢³çº¤ç»´ï¼›\n  2.æ‹‰ä¼¸å¼ºåº¦ï¼š5.8 GPaï¼›\n  3.ç”¨é€”ï¼šèˆªç©ºèˆªå¤©éƒ¨ä»¶ã€‚\nã€éšé™„å•è¯ã€‘\næœªæåŠä¸¤ç”¨ç‰©é¡¹è®¸å¯è¯ã€‚`,
            sample9: `æŠ¥å…³å•å·ï¼šTEST-009\nè´§ç‰©åç§°ï¼šLEDæ˜¾ç¤ºå±\næ€»ä»·ï¼š10,000.00 USD\nã€éšé™„å•è¯ä¿¡æ¯ã€‘\nå•†ä¸šå‘ç¥¨ï¼š\n   - æ€»é‡‘é¢ï¼š10,000.00 EUR\n   - è´¸æ˜“æ¡æ¬¾ï¼šFOB`
        };

        function loadSample(type) {
            const data = SAMPLES[type] || SAMPLES['normal']; 
            document.getElementById('rawDataInput').value = data;
        }

        async function searchDeclaration() {
            const input = document.getElementById('searchInput');
            const btn = document.getElementById('searchBtn');
            const entryId = input.value.trim();
            if (!entryId) { alert("è¯·è¾“å…¥å•å·ï¼"); return; }
            const originalBtnContent = btn.innerHTML;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i>';
            btn.disabled = true;
            input.disabled = true;
            try {
                const response = await fetch(QUERY_URL + entryId);
                if (response.status === 404) { alert("æœªæ‰¾åˆ°è¯¥æŠ¥å…³å•æ•°æ®ï¼Œè¯·æ£€æŸ¥å•å·ã€‚"); }
                else if (response.ok) {
                    const resJson = await response.json();
                    const textarea = document.getElementById('rawDataInput');
                    textarea.value = resJson.text;
                    textarea.parentElement.classList.add('neon-border');
                    setTimeout(() => textarea.parentElement.classList.remove('neon-border'), 1000);
                } else { alert("æŸ¥è¯¢æœåŠ¡å¼‚å¸¸ï¼Œè¯·ç¨åå†è¯•ã€‚"); }
            } catch (e) { console.error(e); alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼è¯·æ£€æŸ¥åç«¯æ˜¯å¦å¯åŠ¨ã€‚"); }
            finally { btn.innerHTML = 'æŸ¥è¯¢'; btn.disabled = false; input.disabled = false; input.focus(); }
        }

        async function startAnalysis() {
            const rawData = document.getElementById('rawDataInput').value;
            if (!rawData.trim()) { alert("è¯·è¾“å…¥æŠ¥å…³æ•°æ®ï¼"); return; }
            const container = document.getElementById('stepsContainer');
            const finalDiv = document.getElementById('finalResult');
            const btn = document.getElementById('startBtn');
            const statusTag = document.getElementById('statusTag');
            
            // æ¸…é™¤å¾…æœºåŠ¨ç”»ï¼Œæ¢å¤åˆ—è¡¨å¸ƒå±€
            container.innerHTML = ''; 
            container.classList.remove('justify-center', 'items-center', 'min-h-[500px]');
            
            finalDiv.innerHTML = '';
            finalDiv.classList.add('hidden');
            btn.disabled = true;
            btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> ç ”åˆ¤è¿›è¡Œä¸­...';
            statusTag.classList.remove('hidden');

            try {
                const response = await fetch(API_URL, {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ raw_data: rawData })
                });
                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';
                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    const chunk = decoder.decode(value, { stream: true });
                    buffer += chunk;
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop(); 
                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try { const data = JSON.parse(line.substring(6)); handleEvent(data); }
                            catch (e) { console.error("JSON Parse Error", e); }
                        }
                    }
                }
            } catch (e) { console.error(e); alert("è¿æ¥æœåŠ¡å™¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åå°å·²å¯åŠ¨ï¼"); }
            finally { btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-rocket"></i> å¼€å§‹æ™ºèƒ½ç ”åˆ¤'; statusTag.classList.add('hidden'); }
        }

        function handleEvent(data) {
            const container = document.getElementById('stepsContainer');
            switch (data.type) {
                case 'init':
                    container.innerHTML = data.steps_info.map(step => `
                        <div id="step-${step.id}" class="step-card pending bg-slate-800 rounded p-4 flex items-start gap-4 border border-slate-700">
                            <div class="w-10 h-10 rounded bg-slate-700 flex items-center justify-center text-slate-400 icon-box"><i class="fa-solid fa-${step.icon}"></i></div>
                            <div class="flex-1"><h3 class="font-bold text-slate-200 text-sm">${step.title}</h3><p class="text-xs text-slate-500 mt-1 msg-box">ç­‰å¾…æ£€æŸ¥...</p></div>
                            <div class="status-icon text-slate-600"><i class="fa-regular fa-circle"></i></div>
                        </div>`).join('');
                    break;
                case 'step_start':
                    const stepEl = document.getElementById(`step-${data.rule_id}`);
                    if (stepEl) {
                        stepEl.classList.remove('pending'); stepEl.classList.add('status-thinking');
                        stepEl.querySelector('.msg-box').innerText = data.loading_text; stepEl.querySelector('.msg-box').classList.add('text-blue-400');
                        stepEl.querySelector('.icon-box').classList.add('bg-blue-900', 'text-blue-300'); stepEl.querySelector('.status-icon').innerHTML = '<i class="fa-solid fa-spinner fa-spin text-blue-500"></i>';
                    } break;
                case 'step_result':
                    const resEl = document.getElementById(`step-${data.rule_id}`);
                    if (resEl) {
                        resEl.classList.remove('status-thinking'); resEl.querySelector('.msg-box').classList.remove('text-blue-400');
                        const isPass = data.status === 'pass'; resEl.classList.add(isPass ? 'pass' : 'risk');
                        resEl.querySelector('.msg-box').innerText = data.message;
                        resEl.querySelector('.status-icon').innerHTML = isPass ? '<i class="fa-solid fa-circle-check text-green-500 text-lg"></i>' : '<i class="fa-solid fa-triangle-exclamation text-red-500 text-lg"></i>';
                        if (!isPass) resEl.querySelector('.msg-box').classList.add('text-red-300');
                    } break;
                case 'complete':
                    const finalDiv = document.getElementById('finalResult'); finalDiv.classList.remove('hidden');
                    const isSafe = data.final_status === 'pass';
                    finalDiv.innerHTML = `<div class="p-6 rounded-lg border ${isSafe ? 'border-green-500/50 bg-green-500/10' : 'border-red-500/50 bg-red-500/10'} text-center shadow-lg"><i class="fa-solid ${isSafe ? 'fa-shield-check text-green-500' : 'fa-triangle-exclamation text-red-500'} text-5xl mb-4"></i><h3 class="text-2xl font-bold ${isSafe ? 'text-green-400' : 'text-red-400'}">${isSafe ? 'ç ”åˆ¤é€šè¿‡' : 'å‘ç°é£é™©'}</h3><p class="mt-2 text-slate-300 whitespace-pre-line text-left bg-slate-900/50 p-4 rounded">${data.summary}</p></div>`;
                    document.querySelector('#module-audit .overflow-y-auto').scrollTop = 9999; break;
            }
        }

        // --- [æ¨¡å—B] å’¨è¯¢é€»è¾‘ ---
        async function sendMessage() {
            const inputEl = document.getElementById('chatInput');
            const historyEl = document.getElementById('chatHistory');
            const sendBtn = document.getElementById('sendBtn');
            const msg = inputEl.value.trim();
            
            if (!msg) return;

            // 1. åˆ›å»ºç”¨æˆ·æ¶ˆæ¯ (ä½¿ç”¨ DOM æ“ä½œè€Œé innerHTML)
            const userBubble = document.createElement('div');
            userBubble.className = 'chat-bubble chat-user'; 
            userBubble.innerText = msg;
            
            const userContainer = document.createElement('div');
            userContainer.className = 'flex justify-end'; 
            userContainer.appendChild(userBubble);
            historyEl.appendChild(userContainer);

            // æ¸…ç©ºè¾“å…¥æ¡†
            inputEl.value = '';
            historyEl.scrollTop = historyEl.scrollHeight;

            // 2. åˆ›å»ºæ€è€ƒå ä½ç¬¦
            const thinkingEl = document.createElement('div');
            thinkingEl.className = 'chat-thinking';
            thinkingEl.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ™ºèƒ½ä½“æ­£åœ¨åˆ†æé—®é¢˜...';
            historyEl.appendChild(thinkingEl);
            
            // 3. åˆ›å»º AI å›å¤æ°”æ³¡ (åˆå§‹éšè—)
            const aiContainer = document.createElement('div');
            aiContainer.className = 'flex justify-start'; 
            
            const aiBubble = document.createElement('div');
            aiBubble.className = 'chat-bubble chat-ai hidden'; 
            
            aiContainer.appendChild(aiBubble);
            historyEl.appendChild(aiContainer);

            // è‡ªåŠ¨æ»šåŠ¨
            historyEl.scrollTop = historyEl.scrollHeight;

            // å˜é‡å‡†å¤‡
            let fullResponseText = ""; 
            sendBtn.disabled = true; // ç¦ç”¨å‘é€æŒ‰é’®

            try {
                // ã€æ ¸å¿ƒä¿®æ”¹ã€‘è¯·æ±‚ä¸­æºå¸¦ session_id
                const response = await fetch(CHAT_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: msg, session_id: SESSION_ID }) // ä¼ å…¥ session_id
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;
                    
                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (line.startsWith('data: ')) {
                            try {
                                const jsonStr = line.substring(6).trim();
                                if (!jsonStr) continue;
                                
                                const data = JSON.parse(jsonStr);

                                if (data.type === 'thinking') {
                                    // æ›´æ–°æ€è€ƒçŠ¶æ€ (DOM å¼•ç”¨ä¾ç„¶æœ‰æ•ˆ)
                                    thinkingEl.innerHTML = `<i class="fa-solid fa-microchip text-cyan-500 mr-2"></i> ${data.content}`;
                                    historyEl.scrollTop = historyEl.scrollHeight;
                                } else if (data.type === 'answer') {
                                    // éšè—æ€è€ƒï¼Œæ˜¾ç¤ºæ°”æ³¡
                                    thinkingEl.style.display = 'none';
                                    aiBubble.classList.remove('hidden');
                                    
                                    // ã€æ ¸å¿ƒã€‘ç´¯åŠ æ–‡æœ¬å¹¶æ¸²æŸ“ Markdown
                                    fullResponseText += data.content; 
                                    aiBubble.innerHTML = marked.parse(fullResponseText);
                                    
                                    // è‡ªåŠ¨æ»šåŠ¨
                                    historyEl.scrollTop = historyEl.scrollHeight;
                                } else if (data.type === 'error') {
                                    thinkingEl.style.display = 'none';
                                    aiBubble.classList.remove('hidden');
                                    aiBubble.classList.add('text-red-400', 'bg-red-900/20', 'border-red-500/50');
                                    aiBubble.innerHTML = `**[ç³»ç»Ÿé”™è¯¯]** ${data.content}`;
                                    historyEl.scrollTop = historyEl.scrollHeight;
                                }

                            } catch (e) { 
                                console.error("JSON Parse Error", e);
                            }
                        }
                    }
                }
            } catch (e) {
                console.error(e);
                thinkingEl.innerHTML = `<span class="text-red-400"><i class="fa-solid fa-triangle-exclamation"></i> è¿æ¥è¶…æ—¶æˆ–æœåŠ¡å¼‚å¸¸</span>`;
            } finally {
                sendBtn.disabled = false; // é‡æ–°å¯ç”¨å‘é€æŒ‰é’®
            }
        }

        // --- [æ¨¡å—C] æŠ¥å‘Šé€»è¾‘ (ä¿æŒä¸å˜) ---
        function importFromAudit() {
            const rawData = document.getElementById('rawDataInput').value;
            const resultDiv = document.getElementById('finalResult');
            let riskContext = "";
            if (!resultDiv.classList.contains('hidden')) { riskContext = "\n\nã€é£é™©ç ”åˆ¤ç³»ç»Ÿç»“è®ºã€‘\n" + resultDiv.innerText; }
            if (!rawData && !riskContext) { alert("å®¡å•æ¨¡å—æš‚æ— æ•°æ®å¯å¼•ç”¨ï¼"); return; }
            document.getElementById('reportContextInput').value = "ã€åŸå§‹æŠ¥å…³æ•°æ®ã€‘\n" + rawData + riskContext;
        }

        async function generateReport() {
            const context = document.getElementById('reportContextInput').value;
            if (!context.trim()) { alert("è¯·è¾“å…¥ä¸Šä¸‹æ–‡ï¼"); return; }
            const btn = document.getElementById('genReportBtn');
            const placeholder = document.getElementById('reportPlaceholder');
            const contentDiv = document.getElementById('reportContent');

            btn.disabled = true; btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> æ­£åœ¨è°ƒç”¨ LangChain ç”Ÿæˆ...';
            placeholder.classList.add('hidden'); contentDiv.classList.remove('hidden');
            contentDiv.innerHTML = '<div class="animate-pulse text-cyan-500">æ­£åœ¨åˆ†æä¸Šä¸‹æ–‡é€»è¾‘...</div>';

            setTimeout(() => {
                const mockMarkdown = `# ğŸ“‘ è¿›å‡ºå£è´§ç‰©åˆè§„å»ºè®®ä¹¦\n\n**ç”Ÿæˆæ—¶é—´**: ${new Date().toLocaleString()}  \n**åˆ†æå¼•æ“**: LangChain RAG Agent\n\n---\n\n## 1. æ ¸å¿ƒé£é™©æ‘˜è¦\næ ¹æ®æä¾›çš„æŠ¥å…³æ•°æ®ï¼Œç³»ç»Ÿæ£€æµ‹åˆ°ä»¥ä¸‹**å…³é”®åˆè§„é£é™©**ï¼š\n- **HSç¼–ç å½’ç±»å­˜ç–‘**ï¼šç”³æŠ¥ä¸º *85423100* (å¤„ç†å™¨)ï¼Œä½†æè¿°ä¸­ç¼ºä¹å…·ä½“çš„å‹å·å‚æ•°ã€‚\n- **å•è¯ä¸ç¬¦**ï¼šå‘ç¥¨é‡‘é¢ä¸æŠ¥å…³å•æ€»ä»·å­˜åœ¨å·®å¼‚ã€‚\n\n## 2. ä¼˜åŒ–å¡«æŠ¥å»ºè®®\nä¸ºäº†ç¡®ä¿é¡ºåˆ©é€šå…³ï¼Œå»ºè®®å¯¹ç”³æŠ¥è¦ç´ è¿›è¡Œå¦‚ä¸‹ä¿®æ­£ï¼š\n\n### A. è¡¥å……ç”³æŠ¥è¦ç´ \nè¯·åœ¨â€œè§„æ ¼å‹å·â€æ ç›®ä¸­ï¼ŒæŒ‰ç…§ã€Šè§„èŒƒç”³æŠ¥ç›®å½•ã€‹è¡¥å……ä»¥ä¸‹ä¿¡æ¯ï¼š\n> **å»ºè®®å¡«å†™èŒƒä¾‹**ï¼š\n> 32ä½æ•°å­—ä¿¡å·å¤„ç†å™¨ï¼›TIå“ç‰Œï¼›å‹å·TMS320F28335ï¼›ç”¨äºå·¥ä¸šæ§åˆ¶ï¼›LQFPå°è£…ã€‚\n\n### B. æ ¸å¯¹å•è¯é‡‘é¢\nå»ºè®®è”ç³»å‘è´§äººé‡æ–°ç¡®è®¤ **Invoice No. INV-2025001** çš„æœ€ç»ˆé‡‘é¢ã€‚\n* å½“å‰ç”³æŠ¥ï¼š75,000.00 USD\n* å»ºè®®æ ¸æŸ¥ï¼šæ˜¯å¦åŒ…å«éè´¸æ˜“æ€§è´¹ç”¨ï¼ˆå¦‚æ¨¡å…·è´¹ã€è½¯ä»¶è´¹ï¼‰ã€‚\n\n## 3. åˆè§„å£°æ˜\n> æœ¬æŠ¥å‘Šç”± AI è¾…åŠ©ç”Ÿæˆï¼Œä»…ä¾›å‚è€ƒï¼Œæœ€ç»ˆç”³æŠ¥è¯·ä»¥æµ·å…³ç°åœºæŒ‡ä»¤ä¸ºå‡†ã€‚`;
                contentDiv.innerHTML = marked.parse(mockMarkdown);
                btn.disabled = false; btn.innerHTML = '<i class="fa-solid fa-file-pen"></i> é‡æ–°ç”Ÿæˆ';
            }, 2000);
        }
    </script>
</body>
</html>


============================================================
æ–‡ä»¶ 23/23: web\style.css
============================================================

