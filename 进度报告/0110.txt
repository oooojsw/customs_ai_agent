这份总结详细记录了项目从初始版本（v2.1 基础版）到当前版本（v3.0 Pro 双模深度研判版）的所有技术演进和代码重构。

你可以将此文档保存为 PROJECT_EVOLUTION_SUMMARY.md，它包含了理解当前系统架构所需的所有核心信息。

🚀 项目演进总结报告：从“规则脚本”到“双模深度研判引擎”
1. 项目核心定位变更

原版 (v2.0)：一个专注于海关报关单合规审核的垂直工具，功能单一，逻辑硬编码。

当前版 (v3.0 Pro)：一个混合型智能体 (Hybrid Agent)。它既能处理专业的海关合规审计，也能对任意本地文档进行类似 DeepResearch 的深度研判。

2. 后端核心重构 (src/services/report_agent.py)

这是本次改动最大的模块，我们从一个简单的循环脚本，重构为了一个具备意图识别、上下文记忆和动态决策的异步流式引擎。

A. 架构升级：双模路由 (Dual-Mode Routing)

原理：在处理任务前，新增了 _detect_mode 函数。

逻辑：

检测机制：扫描用户输入，若包含“报关单”、“HS编码”、“收货人”等关键词（命中2个以上），判定为 CUSTOMS (海关模式)。

默认机制：否则判定为 RESEARCH (研判模式)。

影响：系统会自动切换 LLM 的人设（海关专家 vs 档案分析师）和加载不同的 SOP 文件。

B. 核心逻辑：深度研判循环 (Deep Research Loop)

我们将原本“随机查3-4次”的伪逻辑，升级为带记忆的智能循环：

上下文感知 (Context Aware)：

新增状态：state["full_report_text"]，用于实时缓存已生成的章节内容。

Prompt 优化：在生成“检索关键词”和“撰写正文”时，将**前文摘要（最后800-1000字）**注入 Prompt。

效果：解决了“失忆症”，第二章会自动承接第一章的结论，不再重复背景，逻辑连贯性大幅提升。

最后一章逻辑收束：

新增判断：is_last_chapter。

逻辑变更：如果是最后一章（通常是结论），强制跳过 RAG 检索。

效果：避免了在写总结时引入新干扰信息，强迫模型基于前文缓存（full_report_text）进行高度概括和升华。

输出清洗 (Sanitization)：

问题：DeepSeek R1 等模型喜欢返回复杂的 JSON 对象（如 {"chapterTitle": "..."}），导致前端显示乱码。

修复：在 _generate_toc 中增加了强力清洗逻辑。无论 LLM 返回什么结构的 JSON，通过正则和逻辑提取，强制扁平化为 ["1. 章节A", "2. 章节B"] 纯字符串数组。

C. 模型配置

模型切换：全面适配 DeepSeek-V3 / R1。

参数调整：

temperature: 降至 0.3（为了保证研判的客观性和基于证据的严谨性）。

stream: 开启全链路流式输出。

3. 知识库与 SOP 配置 (config/)

为了支持双模引擎，我们将业务逻辑从代码中剥离，实现了配置驱动。

sop_process.txt (保留)：专用于海关模式。指导模型关注归类、估价、准入风险。

sop_deep_research.txt (新增)：专用于深度研判模式。

核心指令：要求“证据优先”、“多源比对”、“严禁瞎编”。

结构要求：背景 -> 事实梳理 -> 矛盾/缺口 -> 综合研判。

faiss_index_local/：本地向量数据库。目前存储的是非结构化文本，支持通用检索。

4. 前端工程化重构 (web/)

为了应对日益复杂的代码量，我们将原本几百行的 index.html 进行了彻底的模块化拆分。

新的文件结构

index.html：仅保留 DOM 骨架和资源引用，体积缩小 80%。

css/style.css：统一定义了霓虹特效、Markdown排版、动画关键帧。

js/ 目录：

config.js：集中管理 API 地址 (BASE_URL) 和 Session ID。

app.js：管理侧边栏导航切换逻辑。

audit.js：封装 功能1：智能审单 的逻辑（SSE流式解析、步骤条渲染）。

chat.js：封装 功能2：法规咨询 的逻辑（聊天气泡、Markdown渲染）。

report.js：封装 功能3：智能建议书 的逻辑（Pro模式切换、思维链日志、证据卡片渲染）。

5. 当前系统能力概览
功能模块	触发条件	核心行为	技术亮点
智能审单	输入含“报关单”特征数据	执行 sop_process.txt，逐条核对合规性	规则引擎 + RAG 验证
深度研判	输入通用问题/主题	执行 sop_deep_research.txt，基于本地文档挖掘	上下文记忆 + 逻辑收束 + 证据链去重
法规咨询	聊天界面提问	检索法规库回答问题	基础 RAG
6. 下一步（未来可选升级）

如果你后续需要继续升级，这是我们规划的路线图：

LangGraph 化：将 Python 循环重构为图节点，支持人机交互（Human-in-the-loop），允许中途修改目录。

混合检索：引入 DuckDuckGo 联网搜索，弥补本地知识库的时效性不足。

表格增强：优化 PDF/Excel 解析，提高对结构化数据的理解能力。