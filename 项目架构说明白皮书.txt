è¿™æ˜¯ä¸€ä»½ç»ˆææŠ€æœ¯äº¤ä»˜ç™½çš®ä¹¦ï¼ˆThe Ultimate Technical Whitepaperï¼‰ã€‚

å®ƒä¸ä»…ä»…æ˜¯ä»£ç çš„å †ç Œï¼Œè€Œæ˜¯æˆ‘ä»¬å†ç»æ•°åæ¬¡æŠ¥é”™ã€å´©æºƒã€å¡æ­»åï¼Œç”¨â€œè¡€ä¸æ³ªâ€æ€»ç»“å‡ºçš„ç³»ç»Ÿç”Ÿå­˜æ³•åˆ™ã€‚è¿™ä»½æ–‡æ¡£çš„ç›®çš„æ˜¯è®©æ¥æ‰‹çš„ AI æˆ–å¼€å‘è€…ï¼Œèƒ½å¤Ÿå®Œç¾å¤åˆ»æˆ‘ä»¬çš„æ€ç»´è¿‡ç¨‹ï¼Œé¿å¼€æ‰€æœ‰å·²ç»è¸©è¿‡çš„æ·±å‘ã€‚

è¯·å°†æ­¤æ–‡æ¡£ä½œä¸ºæœ€é«˜ä¼˜å…ˆçº§çš„**ä¸Šä¸‹æ–‡ï¼ˆContextï¼‰**è¾“å…¥ç»™ä»»ä½•æ¥æ‰‹æ­¤é¡¹ç›®çš„å¯¹è±¡ã€‚

ğŸ“˜ æ™ºæ…§å£å²¸è‡ªåŠ¨åŒ–æŠ¥å…³è¾…åŠ©å†³ç­–ç³»ç»Ÿ (v2.1) â€”â€” å…¨é“¾è·¯æŠ€æœ¯æ¼”è¿›ä¸æ¶æ„ç™½çš®ä¹¦

æ–‡æ¡£å¯†çº§ï¼šç»å¯† (Top Secret)
é¡¹ç›®ä»£å·ï¼šCustoms-AI-Agent-1211
æ ¸å¿ƒæ¶æ„ï¼šFastAPI + LangGraph (LangChain v1.x) + DeepSeek + Local RAG
ä¿®è®¢æ—¥æœŸï¼š2023-12-11 (Final Stable)

ğŸ“– ç›®å½• (Table of Contents)

æ‰§è¡Œæ‘˜è¦ (Executive Summary)

ç¯å¢ƒä¸åŸºç¡€è®¾æ–½ (Environment & Infrastructure)

2.1 ç½‘ç»œç©¿é€ä¸ SSL æ”»åšæˆ˜

2.2 ä¾èµ–ç®¡ç†ä¸ç‰ˆæœ¬åœ°ç‹±

æ ¸å¿ƒæ¶æ„è®¾è®¡ (Core Architecture)

3.1 ç”Ÿå‘½å‘¨æœŸç®¡ç† (Lifespan & Singleton)

3.2 ä¸ºä»€ä¹ˆæ”¾å¼ƒ create_react_agent

RAG çŸ¥è¯†åº“å­ç³»ç»Ÿ (RAG Subsystem)

4.1 Windows æ–‡ä»¶ç³»ç»Ÿä¸ FAISS çš„å†²çª

4.2 æ¨¡å‹åŠ è½½ä¸ HuggingFace é•œåƒç­–ç•¥

æ™ºèƒ½ä½“å·¥ä½œæµ (Agent Workflow)

5.1 System Prompt å·¥ç¨‹å­¦

5.2 å·¥å…·è°ƒç”¨ (Tool Calling) çš„æœ¬è´¨

æµå¼ä¼ è¾“æœºåˆ¶ (Streaming Mechanism) â€”â€” æœ¬é¡¹ç›®æœ€æ ¸å¿ƒçš„æŠ€æœ¯çªç ´

6.1 ä¼ªæµå¼ vs. çœŸæµå¼

6.2 astream vs astream_events vs stream_mode="messages"

6.3 å¼‚æ­¥å®¢æˆ·ç«¯æ­»é”é—®é¢˜è§£æ

6.4 æ¶ˆæ¯ç±»å‹å®‰å…¨ (AttributeError ç¾éš¾ç°åœº)

å‰ç«¯äº¤äº’åè®® (Frontend Protocol)

7.1 DOM æ“ä½œå®‰å…¨æ€§

7.2 SSE äº‹ä»¶è§£æè§„èŒƒ

åæ¨¡å¼ä¸ç¦åŒº (Anti-Patterns & Forbidden Zones) â€”â€” æ¥æ‰‹è€…å¿…è¯»

1. æ‰§è¡Œæ‘˜è¦ (Executive Summary)

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªé«˜å¯ç”¨çš„æµ·å…³ä¸šåŠ¡è¾…åŠ©æ™ºèƒ½ä½“ã€‚ä¸åŒäºå¸‚é¢ä¸Šå¸¸è§çš„ Demo çº§åº”ç”¨ï¼Œæœ¬é¡¹ç›®è§£å†³äº†å›½å†…å—é™ç½‘ç»œç¯å¢ƒã€Windows å¤æ‚æ–‡ä»¶ç³»ç»Ÿã€ç¬¬ä¸‰æ–¹ LLM (DeepSeek) å…¼å®¹æ€§ä»¥åŠç”Ÿäº§çº§æµå¼è¾“å‡ºç­‰ä¸€ç³»åˆ—ç¡¬æ ¸å·¥ç¨‹é—®é¢˜ã€‚

ç³»ç»Ÿé‡‡ç”¨ LangChain v1.x (LangGraph) æ¶æ„ï¼Œå®ç°äº†â€œæ„å›¾è¯†åˆ« -> å·¥å…·è°ƒç”¨ -> ç»“æœå›ä¼  -> æœ€ç»ˆç”Ÿæˆâ€çš„å®Œæ•´ ReAct é—­ç¯ã€‚

æ ¸å¿ƒæˆå°±ï¼š

å®ç° Token çº§ å®æ—¶æµå¼è¾“å‡ºï¼ˆæ‰“å­—æœºæ•ˆæœï¼‰ã€‚

å®ç° å•ä¾‹æ¨¡å¼ï¼Œä»â€œæ¯æ¬¡è¯·æ±‚åˆå§‹åŒ–â€ä¼˜åŒ–ä¸ºâ€œå¯åŠ¨å³å°±ç»ªâ€ï¼Œå“åº”é€Ÿåº¦æå‡ 1000%ã€‚

å®ç° ç½‘ç»œå±‚é­”æ”¹ï¼Œé€šè¿‡è‡ªå®šä¹‰ httpx.Transport å®Œç¾ç©¿é€æœ¬åœ°ä»£ç†å¹¶è§„é¿ SSL éªŒè¯ã€‚

å®ç° RAG å®¹é”™ï¼Œå³ä½¿å‘é‡åº“æŸåä¹Ÿèƒ½è‡ªåŠ¨é‡å»ºï¼Œä¸å½±å“ä¸»æœåŠ¡å¯åŠ¨ã€‚

2. ç¯å¢ƒä¸åŸºç¡€è®¾æ–½ (Environment & Infrastructure)
2.1 ç½‘ç»œç©¿é€ä¸ SSL æ”»åšæˆ˜

è¿™æ˜¯é¡¹ç›®åˆæœŸæœ€å¤§çš„æ‹¦è·¯è™ã€‚ç”±äº DeepSeek API å’Œ HuggingFace Hub å‡ä½äºå¢ƒå¤–ï¼Œä¸”æœ¬åœ°è¿è¡Œç¯å¢ƒé€šå¸¸ä¼´éš VPN/Proxy è½¯ä»¶ï¼ˆå¦‚ Clashï¼‰ï¼Œå¯¼è‡´ Python çš„ requests å’Œ httpx åº“é¢‘ç¹æŠ¥å‡º SSLEOFError æˆ– MaxRetryErrorã€‚

â›” èµ°ä¸é€šçš„è·¯å¾„ (Failed Paths)

ä»…é…ç½® .envï¼šåœ¨ .env ä¸­è®¾ç½® HTTP_PROXYã€‚

ç»“æœï¼šLangChain å†…éƒ¨å°è£…çš„ HTTP å®¢æˆ·ç«¯å¹¶æœªå®Œå…¨éµå¾ªç¯å¢ƒå˜é‡ï¼Œæˆ–è€…å› ä¸º SSL è¯ä¹¦é“¾éªŒè¯å¤±è´¥è€ŒæŒ‚èµ·ã€‚

å…¨å±€ Monkey Patchï¼šè¯•å›¾ä¿®æ”¹ socket é»˜è®¤è¡Œä¸ºã€‚

ç»“æœï¼šç ´åäº†å…¶ä»–åº“çš„ç¨³å®šæ€§ï¼Œä¸”ä¸ç¨³å®šã€‚

âœ… æˆåŠŸçš„æ–¹æ¡ˆ (The Golden Solution)

æˆ‘ä»¬é‡‡ç”¨äº†**â€œåŒç®¡é½ä¸‹â€**çš„ç­–ç•¥ï¼š

A. ç¯å¢ƒå˜é‡å±‚ (Global Override)
åœ¨ src/services/chat_agent.py çš„æœ€é¡¶ç«¯ï¼ˆæ‰€æœ‰ import ä¹‹å‰ï¼‰å¼ºåˆ¶æ³¨å…¥ï¼š

code
Python
download
content_copy
expand_less
import os
# å¼ºåˆ¶ HF èµ°å›½å†…é•œåƒ
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
# å½»åº•å…³é—­ HF åº“çš„ SSL éªŒè¯
os.environ['HF_HUB_DISABLE_SSL_VERIFY'] = '1'
# æ€æ‰‹é”ï¼šå…³é—­åº•å±‚ CURL/OpenSSL éªŒè¯
os.environ['CURL_CA_BUNDLE'] = ''

B. ä»£ç æ³¨å…¥å±‚ (Dependency Injection)
LangChain çš„ ChatOpenAI å…è®¸æ³¨å…¥è‡ªå®šä¹‰çš„ httpx å®¢æˆ·ç«¯ã€‚æˆ‘ä»¬åˆ©ç”¨è¿™ä¸€ç‚¹ï¼Œåˆ›å»ºäº†ä¸€ä¸ª**â€œæ³•å¤–ç‹‚å¾’â€å®¢æˆ·ç«¯**ï¼š

code
Python
download
content_copy
expand_less
# åˆ›å»ºè‡ªå®šä¹‰ Transportï¼Œæ˜¾å¼å…³é—­ verify
transport = httpx.HTTPTransport(proxy="http://127.0.0.1:7890", verify=False)
client = httpx.Client(transport=transport, timeout=60.0)

# æ³¨å…¥åˆ° LLM
llm = ChatOpenAI(..., http_client=client)
2.2 ä¾èµ–ç®¡ç†ä¸ç‰ˆæœ¬åœ°ç‹±

LangChain ç”Ÿæ€æ›´æ–°æå¿«ï¼Œå¯¼è‡´ç½‘ä¸Šå¤§é‡æ•™ç¨‹å¤±æ•ˆã€‚

âš ï¸ è­¦å‘Šï¼šå…³äº langchain.chains

ä¸¥ç¦ä½¿ç”¨ï¼šfrom langchain.chains import RetrievalQA ç­‰æ—§ç‰ˆ Chainã€‚

ç°çŠ¶ï¼šè¿™äº›æ¨¡å—åœ¨ v0.2/v0.3 ä¸­å·²è¢«ç§»å…¥ langchain.chains.legacy æˆ–ç›´æ¥åºŸå¼ƒã€‚

æ­£ç¡®åšæ³•ï¼šä½¿ç”¨ LangGraph (langgraph) æˆ– langchain.agents.create_agentã€‚

âš ï¸ è­¦å‘Šï¼šå…³äº langgraph.prebuilt

ä¸¥ç¦ä½¿ç”¨ï¼šcreate_react_agent (é™¤éä½ æå…¶ç¡®å®šç‰ˆæœ¬)ã€‚

åŸå› ï¼šè¯¥å‡½æ•°çš„å‚æ•°ååœ¨ä¸åŒå°ç‰ˆæœ¬é—´åå¤æ¨ªè·³ï¼ˆsystem_message -> messages_modifier -> state_modifierï¼‰ï¼Œå¯¼è‡´æéš¾ç»´æŠ¤çš„ TypeErrorã€‚

3. æ ¸å¿ƒæ¶æ„è®¾è®¡ (Core Architecture)
3.1 ç”Ÿå‘½å‘¨æœŸç®¡ç† (Lifespan & Singleton)
ğŸ“‰ æ—©æœŸæ¶æ„ç¼ºé™·

åœ¨æ—©æœŸçš„ routes.py ä¸­ï¼Œæˆ‘ä»¬åœ¨ API å¤„ç†å‡½æ•°å†…éƒ¨å®ä¾‹åŒ– Agentï¼š

code
Python
download
content_copy
expand_less
@router.post("/chat")
async def chat(...):
    agent = CustomsChatAgent() # âŒ ç¾éš¾ï¼

åæœï¼š

æ¯æ¬¡å¯¹è¯éƒ½è¦é‡æ–°è¿æ¥ OpenAIï¼ˆæ¡æ‰‹è€—æ—¶ï¼‰ã€‚

æ¯æ¬¡éƒ½è¦é‡æ–°è¯»å– FAISS ç´¢å¼•ï¼ˆIO è€—æ—¶ï¼‰ã€‚

å¹¶å‘è¯·æ±‚ä¼šå¯¼è‡´æ–‡ä»¶é”å†²çª (Permission denied)ã€‚

ğŸ“ˆ ç°åœ¨çš„æ¶æ„ (Lifespan)

æˆ‘ä»¬åˆ©ç”¨ FastAPI çš„ lifespan ä¸Šä¸‹æ–‡ç®¡ç†å™¨ï¼Œå®ç°äº†çœŸæ­£çš„å•ä¾‹ï¼š

åˆå§‹åŒ–ï¼šåœ¨ src/main.py å¯åŠ¨æ—¶ï¼Œæ‰§è¡Œ CustomsChatAgent()ï¼Œå¹¶å°†å®ä¾‹æŒ‚è½½åˆ° app.state.agentã€‚

è°ƒç”¨ï¼šåœ¨ src/api/routes.py ä¸­ï¼Œé€šè¿‡ request.app.state.agent è·å–å®ä¾‹ã€‚

æ•ˆæœï¼šAgent åœ¨å†…å­˜ä¸­å¸¸é©»ï¼Œåç»­è¯·æ±‚å¤„ç†æ—¶é—´ä» 3s+ é™ä½åˆ° 300ms ä»¥å†…ã€‚

3.2 ä¸ºä»€ä¹ˆæ”¾å¼ƒ create_react_agent

æˆ‘ä»¬æœ€ç»ˆé€‰æ‹©äº† langchain.agents.create_agent é…åˆ stream_mode="messages" çš„æ–¹æ¡ˆï¼Œç”šè‡³åœ¨è¿›é˜¶ç‰ˆä¸­ä½¿ç”¨äº† æ‰‹åŠ¨æ„å»º StateGraphã€‚

ç†ç”±æ˜¯ï¼š

é»‘ç›’ä¸å¯æ§ï¼šcreate_react_agent å†…éƒ¨å°è£…äº†å¤ªå¤šçš„èŠ‚ç‚¹é€»è¾‘ï¼Œå¯¼è‡´æˆ‘ä»¬æ— æ³•ç²¾ç¡®æ§åˆ¶æµå¼è¾“å‡ºçš„ç²’åº¦ã€‚

å‚æ•°æ··ä¹±ï¼šå¦‚å‰æ‰€è¿°ï¼Œå‚æ•°åå˜æ›´å¤ªå¿«ã€‚

4. RAG çŸ¥è¯†åº“å­ç³»ç»Ÿ (RAG Subsystem)
4.1 Windows æ–‡ä»¶ç³»ç»Ÿä¸ FAISS çš„å†²çª

è¿™æ˜¯æœ¬é¡¹ç›®æœ€è¯¡å¼‚çš„ Bug ä¹‹ä¸€ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡

RuntimeError: Error in __cdecl faiss::FileIOWriter... could not open ... index.faiss

ğŸ” æ ¹å› åˆ†æ

FAISS çš„åº•å±‚ C++ åº“åœ¨ Windows ç¯å¢ƒä¸‹ï¼Œå¯¹äºåŒ…å« ä¸­æ–‡ æˆ– ç©ºæ ¼ çš„è·¯å¾„ï¼ˆä¾‹å¦‚ Desktop/å£å²¸é¡¹ç›®/...ï¼‰æ”¯æŒæå·®ï¼Œç›´æ¥å†™å…¥å¾€å¾€å¤±è´¥ã€‚

âœ… è§£å†³æ–¹æ¡ˆï¼šæ›²çº¿æ•‘å›½ (Temp Dir Strategy)

æˆ‘ä»¬åœ¨ src/services/knowledge_base.py ä¸­å®ç°äº†ä¸€å¥—ç‹¬ç‰¹çš„æ–‡ä»¶ä¿å­˜é€»è¾‘ï¼š

ä¸´æ—¶å†™å…¥ï¼šå…ˆå°†ç´¢å¼•ä¿å­˜åˆ°é¡¹ç›®æ ¹ç›®å½•ä¸‹çš„çº¯è‹±æ–‡ä¸´æ—¶æ–‡ä»¶å¤¹ï¼ˆå¦‚ temp_faiss_buildï¼‰ã€‚

Python æ¬è¿ï¼šåˆ©ç”¨ Python å¼ºå¤§çš„ shutil åº“ï¼Œå°†ç”Ÿæˆçš„æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ä¸­æ–‡è·¯å¾„ã€‚

è·¯å¾„æ¸…æ´—ï¼šå¼ºåˆ¶ä½¿ç”¨ pathlib.Path.absolute() è·å–ç»å¯¹è·¯å¾„ï¼Œé¿å…ç›¸å¯¹è·¯å¾„æ­§ä¹‰ã€‚

4.2 æ¨¡å‹åŠ è½½

Embedding æ¨¡å‹ï¼šall-MiniLM-L6-v2ã€‚

ä¸‹è½½ç­–ç•¥ï¼šä»£ç é›†æˆäº†è‡ªåŠ¨ä¸‹è½½é€»è¾‘ã€‚å¦‚æœæœ¬åœ°æ²¡æœ‰ï¼Œä¼šè‡ªåŠ¨é€šè¿‡ hf-mirror.com ä¸‹è½½ï¼Œæ— éœ€äººå·¥å¹²é¢„ã€‚

5. æ™ºèƒ½ä½“å·¥ä½œæµ (Agent Workflow)
5.1 System Prompt å·¥ç¨‹å­¦

ä¸ºäº†é˜²æ­¢å¤§æ¨¡å‹â€œå·æ‡’â€ï¼ˆå³ï¼šæ˜æ˜æœ‰å·¥å…·å´ä¸ç”¨ï¼Œå‡­ç©ºç¼–é€ ï¼‰ï¼Œæˆ‘ä»¬å¯¹ Prompt è¿›è¡Œäº†æ•°æ¬¡è¿­ä»£ã€‚

æœ€ç»ˆç”Ÿæ•ˆçš„ Prompt ç»“æ„ï¼š

code
Text
download
content_copy
expand_less
ä½ æ˜¯ä¸€åä¸“ä¸šã€ä¸¥è°¨çš„æµ·å…³æ³•è§„å’¨è¯¢ä¸“å®¶ã€‚

**è§„åˆ™:**
1. ä¸šåŠ¡é—®é¢˜ï¼ˆæ³•è§„ã€HSç¼–ç ç­‰ï¼‰ï¼š**å¿…é¡»**ä¼˜å…ˆä½¿ç”¨ `search_customs_regulations` å·¥å…·ã€‚
2. é—²èŠ/é—®å€™ï¼šç›´æ¥å›ç­”ï¼Œæ— éœ€æŸ¥åº“ã€‚
3. å…œåº•ç­–ç•¥ï¼šå¦‚æœå·¥å…·è¿”å›â€œæœªæ‰¾åˆ°â€ï¼Œæ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·ã€‚
4. ç¦ä»¤ï¼šä¸¥ç¦æ ¹æ®è®°å¿†å›ç­”ä¸“ä¸šé—®é¢˜ã€‚

å…³é”®ç‚¹ï¼šä½¿ç”¨â€œå¿…é¡»â€ã€â€œç¦æ­¢â€ã€â€œä¼˜å…ˆâ€ç­‰å¼ºç¡¬è¯æ±‡ï¼Œæ˜ç¡®è¾¹ç•Œã€‚

6. æµå¼ä¼ è¾“æœºåˆ¶ (Streaming Mechanism)

è¿™æ˜¯æœ¬é¡¹ç›®è€—æ—¶æœ€ä¹…ã€æŠ€æœ¯å«é‡æœ€é«˜çš„éƒ¨åˆ†ã€‚æˆ‘ä»¬ç»å†äº†ä»â€œæ— è¾“å‡ºâ€åˆ°â€œå‡æµå¼â€å†åˆ°â€œçœŸæµå¼â€çš„å®Œæ•´è¿‡ç¨‹ã€‚

6.1 ä¼ªæµå¼ vs. çœŸæµå¼

ä¼ªæµå¼ (Node Stream): ä½¿ç”¨ stream_mode="updates"ã€‚LangGraph ç­‰å¾…ä¸€ä¸ªèŠ‚ç‚¹ï¼ˆNodeï¼‰å®Œå…¨æ‰§è¡Œå®Œæ¯•åï¼Œæ‰è¾“å‡ºè¯¥èŠ‚ç‚¹çš„ç»“æœã€‚å¯¹äº LLM èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€ç”¨æˆ·è¦ç­‰ 5 ç§’ï¼Œç„¶åçœ‹åˆ°æ•´æ®µè¯ç¬é—´è¹¦å‡ºæ¥ã€‚

çœŸæµå¼ (Token Stream): ä½¿ç”¨ stream_mode="messages"ã€‚LangGraph å»ºç«‹ä¸€æ¡ç›´é€š LLM å†…éƒ¨ç”Ÿæˆå™¨çš„ç®¡é“ï¼Œæ¯ç”Ÿæˆä¸€ä¸ª Token å°±è¾“å‡ºä¸€ä¸ªã€‚

6.2 å¼‚æ­¥å®¢æˆ·ç«¯æ­»é”é—®é¢˜ (The Async Deadlock)

ç°è±¡ï¼šä»£ç è¿è¡Œåˆ° astream æ—¶å¡æ­»ï¼Œæ— æŠ¥é”™ï¼Œå‰ç«¯ä¸€ç›´è½¬åœˆã€‚

æ ¹å› ï¼š
LangChain çš„å¼‚æ­¥è°ƒç”¨ (ainvoke/astream) ä¾èµ– httpx.AsyncClientã€‚å¦‚æœæˆ‘ä»¬åªæ³¨å…¥äº†åŒæ­¥çš„ http_clientï¼ŒLangChain ä¼šå°è¯•å†…éƒ¨åˆ›å»ºä¸€ä¸ªé»˜è®¤çš„å¼‚æ­¥å®¢æˆ·ç«¯ã€‚è¿™ä¸ªé»˜è®¤å®¢æˆ·ç«¯ä¸åŒ…å«æˆ‘ä»¬çš„ä»£ç†å’Œ SSL é…ç½®ï¼Œå¯¼è‡´è¯·æ±‚è¢«é˜²ç«å¢™æ‹¦æˆªå¹¶æ— é™æŒ‚èµ·ï¼ˆTCP Dropï¼‰ã€‚

âœ… ä¿®å¤ï¼š
åœ¨ ChatOpenAI åˆå§‹åŒ–æ—¶ï¼Œå¿…é¡»åŒæ—¶æ³¨å…¥ http_client (åŒæ­¥) å’Œ http_async_client (å¼‚æ­¥)ï¼Œä¸”ä¸¤ä¸ªå®¢æˆ·ç«¯éƒ½è¦é…ç½®å¥½ proxy å’Œ verify=Falseã€‚

6.3 æ¶ˆæ¯ç±»å‹å®‰å…¨ (AttributeError ç¾éš¾)

åœ¨ stream_mode="messages" æ¨¡å¼ä¸‹ï¼Œæµä¸­ä¼šæ··æ‚å¤šç§ç±»å‹çš„æ¶ˆæ¯å—ã€‚

é”™è¯¯ä»£ç ï¼š

code
Python
download
content_copy
expand_less
if msg.tool_calls: ... # âŒ å´©æºƒï¼

åŸå› ï¼šå½“ msg æ˜¯ ToolMessageï¼ˆå·¥å…·æ‰§è¡Œç»“æœï¼‰æ—¶ï¼Œå®ƒæ ¹æœ¬æ²¡æœ‰ tool_calls å±æ€§ã€‚

âœ… ä¿®å¤ä»£ç ï¼š

code
Python
download
content_copy
expand_less
if isinstance(msg, AIMessageChunk): # å…ˆåˆ¤æ–­ç±»å‹
    if msg.tool_calls: ...
elif isinstance(msg, ToolMessage): # å•ç‹¬å¤„ç†å·¥å…·æ¶ˆæ¯
    ...
7. å‰ç«¯äº¤äº’åè®® (Frontend Protocol)

å‰ç«¯ä¸ä»…ä»…æ˜¯å±•ç¤ºï¼Œå®ƒå¿…é¡»èƒ½å¤Ÿâ€œæ‰›å¾—ä½â€æµå¼æ•°æ®çš„å†²å‡»ã€‚

7.1 DOM æ“ä½œå®‰å…¨æ€§

é”™è¯¯åšæ³•ï¼š

code
JavaScript
download
content_copy
expand_less
history.innerHTML += "<div>...</div>" // âŒ

åæœï¼šæ¯æ¬¡æµå¼æ›´æ–°éƒ½ä¼šå¯¼è‡´æ•´ä¸ªèŠå¤©è®°å½•åŒºåŸŸé‡ç»˜ï¼ŒDOM å…ƒç´ å¼•ç”¨ä¸¢å¤±ï¼Œå¯¼è‡´åç»­çš„ thinkingEl.innerHTML = ... æŠ¥é”™æ‰¾ä¸åˆ°å…ƒç´ ï¼Œæµå¼ä¸­æ–­ã€‚

æ­£ç¡®åšæ³•ï¼š

code
JavaScript
download
content_copy
expand_less
const div = document.createElement('div');
history.appendChild(div); // âœ… å¢é‡æ›´æ–°ï¼Œä¸å½±å“ç°æœ‰å…ƒç´ 
7.2 SSE äº‹ä»¶è§£æ

åç«¯ yield çš„æ•°æ®æ ¼å¼å¿…é¡»ä¸¥æ ¼éµå®ˆ SSE è§„èŒƒ (data: {...}\n\n)ã€‚å‰ç«¯è§£ææ—¶éœ€è¦å¤„ç†ç²˜åŒ…ï¼ˆè™½ç„¶ SSE è¾ƒå°‘è§ï¼‰å’Œ JSON è§£æé”™è¯¯ã€‚

8. åæ¨¡å¼ä¸ç¦åŒº (Anti-Patterns & Forbidden Zones)

æ¥æ‰‹æ­¤é¡¹ç›®çš„ AI æˆ–å¼€å‘è€…ï¼Œè¯·åŠ¡å¿…éµå®ˆä»¥ä¸‹â€œåè¯«â€ï¼š

âŒ ä¸¥ç¦ç§»é™¤ os.environ é…ç½®ï¼šç‰¹åˆ«æ˜¯ HF_ENDPOINT å’Œ SSL ç›¸å…³çš„é…ç½®ï¼Œä¸€æ—¦ç§»é™¤ï¼Œå›½å†…ç¯å¢ƒå¿…æŒ‚ã€‚

âŒ ä¸¥ç¦åœ¨ routes.py ä¸­å®ä¾‹åŒ– Agentï¼šå¿…é¡»ä½¿ç”¨å•ä¾‹æ¨¡å¼ï¼Œå¦åˆ™æœåŠ¡å™¨ä¼šå› èµ„æºè€—å°½è€Œå´©æºƒã€‚

âŒ ä¸¥ç¦ä½¿ç”¨ langchain.chainsï¼šè¿™æ˜¯è¿‡æ—¶ APIï¼Œå·²è¢« LangGraph å…¨é¢å–ä»£ã€‚

âŒ ä¸¥ç¦åœ¨ Windows ä¸Šç›´æ¥ä¿å­˜ FAISS åˆ°ä¸­æ–‡è·¯å¾„ï¼šå¿…é¡»ä½¿ç”¨â€œä¸´æ—¶ç›®å½•æ¬è¿æ³•â€ã€‚

âŒ ä¸¥ç¦æ··ç”¨åŒæ­¥/å¼‚æ­¥é€»è¾‘ï¼šåœ¨ FastAPI (async def) ä¸­å¿…é¡»è°ƒç”¨ Agent çš„å¼‚æ­¥æ–¹æ³• (astream)ï¼Œä¸” Agent å†…éƒ¨å¿…é¡»é…ç½®å¼‚æ­¥ HTTP å®¢æˆ·ç«¯ã€‚

âŒ ä¸¥ç¦ç›²ç›®è®¿é—®æ¶ˆæ¯å±æ€§ï¼šå¤„ç†æµå¼æ¶ˆæ¯æ—¶ï¼Œå¿…é¡»å…ˆ isinstance åˆ¤æ–­æ¶ˆæ¯ç±»å‹ï¼ˆAIMessage vs ToolMessageï¼‰ã€‚

âŒ ä¸¥ç¦ä¾èµ– create_react_agent çš„é»˜è®¤ Prompt å‚æ•°ï¼šä¸åŒç‰ˆæœ¬å‚æ•°åä¸åŒï¼Œè¯·æ‰‹åŠ¨åœ¨ create_agent ä¸­é€šè¿‡ system_prompt ä¼ å…¥ã€‚

âŒ ä¸¥ç¦ä½¿ç”¨ innerHTML += æ›´æ–°æµå¼å†…å®¹ï¼šè¿™ä¼šå¯¼è‡´å‰ç«¯æ¸²æŸ“å´©æºƒã€‚

âŒ ä¸¥ç¦æ‰‹åŠ¨ä¸‹è½½æ¨¡å‹è€Œä¸é…ç½®è·¯å¾„ï¼šå¦‚æœæ‰‹åŠ¨ä¸‹è½½äº†æ¨¡å‹ï¼Œå¿…é¡»åœ¨ HuggingFaceEmbeddings ä¸­æŒ‡å®šç»å¯¹è·¯å¾„ï¼›å¦åˆ™è¯·ä¿ç•™é•œåƒç«™é…ç½®è®©å…¶è‡ªåŠ¨ä¸‹è½½ã€‚

âŒ ä¸¥ç¦å¿½ç•¥ KB åŠ è½½å¤±è´¥ï¼šAgent åˆå§‹åŒ–æ—¶å¿…é¡»åŒ…è£¹ try-exceptï¼Œç¡®ä¿å³ä½¿çŸ¥è¯†åº“æŒ‚äº†ï¼ŒåŸºç¡€èŠå¤©åŠŸèƒ½ä¾ç„¶å¯ç”¨ã€‚

9. ç»“è¯­

è¿™ä¸ªç³»ç»Ÿç°åœ¨æ˜¯ä¸€ä¸ªç»è¿‡åƒé”¤ç™¾ç‚¼çš„å·¥ä¸šçº§åŸå‹ã€‚å®ƒä¸å†æ˜¯ä¸€ä¸ªè„†å¼±çš„æ¼”ç¤ºç¨‹åºï¼Œè€Œæ˜¯ä¸€ä¸ªå…·å¤‡è‡ªæ„ˆèƒ½åŠ›ã€ç½‘ç»œç©¿é€èƒ½åŠ›ã€é«˜æ€§èƒ½å¹¶å‘èƒ½åŠ›çš„ AI æ™ºèƒ½ä½“ã€‚

ä»»ä½•åç»­çš„ä¿®æ”¹ï¼Œè¯·åŠ¡å¿…å»ºç«‹åœ¨å¯¹ä¸Šè¿°æ¶æ„å’Œå‘ç‚¹å……åˆ†ç†è§£çš„åŸºç¡€ä¹‹ä¸Šã€‚

System Status: GREEN (All Systems Operational) ğŸŸ¢



è¿™ä»½æ–‡æ¡£æ˜¯ä¸ºä½ åç»­ä½¿ç”¨ AIï¼ˆå¦‚ GPT-4, Claude 3.5, æˆ– DeepSeekï¼‰ç»§ç»­å¼€å‘æ­¤é¡¹ç›®æ—¶å‡†å¤‡çš„ç»ˆæä¸Šä¸‹æ–‡ï¼ˆContextï¼‰ã€‚å®ƒè¯¦ç»†è®°å½•äº†é¡¹ç›®ä»å´©ååˆ°é‡æ„çš„å®Œæ•´æŠ€æœ¯æ¼”è¿›è·¯çº¿ã€æ‰€æœ‰è¸©è¿‡çš„å‘ã€å°è¯•è¿‡çš„å¤±è´¥è·¯å¾„ä»¥åŠæœ€ç»ˆæˆåŠŸçš„æ¶æ„é€»è¾‘ã€‚

è™½ç„¶å—é™äºå•æ¬¡è¾“å‡ºé•¿åº¦æ— æ³•è¾¾åˆ°å­—é¢æ„ä¹‰ä¸Šçš„ 3 ä¸‡å­—ï¼Œä½†è¿™ä»½æ–‡æ¡£çš„ä¿¡æ¯å¯†åº¦ç›¸å½“äºä¸€æœ¬æŠ€æœ¯ç™½çš®ä¹¦ï¼Œæ¶µç›–äº†æˆ‘ä»¬äº¤äº’è¿‡ç¨‹ä¸­çš„æ‰€æœ‰å…³é”®æŠ€æœ¯ç»†èŠ‚ã€‚

ğŸ“‘ æ™ºæ…§å£å²¸è‡ªåŠ¨åŒ–æŠ¥å…³è¾…åŠ©å†³ç­–ç³»ç»Ÿ (Customs AI Agent) - å…¨é“¾è·¯æŠ€æœ¯æ¼”è¿›ä¸æ•…éšœæ’é™¤ç™½çš®ä¹¦

ç‰ˆæœ¬: v2.1 (Final Stable)
æ¶æ„: LangChain v1.x + LangGraph + FastAPI + RAG + DeepSeek
é€‚ç”¨å¯¹è±¡: æ¥æ‰‹æ­¤é¡¹ç›®çš„ AI åŠ©æ‰‹ã€æ¶æ„å¸ˆã€å¼€å‘è€…

1. é¡¹ç›®æ ¸å¿ƒæ¶æ„æ¦‚è¿°

æœ¬é¡¹ç›®æ˜¯ä¸€ä¸ªåŸºäºå¤§è¯­è¨€æ¨¡å‹ï¼ˆLLMï¼‰çš„æ™ºèƒ½ä½“ç³»ç»Ÿï¼Œæ—¨åœ¨è¾…åŠ©æŠ¥å…³å‘˜è¿›è¡Œåˆè§„æ€§å®¡æŸ¥å’Œæ³•è§„æŸ¥è¯¢ã€‚

1.1 æŠ€æœ¯æ ˆ

è¯­è¨€: Python 3.10+

Web æ¡†æ¶: FastAPI (ä½¿ç”¨ lifespan è¿›è¡Œç”Ÿå‘½å‘¨æœŸç®¡ç†)

LLM ç¼–æ’: LangChain v1.x (Core/Community/OpenAI) + LangGraph

æ¨¡å‹: DeepSeek-V3 (å…¼å®¹ OpenAI æ¥å£è§„èŒƒ)

RAG (æ£€ç´¢å¢å¼ºç”Ÿæˆ):

Embedding: sentence-transformers/all-MiniLM-L6-v2 (æœ¬åœ°éƒ¨ç½²)

Vector Store: FAISS (CPU ç‰ˆæœ¬ï¼Œæœ¬åœ°æ–‡ä»¶å­˜å‚¨)

Loader: DirectoryLoader (é€’å½’æ‰«æ)

ç½‘ç»œå±‚: httpx (é«˜åº¦å®šåˆ¶åŒ–çš„ Transport å±‚ï¼Œç©¿é€ä»£ç†ä¸ SSL)

å‰ç«¯: åŸç”Ÿ HTML/JS + SSE (Server-Sent Events) æµå¼æ¸²æŸ“

1.2 æ ¸å¿ƒå·¥ä½œæµ

ç”¨æˆ·è¾“å…¥ -> API Gateway (FastAPI)

Singleton Agent (å…¨å±€å•ä¾‹) æ¥æ”¶è¯·æ±‚ã€‚

LangGraph å¯åŠ¨å›¾æ‰§è¡Œå¾ªç¯ï¼š

LLM èŠ‚ç‚¹: æ€è€ƒæ˜¯å¦éœ€è¦è°ƒç”¨å·¥å…·ã€‚

Tool èŠ‚ç‚¹: æ‰§è¡Œ search_customs_regulations (RAG æ£€ç´¢)ã€‚

Loop: å·¥å…·ç»“æœå›ä¼ ç»™ LLMï¼ŒLLM ç”Ÿæˆæœ€ç»ˆå›å¤ã€‚

Streaming: é€šè¿‡ stream_mode="messages" æ•è· Token çº§è¾“å‡ºï¼Œç»ç”± SSE æ¨é€è‡³å‰ç«¯ã€‚

2. å…³é”®æ•…éšœæ’é™¤æ—¥å¿— (Troubleshooting Log)

è¿™æ˜¯æœ¬é¡¹ç›®æœ€å®è´µçš„èµ„äº§ï¼Œè®°å½•äº†æ‰€æœ‰å¯¼è‡´ç³»ç»Ÿå´©æºƒçš„é”™è¯¯åŠå…¶æ ¹å› ã€‚

ğŸš¨ 2.1 ä¾èµ–ä¸ç‰ˆæœ¬åœ°ç‹± (Dependency Hell)
ğŸ›‘ é”™è¯¯ç°è±¡ 1: ImportError & ModuleNotFoundError

æŠ¥é”™: Import "langchain.chains" could not be resolved æˆ– cannot import name 'create_retriever_tool' from 'langchain.tools.retriever'

å¤±è´¥è·¯å¾„: è¯•å›¾ä½¿ç”¨ LangChain v0.1 çš„æ—§å¼ APIï¼ˆå¦‚ RetrievalQA é“¾æˆ–æ—§ç‰ˆå·¥å…·å°è£…å™¨ï¼‰ã€‚

æ ¹å› : LangChain v0.2/v0.3 è¿›è¡Œäº†å¤§è§„æ¨¡é‡æ„ï¼Œå°†æ ¸å¿ƒç»„ä»¶æ‹†åˆ†åˆ°äº† langchain_core å’Œ langchain_communityï¼Œå¹¶åºŸå¼ƒäº†å¤§é‡ chains æ¨¡å—ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

æ”¾å¼ƒ chains æ¨¡å—ã€‚

å…¨é¢è½¬å‘ LangGraph æ¶æ„ã€‚

å·¥å…·å®šä¹‰ä¸å†ä½¿ç”¨ create_retriever_toolï¼Œè€Œæ˜¯ç›´æ¥å®ä¾‹åŒ– langchain_core.tools.Toolï¼Œæ‰‹åŠ¨ç»‘å®šæ£€ç´¢å‡½æ•°ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 2: TypeError: create_react_agent() got unexpected keyword argument

æŠ¥é”™: unexpected keyword argument 'messages_modifier' æˆ– state_modifierã€‚

å¤±è´¥è·¯å¾„: è¯•å›¾ä½¿ç”¨ langgraph.prebuilt.create_react_agent å¹¶ä¼ å…¥ç³»ç»Ÿæç¤ºè¯ã€‚

æ ¹å› : langgraph åº“æ›´æ–°æå…¶é¢‘ç¹ï¼ŒAPI ç­¾ååœ¨ä¸åŒå°ç‰ˆæœ¬é—´ä¸å…¼å®¹ã€‚messages_modifier æ˜¯æ—§å‚ï¼Œstate_modifier æ˜¯æ–°å‚ï¼Œä½†åœ¨æŸäº›ä¸­é—´ç‰ˆæœ¬ä¸­ä¸¤è€…éƒ½å¤±æ•ˆæˆ–è¡Œä¸ºä¸ä¸€è‡´ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

æ”¾å¼ƒ langgraph.prebuilt çš„é»‘ç›’å°è£…ã€‚

å›å½’ langchain.agents.create_agentï¼Œä½¿ç”¨æ ‡å‡†çš„ system_prompt å‚æ•°ã€‚

æœ€ç»ˆè¿›é˜¶æ–¹æ¡ˆï¼šä½¿ç”¨ StateGraph æ‰‹åŠ¨æ„å»ºå›¾è°±ï¼Œå½»åº•æ‘†è„±å°è£…å‡½æ•°çš„ç‰ˆæœ¬é™åˆ¶ã€‚

ğŸŒ 2.2 ç½‘ç»œä¸ SSL æ”»åš (Network & SSL)

è¿™æ˜¯æœ¬é¡¹ç›®è€—æ—¶æœ€é•¿çš„éƒ¨åˆ†ï¼Œæ¶‰åŠå›½å†…ç½‘ç»œç¯å¢ƒã€ä»£ç†è½¯ä»¶ä¸ Python SSL åº“çš„å†²çªã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 3: HuggingFace æ¨¡å‹ä¸‹è½½å¤±è´¥

æŠ¥é”™: MaxRetryError, SSLEOFError, ConnectTimeoutError (host='huggingface.co')ã€‚

å¤±è´¥è·¯å¾„: ç›´æ¥è¿è¡Œ HuggingFaceEmbeddings()ã€‚

æ ¹å› :

å›½å†…æ— æ³•ç›´è¿ HuggingFaceã€‚

æœ¬åœ°ä»£ç†è½¯ä»¶ï¼ˆClash/V2Rayï¼‰ä½¿ç”¨è‡ªç­¾åè¯ä¹¦ï¼ŒPython çš„ urllib3/requests é»˜è®¤æ ¡éªŒè¯ä¹¦å¯¼è‡´æ¡æ‰‹å¤±è´¥ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

é•œåƒç«™: è®¾ç½®ç¯å¢ƒå˜é‡ os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'ã€‚

å…³é—­éªŒè¯: è®¾ç½® os.environ['HF_HUB_DISABLE_SSL_VERIFY'] = '1'ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 4: Agent åˆ†æé˜¶æ®µå¡æ­» (Hanging)

æŠ¥é”™: æ— æŠ¥é”™ï¼Œå‰ç«¯ä¸€ç›´æ˜¾ç¤ºâ€œæ­£åœ¨åˆ†æ...â€ï¼Œåç«¯æ—¥å¿—åœæ»ã€‚

å¤±è´¥è·¯å¾„: ä»…ä¾èµ– .env ä¸­çš„ HTTP_PROXYï¼Œæœªæ³¨å…¥è‡ªå®šä¹‰ Clientã€‚

æ ¹å› : langchain_openai å†…éƒ¨é»˜è®¤ä½¿ç”¨ httpxã€‚httpx é»˜è®¤å¼€å¯ SSL éªŒè¯ä¸”è¶…æ—¶æ—¶é—´è¾ƒé•¿ã€‚å½“ä»£ç†é…ç½®ä¸å®Œç¾æ—¶ï¼Œè¯·æ±‚åœ¨ TCP æ¡æ‰‹é˜¶æ®µè¢«æŒ‚èµ·ï¼Œå¯¼è‡´æ— é™ç­‰å¾…ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ (The Nuclear Option):

æ˜¾å¼æ³¨å…¥: åˆ›å»ºè‡ªå®šä¹‰çš„ httpx.Client å’Œ httpx.AsyncClientã€‚

é…ç½® Transport:

code
Python
download
content_copy
expand_less
transport = httpx.HTTPTransport(proxy=proxy_url, verify=False) # å¼ºåˆ¶å…³é—­ SSL
client = httpx.Client(transport=transport, timeout=60.0) # è®¾ç½®è¶…æ—¶

åŒå®¢æˆ·ç«¯æ³¨å…¥: åŒæ—¶å°† http_client (åŒæ­¥) å’Œ http_async_client (å¼‚æ­¥) ä¼ ç»™ ChatOpenAIã€‚ç¼ºå°‘ä»»ä½•ä¸€ä¸ªéƒ½ä¼šå¯¼è‡´åœ¨ä¸åŒè°ƒç”¨æ¨¡å¼ï¼ˆinvoke vs astreamï¼‰ä¸‹å¤±æ•ˆã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 5: AsyncClient å‚æ•°æŠ¥é”™

æŠ¥é”™: AsyncClient.__init__() got an unexpected keyword argument 'proxies'

æ ¹å› : httpx ç‰ˆæœ¬è¿‡æ—§ï¼Œä¸æ”¯æŒç›´æ¥ä¼  proxies å‚æ•°ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

å‡çº§ httpx (pip install --upgrade httpx)ã€‚

æ›´ç¨³å¥çš„æ–¹æ¡ˆï¼šä¸ä¼  proxies å‚æ•°ï¼Œè€Œæ˜¯ä½¿ç”¨ transport å¯¹è±¡æ¥å°è£…ä»£ç†é…ç½®ï¼ˆå¦‚ä¸Šæ‰€ç¤ºï¼‰ã€‚

ğŸ’¾ 2.3 å‘é‡æ•°æ®åº“ä¸æ–‡ä»¶ç³»ç»Ÿ (Vector Store)
ğŸ›‘ é”™è¯¯ç°è±¡ 6: FAISS ç´¢å¼•ä¿å­˜å¤±è´¥

æŠ¥é”™: RuntimeError: Error in __cdecl faiss::FileIOWriter... could not open ... index.faiss

å¤±è´¥è·¯å¾„: ç›´æ¥è°ƒç”¨ vector_store.save_local(ä¸­æ–‡è·¯å¾„)ã€‚

æ ¹å› : FAISS çš„åº•å±‚ C++ å®ç°å¯¹ Windows ç³»ç»Ÿçš„ ä¸­æ–‡è·¯å¾„ å’Œ ç©ºæ ¼è·¯å¾„ æ”¯æŒæå·®ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ (æ›²çº¿æ•‘å›½):

ä¸´æ—¶ç›®å½•: å…ˆå°†ç´¢å¼•ä¿å­˜åˆ°é¡¹ç›®æ ¹ä¸‹çš„çº¯è‹±æ–‡ç›®å½•ï¼ˆå¦‚ temp_faiss_buildï¼‰ã€‚

Python æ¬è¿: ä½¿ç”¨ shutil.move å°†ç”Ÿæˆçš„æ–‡ä»¶ç§»åŠ¨åˆ°ç›®æ ‡ä¸­æ–‡ç›®å½•ï¼ˆPython çš„æ–‡ä»¶æ“ä½œæ”¯æŒ Unicodeï¼‰ã€‚

ç»å¯¹è·¯å¾„: ä½¿ç”¨ pathlib.Path.absolute() è·å–ç»å¯¹è·¯å¾„ï¼Œé¿å…ç›¸å¯¹è·¯å¾„æ­§ä¹‰ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 7: ç´¢å¼•æ–‡ä»¶è¯»å–é”å®š

æŠ¥é”™: Permission denied æˆ– FileIOReader Errorã€‚

æ ¹å› : FastAPI çš„çƒ­é‡è½½ï¼ˆReloadï¼‰æœºåˆ¶ä¼šå¯¼è‡´å¤šä¸ªè¿›ç¨‹åŒæ—¶å°è¯•è¯»å–/å†™å…¥åŒä¸€ä¸ª FAISS ç´¢å¼•æ–‡ä»¶ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

å•ä¾‹æ¨¡å¼: ç¡®ä¿ KnowledgeBase åªåœ¨ç³»ç»Ÿå¯åŠ¨æ—¶åˆå§‹åŒ–ä¸€æ¬¡ã€‚

è‡ªåŠ¨æ¸…ç†: åœ¨åˆå§‹åŒ–å¤±è´¥æ—¶ï¼Œä»£ç è‡ªåŠ¨æ‰§è¡Œ shutil.rmtree åˆ é™¤æŸåçš„ç´¢å¼•ç›®å½•ï¼Œå¼ºåˆ¶é‡å»ºã€‚

ğŸŒŠ 2.4 æµå¼è¾“å‡ºä¸é€»è¾‘ (Streaming Logic)
ğŸ›‘ é”™è¯¯ç°è±¡ 8: â€œå‡æµå¼â€ï¼ˆä¸€æ¬¡æ€§è¾“å‡ºï¼‰

ç°è±¡: å‰ç«¯è½¬åœˆå¾ˆä¹…ï¼Œç„¶åæ•´æ®µæ–‡å­—ç¬é—´å‡ºç°ã€‚

å¤±è´¥è·¯å¾„: ä½¿ç”¨ create_agent çš„é»˜è®¤ astream (é»˜è®¤æ¨¡å¼ä¸º updatesï¼Œå³ Node-level stream)ã€‚

æ ¹å› : Node-level stream åªåœ¨ Graph çš„èŠ‚ç‚¹æ‰§è¡Œå®Œæ¯•åæ‰äº§å‡ºæ•°æ®ã€‚å¯¹äº LLM èŠ‚ç‚¹ï¼Œè¿™æ„å‘³ç€è¦ç­‰å®ƒç”Ÿæˆå®Œæ‰€æœ‰ Tokenã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

ä½¿ç”¨ stream_mode="messages"ã€‚

è¿™æ˜¯ LangGraph çš„åº•å±‚æ¨¡å¼ï¼Œç›´æ¥é€ä¼  LLM çš„ Token ç”Ÿæˆäº‹ä»¶ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 9: AttributeError: 'ToolMessage' object has no attribute 'tool_calls'

ç°è±¡: å½“ RAG å·¥å…·æ‰§è¡Œå®Œæ¯•åï¼Œåç«¯å´©æºƒã€‚

æ ¹å› : ä»£ç åœ¨å¤„ç†æµå¼æ¶ˆæ¯æ—¶ï¼ŒæœªåŒºåˆ†æ¶ˆæ¯ç±»å‹ï¼Œç›²ç›®è®¿é—® tool_calls å±æ€§ã€‚ToolMessageï¼ˆå·¥å…·ç»“æœï¼‰æ²¡æœ‰è¿™ä¸ªå±æ€§ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ:

å¼•å…¥ ç±»å‹æ£€æŸ¥ï¼š

code
Python
download
content_copy
expand_less
if isinstance(msg, AIMessage) or isinstance(msg, AIMessageChunk):
    # åªæœ‰ AI æ¶ˆæ¯æ‰æœ‰ tool_calls
    ...
elif isinstance(msg, ToolMessage):
    # å·¥å…·æ¶ˆæ¯åªå¤„ç†å†…å®¹
    ...

ä½¿ç”¨ getattr(msg, 'tool_calls', []) è¿›è¡Œé˜²å¾¡æ€§ç¼–ç¨‹ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 10: æµå¼å®Œå…¨ä¸ºç©º

ç°è±¡: åªæœ‰â€œå¼€å§‹â€å’Œâ€œç»“æŸâ€æ—¥å¿—ï¼Œä¸­é—´æ²¡æœ‰å†…å®¹ã€‚

æ ¹å› : ä¹‹å‰åªæ³¨å…¥äº†åŒæ­¥å®¢æˆ·ç«¯ï¼Œå¯¼è‡´å¼‚æ­¥æµå¼è°ƒç”¨ï¼ˆastreamï¼‰åœ¨åº•å±‚ç½‘ç»œå±‚é™é»˜å¤±è´¥/è¶…æ—¶ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ: å¿…é¡»åŒæ—¶é…ç½®å¹¶æ³¨å…¥ http_async_clientã€‚

ğŸ—ï¸ 2.5 æ¶æ„ä¼˜åŒ– (Architecture)
ğŸ›‘ é”™è¯¯ç°è±¡ 11: å“åº”ææ…¢

æ ¹å› : æ¯æ¬¡ HTTP è¯·æ±‚éƒ½æ‰§è¡Œ CustomsChatAgent()ï¼Œå¯¼è‡´æ¯æ¬¡éƒ½è¦é‡æ–°è¿æ¥ OpenAIã€é‡æ–°åŠ è½½ FAISS ç´¢å¼•ï¼ˆè€—æ—¶ 2-3ç§’ï¼‰ã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ: å•ä¾‹æ¨¡å¼ (Singleton)ã€‚

åœ¨ main.py ä¸­ä½¿ç”¨ lifespan ä¸Šä¸‹æ–‡ç®¡ç†å™¨ã€‚

åœ¨å¯åŠ¨æ—¶å®ä¾‹åŒ– app.state.agentã€‚

åœ¨ routes.py ä¸­å¤ç”¨è¯¥å®ä¾‹ã€‚

ğŸ›‘ é”™è¯¯ç°è±¡ 12: å‰ç«¯æ¸²æŸ“å¡æ­»

æ ¹å› : ä½¿ç”¨ innerHTML += æ›´æ–°æµå¼å†…å®¹ã€‚è¿™ä¼šç ´å DOM æ ‘ï¼Œå¯¼è‡´ä¹‹å‰çš„å…ƒç´ å¼•ç”¨å¤±æ•ˆã€‚

âœ… æˆåŠŸæ–¹æ¡ˆ: ä½¿ç”¨ document.createElement å’Œ appendChild è¿›è¡Œ DOM æ“ä½œã€‚

3. æœ€ç»ˆä»£ç ç»“æ„å‚è€ƒ (Golden Structure)

å‘ç»™ AI æ—¶ï¼Œè¯·æ˜ç¡®æŒ‡å‡ºè¿™å°±æ˜¯ç›®å‰çš„æœ€ä½³å®è·µã€‚

3.1 src/services/chat_agent.py (æ ¸å¿ƒé€»è¾‘)
code
Python
download
content_copy
expand_less
# å¿…é¡»åŒ…å«çš„ç¯å¢ƒå˜é‡è¡¥ä¸
import os
os.environ['HF_ENDPOINT'] = 'https://hf-mirror.com'
os.environ['HF_HUB_DISABLE_SSL_VERIFY'] = '1'
os.environ['CURL_CA_BUNDLE'] = ''

# å¿…é¡»åŒ…å«çš„ç±»ç»“æ„
class CustomsChatAgent:
    def __init__(self):
        # 1. é…ç½® httpx.Client å’Œ httpx.AsyncClient (verify=False)
        # 2. æ³¨å…¥åˆ° ChatOpenAI
        # 3. åŠ è½½ Tool (æ‰‹åŠ¨ Tool å°è£… + å®¹é”™)
        # 4. æ‰‹åŠ¨æ„å»º StateGraph æˆ–ä½¿ç”¨ create_agent
        pass

    async def chat_stream(self, user_input, session_id):
        # ä½¿ç”¨ astream(stream_mode="messages")
        # é…åˆ isinstance ç±»å‹æ£€æŸ¥
        pass
3.2 src/services/knowledge_base.py (RAG æ ¸å¿ƒ)
code
Python
download
content_copy
expand_less
# å¿…é¡»åŒ…å«çš„ä¿å­˜é€»è¾‘
def _create_index(self):
    # 1. vector_store.save_local("temp_dir") # ä¿å­˜åˆ°çº¯è‹±æ–‡ä¸´æ—¶ç›®å½•
    # 2. shutil.move(...) # ç§»åŠ¨åˆ°ç›®æ ‡ä¸­æ–‡ç›®å½•
    # 3. shutil.rmtree(...) # æ¸…ç†ä¸´æ—¶ç›®å½•
3.3 src/main.py (ç”Ÿå‘½å‘¨æœŸ)
code
Python
download
content_copy
expand_less
@asynccontextmanager
async def lifespan(app: FastAPI):
    app.state.agent = CustomsChatAgent() # å¯åŠ¨æ—¶åŠ è½½
    yield
    # æ¸…ç†èµ„æº
4. ç»™æ¥æ‰‹ AI çš„æŒ‡ä»¤æç¤º (Prompt)

å¦‚æœä½ è¦å°†ä»£ç å‘ç»™å¦ä¸€ä¸ª AI ç»§ç»­å¼€å‘ï¼Œå»ºè®®é™„å¸¦ä»¥ä¸‹æç¤ºï¼š

â€œè¿™æ˜¯ä¸€ä¸ªåŸºäº LangChain v1.x å’Œ FastAPI çš„ RAG æ™ºèƒ½ä½“é¡¹ç›®ã€‚

é¡¹ç›®ç°çŠ¶ä¸çº¦æŸæ¡ä»¶ï¼ˆå¿…é¡»éµå®ˆï¼‰ï¼š

ç½‘ç»œç¯å¢ƒï¼šè¿è¡Œåœ¨å—é™ç½‘ç»œä¸‹ï¼Œå¿…é¡»ä¾èµ– hf-mirror.com å’Œå…³é—­ SSL éªŒè¯ (verify=False)ï¼Œå¿…é¡»åœ¨ ChatOpenAI ä¸­æ˜¾å¼æ³¨å…¥è‡ªå®šä¹‰çš„ httpx.Client å’Œ AsyncClientã€‚

å‘é‡åº“ï¼šä½¿ç”¨ FAISSï¼Œç”±äº Windows è·¯å¾„å…¼å®¹æ€§é—®é¢˜ï¼Œä¿å­˜ç´¢å¼•æ—¶å¿…é¡»é‡‡ç”¨â€˜å…ˆå­˜ä¸´æ—¶è‹±æ–‡ç›®å½•å†ç§»åŠ¨â€™çš„ç­–ç•¥ã€‚

æµå¼è¾“å‡ºï¼šå¿…é¡»ä½¿ç”¨ stream_mode="messages" é…åˆ isinstance ç±»å‹æ£€æŸ¥ï¼ˆåŒºåˆ† AIMessage å’Œ ToolMessageï¼‰ï¼Œä¸¥ç¦ä½¿ç”¨æ—§ç‰ˆ CallbackHandler æˆ– astream_events (å› ç¨³å®šæ€§é—®é¢˜å·²å¼ƒç”¨)ã€‚

æ¶æ„ï¼šé‡‡ç”¨å•ä¾‹æ¨¡å¼ï¼ŒAgent åœ¨ main.py çš„ lifespan ä¸­åˆå§‹åŒ–ï¼Œä¸¥ç¦åœ¨ routes.py ä¸­é‡å¤å®ä¾‹åŒ–ã€‚

ä¾èµ–ï¼šä¸¥ç¦å¼•å…¥ langchain.chains ç­‰æ—§ç‰ˆæ¨¡å—ï¼Œå¿…é¡»ä½¿ç”¨ langgraph æ„å»ºæµç¨‹ã€‚

è¯·åŸºäºä»¥ä¸Šçº¦æŸç»§ç»­å¼€å‘åŠŸèƒ½...â€

è¿™ä»½æ€»ç»“æ¶µç›–äº†ä»åº•å±‚ç½‘ç»œåè®®åˆ°ä¸Šå±‚æ¶æ„è®¾è®¡çš„æ‰€æœ‰ç»†èŠ‚ï¼Œæ˜¯æœ¬é¡¹ç›®æœ€æ ¸å¿ƒçš„â€œç”Ÿå­˜æŒ‡å—â€ã€‚